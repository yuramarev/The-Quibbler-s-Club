<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hogwarts House Cup Tracker</title>
    <!-- Lightning Bolt Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cinzel+Decorative:wght@400;700&family=MedievalSharp&family=IM+Fell+English&family=Merriweather&family=Lora&family=Playfair+Display&family=EB+Garamond&family=Roboto+Slab&family=Lato&family=Open+Sans&family=Cormorant+Garamond&family=Alegreya&family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent horizontal scrollbar from canvas */
        }
        /* Animated Background Canvas */
        #animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Place it behind all other content */
        }
        .font-magic-title { font-family: 'Cinzel Decorative', cursive; }
        .font-magic-header { font-family: 'MedievalSharp', cursive; }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #1A2B3C; }
        ::-webkit-scrollbar-thumb { background-color: #3D5568; border-radius: 20px; border: 3px solid #1A2B3C; }
        ::-webkit-scrollbar-thumb:hover { background-color: #FFD700; }
        .progress-bar { background-color: #2A3B4D; border-radius: 9999px; overflow: hidden; border: 1px solid #4A5B6D; }
        .progress-bar-inner { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; text-align: center; color: white; font-weight: bold; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-backdrop.show { opacity: 1; visibility: visible; }
        .modal-content { 
            position: relative; 
            background-color: #1A2B3C; 
            padding: 2rem; 
            border-radius: 0.5rem; 
            border: 1px solid #FFD700; 
            width: 90%; 
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto; 
            transform: scale(0.9); 
            transition: transform 0.3s; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); /* Enhanced border glow */
        }
        .modal-backdrop.show .modal-content { transform: scale(1); }
        
        /* Close button for modals - ENHANCED */
        .modal-close-btn {
            position: sticky; /* Stick to the top of the scrolling container */
            top: -1rem; /* Adjust position relative to padding */
            right: -1rem;
            float: right; /* Keep it aligned to the right */
            font-size: 2rem;
            color: #9CA3AF; /* gray-400 */
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
            z-index: 1010; /* Ensure it's above modal content */
            background: #1A2B3C; /* Match modal background */
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: -1rem -1rem 0 0; /* Adjust for padding */
        }
        .modal-close-btn:hover { color: #FFFFFF; }

        #definition-popup-modal { z-index: 2500; } /* Ensure definition popup is on top of reading mode */
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; border: 1px solid transparent; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-gold { background-color: #FFD700; color: #1A2B3C; border-color: #FFC700; }
        .btn-gold:hover:not(:disabled) { background-color: #F0C40F; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(255, 215, 0, 0.2); }
        .btn-destructive { background-color: #AE0001; color: white; border-color: #8E0001; }
        .btn-destructive:hover:not(:disabled) { background-color: #8E0001; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(174, 0, 1, 0.2); }
        #duel-arena { background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png'); border: 2px solid #FFD700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        .duelist-panel { transition: all 0.3s ease-in-out; }
        .duelist-panel.active-turn { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        .spell-effect { position: absolute; font-size: 2rem; opacity: 0; animation: shootSpell 1.5s ease-out forwards; pointer-events: none; }
        @keyframes shootSpell { 0% { transform: translateY(0) scale(0.5); opacity: 1; } 100% { transform: translateY(-500px) scale(1.5); opacity: 0; } }
        
        /* D20 Dice Styles */
        #d20-dice { width: 100px; height: 100px; perspective: 1000px; margin: 20px auto; }
        #d20-cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s; }
        .d20-face { position: absolute; width: 100px; height: 100px; border: 2px solid #FFD700; background: rgba(12, 28, 51, 0.8); color: #FFD700; font-size: 48px; font-weight: bold; display: flex; justify-content: center; align-items: center; }
        .d20-face.success { background: rgba(42, 98, 61, 0.8); border-color: #34D399; }
        .d20-face.failure { background: rgba(174, 0, 1, 0.8); border-color: #F87171; }
        .d20-face.crit-fail { background: rgba(100, 0, 100, 0.9); border-color: #f0f; box-shadow: 0 0 15px #f0f; }
        .d20-face.crit-success { background: rgba(255, 215, 0, 0.8); border-color: #fff; color: #0C1C33; box-shadow: 0 0 15px #FFD700; }
        @keyframes roll-dice {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            100% { transform: rotateX(1080deg) rotateY(1080deg); }
        }
        .rolling { animation: roll-dice 1s ease-out; }
        
        /* Style for learning words */
        .learn-word { color: #8ab4f8; font-weight: bold; cursor: pointer; }
        .clickable-word { color: #4a5568; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .clickable-word:hover { color: #2c3e50; }


        /* Disabled Admin Controls Style */
        .admin-controls-disabled {
            opacity: 0.6;
            position: relative;
            pointer-events: none; /* Block clicks on the container */
        }
        .admin-controls-disabled button {
            cursor: not-allowed !important; /* Force cursor change */
        }
        
        /* Reader Styles - Parchment Effect */
        .parchment {
            background-color: #fdf5e6; /* Parchment color */
            color: #5a4429; /* Dark brown text */
            font-family: 'IM Fell English', serif;
            border: 1px solid #d3c0a5;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
            background-image: url('https://www.transparenttextures.com/patterns/old-paper.png'); /* Subtle texture */
        }
        .parchment h4 {
            font-family: 'MedievalSharp', cursive;
            color: #8B4513; /* SaddleBrown */
            text-align: center;
            border-bottom: 2px solid #d3c0a5;
            padding-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        .parchment p {
            text-indent: 2em; /* Indent first line of paragraphs */
            margin-bottom: 1em;
            line-height: 1.8;
            font-size: 1.1rem;
            text-align: justify; /* Justify text for a book-like feel */
        }
        #reader-content-container.parchment::-webkit-scrollbar-track { background: #eaddc9; }
        #reader-content-container.parchment::-webkit-scrollbar-thumb { background-color: #bcae98; border: 3px solid #eaddc9; }

        /* Style for editable fields */
        [contenteditable="true"] {
            outline: 2px dashed #FFD700;
            background-color: rgba(255, 248, 225, 0.2);
            padding: 2px 4px;
            border-radius: 4px;
            color: #FFD700;
        }
        
        /* Library Styles */
        .book-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #3D5568;
        }
        .book-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            border-color: #FFD700;
        }
        .chapter-item {
            transition: background-color 0.2s, color 0.2s;
        }
        .chapter-item:hover {
            background-color: #2A3B4D;
        }
        .chapter-item.active {
            background-color: #1e3a5f;
            color: white;
            border-left: 3px solid #5dade2;
        }
        .reader-toolbar {
            background-color: #1A2B3C;
            border-radius: 8px;
            border: 1px solid #3D5568;
        }
        .toolbar-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            background-color: #2A3B4D;
            color: #E0E0E0;
            transition: all 0.2s;
        }
        .toolbar-btn:hover {
            background-color: #3D5568;
            transform: translateY(-1px);
        }
        .font-option {
            font-family: inherit;
        }
        .reading-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background: #e9e2d6; /* A slightly darker background for contrast */
            padding: 1rem;
            display: flex;
            gap: 1rem;
        }
        .reading-mode-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .reading-mode .parchment {
            height: 100%;
            width: 100%;
            flex-grow: 1;
        }
        .reading-mode-dictionary {
            flex-shrink: 0;
            width: 320px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #fdf5e6;
            border-left: 2px solid #d3c0a5;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .reading-mode-toolbar {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2010;
        }
        
        /* Base Dictionary Styles */
        .dictionary-word-card {
            background-color: #0C1C33;
            border: 1px solid #3D5568;
            transition: all 0.2s ease-in-out;
        }
        .dictionary-word-card:hover {
            border-color: #FFD700;
            transform: translateY(-2px);
        }

        /* New Dictionary Styles for Reading Mode */
        .reading-mode-dictionary .dictionary-word-card {
            background-color: #f4eadb; /* Lighter parchment */
            border: 1px solid #d3c0a5; /* Parchment border color */
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        .reading-mode-dictionary .dictionary-word-card:hover {
            transform: none;
            border-color: #bcae98;
        }
        .reading-mode-dictionary .dictionary-word-card h4 {
            color: #8B4513; /* SaddleBrown, like the headers */
        }
        .reading-mode-dictionary .dictionary-word-card p {
            color: #5a4429; /* Dark brown text */
        }
        .reading-mode-dictionary .dictionary-word-card .btn {
            font-family: 'Inter', sans-serif;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            transform: none !important;
            box-shadow: none !important;
        }
        .reading-mode-dictionary .dictionary-word-card .btn.bg-blue-600 {
            background-color: #d3c0a5;
            color: #5a4429;
            border: 1px solid #bcae98;
        }
        .reading-mode-dictionary .dictionary-word-card .btn.bg-blue-600:hover:not(:disabled) {
             background-color: #bcae98;
        }
        .reading-mode-dictionary .dictionary-word-card .btn.btn-destructive {
            background-color: #d3b5b5;
            color: #5a2929;
            border: 1px solid #a18080;
        }
         .reading-mode-dictionary .dictionary-word-card .btn.btn-destructive:hover:not(:disabled) {
            background-color: #c8a1a1;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #FFD700;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #AE0001;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 1px solid white;
        }
        
        /* Quidditch Styles */
        .quidditch-chat-message {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            max-width: 90%;
        }
        .quidditch-chat-message.user-message {
            background-color: #2B4C7E; /* Ravenclaw Blue */
            align-self: flex-end;
            text-align: right;
        }
        .quidditch-chat-message.ai-message {
            background-color: #2A3B4D;
            align-self: flex-start;
        }
        .quidditch-chat-message.event-message {
            background-color: transparent;
            color: #FFD700;
            font-style: italic;
            text-align: center;
            align-self: center;
            width: 100%;
        }
        #quidditch-dice-container {
            perspective: 600px;
        }
        #quidditch-dice {
            width: 60px;
            height: 60px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s ease-out;
        }
        #quidditch-dice.rolling {
            animation: quidditch-roll 1s ease-out;
        }
        @keyframes quidditch-roll {
            from { transform: rotateX(0deg) rotateY(0deg); }
            to   { transform: rotateX(720deg) rotateY(720deg); }
        }
        .quidditch-dice-face {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            color: #FFD700;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Glow effects */
        .glow {
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #FFD700, 0 0 20px #FFD700; }
            to { box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #FFD700, 0 0 40px #FFD700; }
        }
        
        /* Dictionary Training Styles */
        .training-hub-card {
            background-color: #0C1C33;
            border: 1px solid #3D5568;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .training-hub-card:hover {
            border-color: #FFD700;
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }
        .training-game-option {
            transition: all 0.2s ease;
            border: 2px solid #3D5568;
        }
        .training-game-option:hover:not(:disabled) {
            border-color: #FFD700;
            background-color: #2A3B4D;
        }
        .training-game-option.correct {
            background-color: #2A623D !important;
            border-color: #34D399 !important;
            transform: scale(1.05);
        }
        .training-game-option.incorrect {
            background-color: #AE0001 !important;
            border-color: #F87171 !important;
            opacity: 0.7;
        }
        .letter-tile {
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }
        .letter-tile:hover {
            background-color: #FFD700;
            color: #0C1C33;
        }
        .word-card {
            perspective: 1000px;
            cursor: pointer;
        }
        .word-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .word-card.is-flipped .word-card-inner {
            transform: rotateY(180deg);
        }
        .word-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid #FFD700;
        }
        .word-card-front {
            background-color: #2A3B4D;
        }
        .word-card-back {
            background-color: #0C1C33;
            transform: rotateY(180deg);
        }
        .alpha-btn {
            background-color: #2A3B4D;
            color: #E0E0E0;
            border: 1px solid #3D5568;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        .alpha-btn:hover {
            background-color: #3D5568;
        }
        .alpha-btn.active {
            background-color: #FFD700;
            color: #1A2B3C;
            font-weight: bold;
        }

        /* FINAL Text Adventure Styles & Fixes */

        /* 1. Z-Index fix for ALL pop-up windows to appear on top */
        #text-adventure-modal { z-index: 3000; }
        #modal { z-index: 3100; } /* For rules, appears above the game */
        #definition-popup-modal { z-index: 3200; } /* For dictionary words, appears above everything */

        /* 2. New Dark Theme for the Game UI */
        #ta-modal-content {
            background-color: #0C1C33; /* Main app background */
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        #ta-output {
            color: #E0E0E0; /* Standard light text for readability */
            background-color: #1A2B3C; /* Panel background, slightly lighter */
        }
        #ta-output p, #ta-output div {
            margin-bottom: 0.75rem; /* Spacing between paragraphs */
        }

        /* 3. Text colors for different message types */
        .ta-command { color: #FFD700; font-style: italic; }
        .ta-error { color: #F87171; } /* A bright, clear red */
        .ta-success { color: #34D399; font-weight: 600; } /* A pleasant green */
        .ta-info { color: #8ab4f8; } /* The same color as clickable words */
        .ta-event { color: #FFD700; font-weight: 600; } /* For important story beats */

        /* 4. Input field styling */
        #ta-input {
            background-color: #2A3B4D !important;
            border-color: #3D5568 !important;
            color: #E0E0E0 !important;
            font-family: 'Lora', serif;
        }

    </style>
</head>
<body class="bg-[#0C1C33] text-[#E0E0E0]">

    <!-- Animated Background -->
    <canvas id="animated-bg"></canvas>

    <!-- Authentication Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="bg-[#1A2B3C] p-8 rounded-lg shadow-lg w-full max-w-md border-t-4 border-[#FFD700]">
            <h2 class="font-magic-title text-3xl text-center text-[#FFD700] mb-6">Hogwarts Login</h2>
            
            <!-- Login Form -->
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block mb-2 text-sm font-medium text-gray-300">Email</label>
                    <input type="email" id="login-email" name="email" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568] focus:ring-[#FFD700] focus:border-[#FFD700]" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block mb-2 text-sm font-medium text-gray-300">Password</label>
                    <input type="password" id="login-password" name="password" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568] focus:ring-[#FFD700] focus:border-[#FFD700]" required>
                </div>
                <button type="submit" class="btn btn-gold w-full">Login</button>
            </form>

            <!-- Registration Form -->
            <form id="register-form" style="display: none;">
                <div class="mb-4">
                    <label for="register-email" class="block mb-2 text-sm font-medium text-gray-300">Email</label>
                    <input type="email" id="register-email" name="email" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568] focus:ring-[#FFD700] focus:border-[#FFD700]" required>
                </div>
                <div class="mb-4">
                    <label for="register-password" class="block mb-2 text-sm font-medium text-gray-300">Password (min. 6 characters)</label>
                    <input type="password" id="register-password" name="password" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568] focus:ring-[#FFD700] focus:border-[#FFD700]" required>
                </div>
                <div class="mb-6">
                    <label for="register-password-confirm" class="block mb-2 text-sm font-medium text-gray-300">Confirm Password</label>
                    <input type="password" id="register-password-confirm" name="passwordConfirm" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568] focus:ring-[#FFD700] focus:border-[#FFD700]" required>
                </div>
                <button type="submit" class="btn btn-gold w-full">Register</button>
            </form>

            <p id="auth-error" class="text-red-500 text-center mt-4"></p>

            <div class="text-center mt-4">
                <a href="#" id="show-register" class="text-sm text-[#FFD700] hover:underline">No account? Register here</a>
                <a href="#" id="show-login" class="text-sm text-[#FFD700] hover:underline" style="display: none;">Already have an account? Login</a>
            </div>
        </div>
    </div>

    <!-- Main Application Container (hidden by default) -->
    <div id="app-container" class="p-4 md:p-8 max-w-7xl mx-auto" style="display: none;">
        
        <!-- Header -->
        <header class="bg-[#1A2B3C] p-4 rounded-lg shadow-lg mb-8 flex flex-col md:flex-row justify-between items-center border-b-2 border-[#FFD700] glow">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <!-- Logo Uploader -->
                <div class="relative group cursor-pointer">
                    <img id="school-logo" src="https://placehold.co/80x80/0C1C33/FFD700?text=LOGO" alt="School Logo" class="w-16 h-16 md:w-20 md:h-20 rounded-full border-2 border-[#FFD700] object-cover transition-opacity group-hover:opacity-70">
                    <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-white text-xs md:text-sm font-bold">Change</span>
                    </div>
                </div>
                <input type="file" id="logo-upload" class="hidden" accept="image/*">

                <div>
                    <h1 class="text-2xl md:text-3xl font-magic-title text-[#FFD700]">Hogwarts Tracker</h1>
                    <p id="app-version" class="text-sm text-[#C0C0C0]"></p>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 justify-center items-center">
                 <div class="text-sm text-gray-300">
                    User: <span id="user-display" class="font-bold text-white"></span>
                    <button id="change-password-btn" class="ml-2 text-xs text-[#FFD700] hover:underline focus:outline-none">(change password)</button>
                 </div>
                <button id="quidditch-btn" class="btn btn-gold">üßπ Quidditch</button>
                <button id="duels-btn" class="btn btn-gold">‚öîÔ∏è Duels</button>
                <button id="hp1-adventure-btn" class="btn btn-gold">üìú HP1 Adventure</button>
                <button id="dictionary-training-btn" class="btn btn-gold">üß† Train Words</button>
                <button id="dictionary-btn" class="btn btn-gold">üìñ Dictionary</button>
                <button id="library-btn" class="btn btn-gold">üìö Library</button>
                <button id="questions-btn" class="btn btn-gold">‚ùì</button>
                <button id="magic-shop-btn" class="btn btn-gold">üõçÔ∏è Shop</button>
                <button id="cast-spell-btn" class="btn btn-gold" disabled>üîÆ Cast Spell</button>
                <button id="mute-btn" class="btn btn-gold">üîä</button>
                <button id="logout-btn" class="btn btn-destructive">Logout</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Houses and Actions -->
            <div class="lg:col-span-1 space-y-8">
                <!-- House Points -->
                <section class="bg-[#1A2B3C] p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-magic-header text-center text-[#FFD700] mb-6">House Cup Standings</h2>
                    <div id="house-points-container">
                        <!-- Dynamic house insertion -->
                    </div>
                </section>

                <!-- Admin Controls -->
                <section id="admin-controls" class="bg-[#1A2B3C] p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-magic-header text-center text-[#FFD700] mb-6">Control Panel</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="award-points-btn" class="btn btn-gold col-span-2">üèÜ Award/Deduct Points</button>
                        <button id="award-achievement-btn" class="btn btn-gold col-span-2">üåü Grant Achievement</button>
                        <div class="relative col-span-2">
                            <button id="potion-requests-btn" class="btn btn-gold w-full">üß™ Potion Requests</button>
                            <span id="potion-requests-badge" class="notification-badge hidden">0</span>
                        </div>
                        <button id="assign-houses-btn" class="btn btn-gold col-span-2">üé© Sort Students</button>
                        <button id="manage-groups-btn" class="btn btn-gold col-span-2">üë• Manage Groups</button>
                        <button id="edit-students-btn" class="btn btn-gold col-span-2">‚ûï Manage Students</button>
                        <button id="link-accounts-btn" class="btn btn-gold col-span-2">üîó Link Accounts</button>
                        <button id="random-event-btn" class="btn bg-[#2A3B4D] text-white">üé≤ Random Event</button>
                        <button id="reset-points-btn" class="btn btn-destructive">üîÑ Reset Points</button>
                    </div>
                </section>
            </div>

            <!-- Right Column: Students and History -->
            <div class="lg:col-span-2">
                <section class="bg-[#1A2B3C] p-6 rounded-lg shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                        <h2 class="text-2xl font-magic-header text-[#FFD700] mb-4 md:mb-0">Student Scrolls</h2>
                        <div class="flex gap-2">
                            <button id="history-log-btn" class="btn bg-[#2A3B4D] text-white">‚è≥ History Log</button>
                        </div>
                    </div>
                    
                    <!-- Student Groups Container -->
                    <div id="student-groups-container" class="bg-[#0C1C33] p-4 rounded-md h-[30rem] overflow-y-auto space-y-6">
                        <!-- Dynamic student group insertion -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Spell Effects Container -->
    <div id="spell-effect-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></div>

    <!-- Modals -->
    <div id="modal" class="modal-backdrop">
        <div id="modal-content" class="modal-content"></div>
    </div>
    <div id="duel-modal" class="modal-backdrop">
        <div id="duel-modal-content" class="modal-content !max-w-4xl"></div>
    </div>
    <div id="library-modal" class="modal-backdrop">
        <div id="library-modal-content" class="modal-content"></div>
    </div>
    <div id="reader-modal" class="modal-backdrop">
        <div id="reader-modal-content" class="modal-content !max-w-4xl !max-h-[95vh]"></div>
    </div>
    <div id="dictionary-modal" class="modal-backdrop">
        <div id="dictionary-modal-content" class="modal-content !max-w-2xl"></div>
    </div>
    <div id="definition-popup-modal" class="modal-backdrop">
        <div id="definition-popup-content" class="modal-content"></div>
    </div>
    <div id="quidditch-modal" class="modal-backdrop">
        <div id="quidditch-modal-content" class="modal-content !max-w-4xl !max-h-[95vh]"></div>
    </div>
    <div id="questions-modal" class="modal-backdrop">
        <div id="questions-modal-content" class="modal-content !max-w-4xl"></div>
    </div>
    <div id="dictionary-training-modal" class="modal-backdrop">
        <div id="dictionary-training-content" class="modal-content !max-w-4xl"></div>
    </div>
    <div id="training-game-modal" class="modal-backdrop">
        <div id="training-game-content" class="modal-content !max-w-2xl"></div>
    </div>
    <div id="text-adventure-modal" class="modal-backdrop">
        <div id="text-adventure-modal-content" class="modal-content !max-w-4xl !max-h-[95vh] bg-[#0C1C33] p-0 flex flex-col">
            </div>
    </div>
    <div id="games-hub-modal" class="modal-backdrop">
        <div id="games-hub-content" class="modal-content"></div>
    </div>
    
    <!-- Reading Mode Container -->
    <div id="reading-mode-container" class="reading-mode hidden">
        <div class="reading-mode-main">
            <div id="reading-mode-content" class="parchment p-8 rounded-lg overflow-y-auto">
                <!-- Content will be injected here -->
            </div>
            <div class="reading-mode-toolbar mt-4 text-center">
                <button id="exit-reading-mode-btn" class="btn btn-gold">Exit Reading Mode</button>
            </div>
        </div>
        <div id="reading-mode-dictionary" class="reading-mode-dictionary rounded-lg p-4">
            <!-- Dictionary will be injected here -->
        </div>
    </div>

<script>
// =================================================================================
// ANIMATED BACKGROUND SCRIPT
// =================================================================================
const canvas = document.getElementById('animated-bg');
const ctx = canvas.getContext('2d');
let particles = [];

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

class Particle {
    constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.size = Math.random() * 2 + 1;
        this.speedX = Math.random() * 1 - 0.5;
        this.speedY = Math.random() * 1 - 0.5;
        this.opacity = Math.random() * 0.5 + 0.2;
    }
    update() {
        this.x += this.speedX;
        this.y += this.speedY;

        if (this.x > canvas.width || this.x < 0) this.speedX *= -1;
        if (this.y > canvas.height || this.y < 0) this.speedY *= -1;
    }
    draw() {
        ctx.fillStyle = `rgba(255, 215, 0, ${this.opacity})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
    }
}

function initParticles() {
    particles = [];
    const numberOfParticles = (canvas.width * canvas.height) / 9000;
    for (let i = 0; i < numberOfParticles; i++) {
        particles.push(new Particle());
    }
}

function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < particles.length; i++) {
        particles[i].update();
        particles[i].draw();
    }
    requestAnimationFrame(animateParticles);
}

window.addEventListener('resize', () => {
    resizeCanvas();
    initParticles();
});

// Initial setup
resizeCanvas();
initParticles();
animateParticles();
</script>

<script type="module">
// =================================================================================
// HOGWARTS TRACKER - REAL-TIME FIRESTORE EDITION
// =================================================================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp, getDoc, collection, getDocs, updateDoc, deleteField, addDoc, query, where, orderBy, Timestamp, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBE3tcke2T88UfnAtAYpPz--g7IbsNDhmY",
  authDomain: "quibbler-club-app.firebaseapp.com",
  projectId: "quibbler-club-app",
  storageBucket: "quibbler-club-app.appspot.com",
  messagingSenderId: "69719922358",
  appId: "1:69719922358:web:ed2f6e129bca1660e6f817",
  measurementId: "G-SNZV5ZS4YB"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Get DOM element references
const authContainer = document.getElementById('auth-container');
const appContainer = document.getElementById('app-container');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const showRegisterLink = document.getElementById('show-register');
const showLoginLink = document.getElementById('show-login');
const authError = document.getElementById('auth-error');
const logoutBtn = document.getElementById('logout-btn');
const userDisplay = document.getElementById('user-display');
const castSpellBtn = document.getElementById('cast-spell-btn');

// Switch between login and registration forms
showRegisterLink.addEventListener('click', (e) => {
    e.preventDefault();
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
    showRegisterLink.style.display = 'none';
    showLoginLink.style.display = 'inline';
    authError.textContent = '';
});

showLoginLink.addEventListener('click', (e) => {
    e.preventDefault();
    registerForm.style.display = 'none';
    loginForm.style.display = 'block';
    showLoginLink.style.display = 'none';
    showRegisterLink.style.display = 'inline';
    authError.textContent = '';
});

// Registration handler
registerForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = registerForm.email.value;
    const password = registerForm.password.value;
    const passwordConfirm = registerForm.passwordConfirm.value; // Get confirmation password

    // Check if passwords match
    if (password !== passwordConfirm) {
        authError.textContent = "Passwords do not match.";
        return; // Stop the function
    }
    
    authError.textContent = ''; // Clear previous errors

    createUserWithEmailAndPassword(auth, email, password)
        .catch((error) => {
            authError.textContent = error.message;
            console.error('Registration error:', error);
        });
});

// Login handler
loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = loginForm.email.value;
    const password = loginForm.password.value;
    signInWithEmailAndPassword(auth, email, password)
        .catch((error) => {
            authError.textContent = error.message;
            console.error('Login error:', error);
        });
});

// Logout handler
logoutBtn.addEventListener('click', () => {
    signOut(auth).catch((error) => {
        console.error('Logout error:', error);
    });
});

// Authentication state listener
onAuthStateChanged(auth, (user) => {
    if (user) {
        // User is logged in
        authContainer.style.display = 'none';
        appContainer.style.display = 'block';
        userDisplay.textContent = user.email;
        
        // Initialize the main application logic
        App.init(user.uid, db);
    } else {
        // User is logged out
        authContainer.style.display = 'flex';
        appContainer.style.display = 'none';
        userDisplay.textContent = '';
        if (App.unsubscribeMain) App.unsubscribeMain();
        if (App.unsubscribeSpells) App.unsubscribeSpells();
        if (App.unsubscribeRequests) App.unsubscribeRequests();
        App.userId = null;
        App.currentPlayerName = null;
    }
});


const App = {
    // ==== MAGICAL CONFIGURATION ====
    VERSION: "24.22 Dictionary Training Complete", // Updated version
    ADMIN_UID: "AbgIydNv7Vd0hOTGI6GHYOo2heA2", // <--- YOUR ADMIN UID
    HOUSES: {
        "Gryffindor": { points: 0, color: "#AE0001", secondary: "#FFDB00", animal: "ü¶Å", traits: "Courage, Bravery, Chivalry" },
        "Ravenclaw": { points: 0, color: "#2B4C7E", secondary: "#946B2D", animal: "ü¶Ö", traits: "Intelligence, Wisdom, Creativity" },
        "Hufflepuff": { points: 0, color: "#FFDB00", secondary: "#000000", animal: "ü¶°", traits: "Loyalty, Patience, Justice" },
        "Slytherin": { points: 0, color: "#2A623D", secondary: "#AAAAAA", animal: "üêç", traits: "Ambition, Cunning, Resourcefulness" }
    },
    // Updated default students to form groups of 4
    DEFAULT_STUDENTS: [
        "Harry Potter", "Hermione Granger", "Ron Weasley", "Neville Longbottom",
        "Draco Malfoy", "Vincent Crabbe", "Gregory Goyle", "Pansy Parkinson",
        "Luna Lovegood", "Cho Chang", "Padma Patil", "Terry Boot",
        "Cedric Diggory", "Hannah Abbott", "Susan Bones", "Justin Finch-Fletchley"
    ],
    DEFAULT_HP: 150,
    DEFAULT_MP: 75,
    ACHIEVEMENTS: {
        "Dumbledore's Wisdom": { points: 50, icon: "üéì", description: "For exceptional wisdom and leadership" },
        "Marauder's Mischief": { points: 40, icon: "üåô", description: "For outstanding mischief and creativity" },
        "Patronus Charm": { points: 30, icon: "ü¶å", description: "For mastering advanced defensive magic" },
        "Time-Turner": { points: 60, icon: "‚è≥", description: "For exceptional time-management skills" },
        "Golden Snitch": { points: 100, icon: "‚ö°", description: "For catching the Golden Snitch in Quidditch" },
        "Potions Master": { points: 35, icon: "üß™", description: "For excellence in Potions" },
    },
    SHOP_ITEMS: {
        "Wiggenweld Potion": { cost: 50, icon: "üß™", desc: "A healing potion that restores 50 HP.", effect: { type: 'heal', amount: 50 } },
        "Focus Draught": { cost: 40, icon: "üíß", desc: "A magical draught that restores 40 MP.", effect: { type: 'mp_restore', amount: 40 } },
        "Shielding Brew": { cost: 75, icon: "üõ°Ô∏è", desc: "Creates a temporary magical shield that absorbs 30 damage.", effect: { type: 'add_shield', strength: 30, duration: 2, name: 'Shielding Brew' } },
        "Felix Felicis (Dose)": { cost: 200, icon: "‚ú®", desc: "Grants a guaranteed critical success (d20 = 20) on your next two spell rolls. Single use.", effect: { type: 'guaranteed_hit', duration: 2 } }
    },
    SPELLS: [
        "Expelliarmus", "Stupefy", "Protego", "Insendio", "Diffindo", "Petrificus Totalus",
        "Finite Incantatem", "Episkey", "Confringo", "Bombarda", "Reducto", "Aguamenti",
        "Confundo", "Silencio", "Sectumsempra", "Avada Kedavra", "Crucio", "Imperio"
    ],
    SPELL_DETAILS: {
        "Expelliarmus": { mp: 5, base_dmg: 10, type: "offensive", accuracy: 8, crit_chance: 19, desc: "Disarming charm. Medium damage." },
        "Stupefy": { mp: 8, base_dmg: 15, type: "offensive", accuracy: 9, crit_chance: 19, desc: "Stunning spell. Good damage." },
        "Insendio": { mp: 10, base_dmg: 18, type: "offensive", element: "üî• Fire", accuracy: 10, crit_chance: 18, desc: "Fire-making spell. Fire damage." },
        "Diffindo": { mp: 7, base_dmg: 12, type: "offensive", accuracy: 8, crit_chance: 19, desc: "Severing charm. Medium damage." },
        "Reducto": { mp: 12, base_dmg: 22, type: "offensive", accuracy: 11, crit_chance: 18, desc: "Reductor Curse. Significant damage." },
        "Confringo": { mp: 15, base_dmg: 28, type: "offensive", element: "üî• Fire", accuracy: 12, crit_chance: 17, desc: "Blasting Curse. High fire damage." },
        "Sectumsempra": { mp: 30, base_dmg: 25, type: "offensive_dark", effect: "ü©∏ Bleeding", dot_dmg: 10, duration: 2, accuracy: 14, crit_chance: 18, desc: "Dark cutting curse. Damage + bleeding over time." },
        "Petrificus Totalus": { mp: 10, base_dmg: 5, type: "offensive_bind", effect: "üòµ Stun", duration: 2, accuracy: 10, effect_chance: 12, desc: "Full Body-Bind. Low damage, may stun for 2 turns." },
        "Confundo": { mp: 10, type: "offensive_utility", effect: "ü•¥ Confuse", duration: 2, accuracy: 11, effect_chance: 10, desc: "Confundus Charm. May cause opponent to miss for 2 turns." },
        "Silencio": { mp: 7, type: "offensive_utility", effect: "ü§´ Silence", duration: 2, accuracy: 11, effect_chance: 13, desc: "Silencing Charm. Prevents spellcasting for 2 turns." },
        "Avada Kedavra": { mp: 50, base_dmg: 80, type: "offensive_dark_unforgivable", accuracy: 18, crit_chance: 20, desc: "The Killing Curse. Massive damage." },
        "Crucio": { mp: 35, base_dmg: 15, type: "offensive_dark_unforgivable", effect: "üò´ Pain", dot_dmg: 8, duration: 2, accuracy: 15, effect_chance: 10, desc: "Cruciatus Curse. Damage + pain over time for 2 turns." },
        "Imperio": { mp: 30, type: "offensive_dark_unforgivable", effect: "üïπÔ∏è Control", duration: 2, accuracy: 16, effect_chance: 9, desc: "Imperius Curse. Chance to control opponent for 2 turns." },
        "Protego": { mp: 10, type: "shield", strength: 25, duration: 1, accuracy: 5, desc: "Shield Charm. Blocks/reduces damage." },
        "Finite Incantatem": { mp: 10, type: "counter_utility", accuracy: 6, desc: "General Counter-Spell. Can dispel effects." },
        "Episkey": { mp: 12, base_heal: 30, type: "heal", accuracy: 5, desc: "Healing spell. Restores HP." },
        "Aguamenti": { mp: 5, base_dmg: 5, type: "offensive_utility", element: "water", accuracy: 7, desc: "Water-making spell. Minor water damage." },
    },
    SOUNDS: {
        points: [440, 523, 659], achievement: [784, 659, 523, 659, 784], error: [220, 110],
        sorting: [349, 392, 440, 523, 440, 392, 349], celebration: [659, 698, 784, 880, 784, 698, 659],
        spell_cast_ui: [523, 587, 659, 698, 784], duel_start: [200, 300, 400, 500],
        duel_hit: [600, 400], duel_miss: [300, 200], duel_block: [400, 400], shield_break: [300, 250, 200],
        heal_sound: [587, 698, 784], potion_use: [400, 500, 600], dice_roll: [200, 250, 300, 350, 400, 450, 500],
        crit_fail_sound: [400, 300, 200, 100],
        open_book: [261, 329, 392], turn_page: [392, 440], add_word: [659, 784, 880],
        correct_answer: [523, 659, 784, 1046], incorrect_answer: [349, 261]
    },
    
    // ==== APPLICATION STATE ====
    db: null,
    dbRef: null,
    studentData: {},
    groups: {}, // New: for student groups
    currentAssignments: {},
    history: [],
    userId: null,
    isAdmin: false,
    currentPlayerName: null, 
    unsubscribeMain: null,
    unsubscribeSpells: null,
    unsubscribeRequests: null,
    isMuted: false,
    appStartTime: null,
    logoUrl: "https://placehold.co/80x80/0C1C33/FFD700?text=LOGO",

    // ==== INITIALIZATION ====
    init(userId, db) {
        if (this.userId === userId) return;
        console.log("Initializing Hogwarts Tracker for user:", userId);
        
        this.userId = userId;
        this.db = db;
        this.dbRef = doc(db, "hogwarts-tracker", "main-state");
        this.isAdmin = this.userId === this.ADMIN_UID;
        this.appStartTime = Timestamp.now();

        const savedMuteState = localStorage.getItem('isMuted');
        this.isMuted = savedMuteState === 'true';
        this.updateMuteButton();
        
        document.getElementById('app-version').innerHTML = `<a href="https://t.me/quibblersclub" target="_blank" class="text-[#FFD700] hover:underline">Follow us on Telegram</a>`;
        
        this.setupRealtimeListeners();
        this.bindEventListeners();
        this.updateAdminControls();
        this.setupLogoUploader();
        
        this.playSound([261, 329, 392], 0.1, "sine");
        DuelingClub.app = this;
        Shop.app = this;
        Library.app = this;
        Dictionary.app = this;
        Quidditch.app = this;
        DiscussionQuestions.app = this;
        DictionaryTraining.app = this;

        TextAdventure.app = this;
    },

    // ==== EVENT BINDING ====
    bindEventListeners() {
        if (this.eventsBound) return;
        
        document.getElementById('award-points-btn').addEventListener('click', () => this.openAwardPointsDialog());
        document.getElementById('award-achievement-btn').addEventListener('click', () => this.openAwardAchievementDialog());
        document.getElementById('quidditch-btn').addEventListener('click', () => Quidditch.openGame());
        document.getElementById('duels-btn').addEventListener('click', () => DuelingClub.openDuelSetup());
        document.getElementById('hp1-adventure-btn').addEventListener('click', () => TextAdventure.open());     
        document.getElementById('potion-requests-btn').addEventListener('click', () => this.openPurchaseRequestsDialog());
        document.getElementById('assign-houses-btn').addEventListener('click', () => this.openSortGroupDialog());
        document.getElementById('manage-groups-btn').addEventListener('click', () => this.openManageGroupsDialog());
        document.getElementById('random-event-btn').addEventListener('click', () => this.triggerRandomEvent());
        document.getElementById('reset-points-btn').addEventListener('click', () => this.confirmResetPoints());
        document.getElementById('edit-students-btn').addEventListener('click', () => this.openEditStudentsDialog());
        document.getElementById('link-accounts-btn').addEventListener('click', () => this.openLinkAccountsDialog());
        document.getElementById('history-log-btn').addEventListener('click', () => this.showHistoryLog());
        castSpellBtn.addEventListener('click', () => this.broadcastSpellEffect());
        // Note: Direct listeners for dueling, quidditch, etc., are removed as they are now in the Games Hub.
        document.getElementById('magic-shop-btn').addEventListener('click', () => Shop.open());
        document.getElementById('library-btn').addEventListener('click', () => Library.openLibrary());
        document.getElementById('dictionary-btn').addEventListener('click', () => Dictionary.openDictionary());
        document.getElementById('dictionary-training-btn').addEventListener('click', () => DictionaryTraining.openHub());
        document.getElementById('questions-btn').addEventListener('click', () => DiscussionQuestions.open());
        document.getElementById('change-password-btn').addEventListener('click', () => this.openChangePasswordDialog());
        document.getElementById('mute-btn').addEventListener('click', () => {
            this.isMuted = !this.isMuted;
            this.updateMuteButton();
        });
        
        // Event delegation for student groups container
        document.getElementById('student-groups-container').addEventListener('click', (e) => {
            if (e.target.matches('.profile-btn')) {
                const studentName = e.target.dataset.studentName;
                this.openStudentProfile(studentName);
            }
        });

        // Global listener for Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                 if (document.getElementById('training-game-modal').classList.contains('show')) {
                    DictionaryTraining.closeGame();
                } else if (document.getElementById('dictionary-training-modal').classList.contains('show')) {
                    document.getElementById('dictionary-training-modal').classList.remove('show');
                } else if (document.getElementById('questions-modal').classList.contains('show')) {
                    DiscussionQuestions.close();
                } else if (document.getElementById('text-adventure-modal').classList.contains('show')) { // Added for Text Adventure
                    TextAdventure.close();
                } else if (document.getElementById('quidditch-modal').classList.contains('show')) {
                    Quidditch.closeGame();
                } else if (document.getElementById('duel-modal').classList.contains('show')) { // Moved for better grouping
                    DuelingClub.closeDuelModal();
                } else if (document.getElementById('games-hub-modal').classList.contains('show')) { // Added for Games Hub
                    document.getElementById('games-hub-modal').classList.remove('show');
                } else if (document.getElementById('reading-mode-container').classList.contains('reading-mode-active')) {
                    Library.exitReadingMode();
                } else if (document.getElementById('reader-modal').classList.contains('show')) {
                    Library.closeReader();
                } else if (document.getElementById('definition-popup-modal').classList.contains('show')) {
                    document.getElementById('definition-popup-modal').classList.remove('show');
                } else if (document.getElementById('dictionary-modal').classList.contains('show')) {
                    Dictionary.closeDictionary();
                } else if (document.getElementById('library-modal').classList.contains('show')) {
                    document.getElementById('library-modal').classList.remove('show');
                } else if (document.getElementById('modal').classList.contains('show')) {
                    this.closeModal();
                }
            }
        });

        this.eventsBound = true;
    },
    
    // ==== REAL-TIME DATABASE ====
    setupRealtimeListeners() {
        if (this.unsubscribeMain) this.unsubscribeMain();
        if (this.unsubscribeSpells) this.unsubscribeSpells();
        if (this.unsubscribeRequests) this.unsubscribeRequests();

        // Listener for main game state
        this.unsubscribeMain = onSnapshot(this.dbRef, (docSnap) => {
            if (docSnap.exists()) {
                console.log("Received real-time update from Firestore.");
                const data = docSnap.data();
                this.HOUSES = data.houses;
                this.studentData = data.studentData;
                this.groups = data.groups || {}; // New
                this.currentAssignments = data.currentAssignments;
                this.history = data.history;
                this.logoUrl = data.logoUrl || "https://placehold.co/80x80/0C1C33/FFD700?text=LOGO";
                document.getElementById('school-logo').src = this.logoUrl;
                this.identifyCurrentUser(); 
                this.updateDisplay();
            } else {
                console.log("No data in Firestore. Creating initial document.");
                if (this.isAdmin) {
                    this.loadDefaultsAndSave();
                } else {
                    document.getElementById('house-points-container').innerHTML = `<p class="text-center text-gray-400">Waiting for Admin to initialize data...</p>`;
                }
            }
        }, (error) => {
            console.error("Firestore listener error:", error);
            this.showNotification("Error connecting to the database.", "error");
        });

        // Listener for spell effects
        const spellsRef = collection(db, "spell-effects");
        const qSpells = query(spellsRef, where("timestamp", ">", this.appStartTime), orderBy("timestamp", "desc"));

        this.unsubscribeSpells = onSnapshot(qSpells, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const spellData = change.doc.data();
                    console.log("New spell detected:", spellData.name);
                    this.createVisualSpell(spellData.name, spellData.color);
                    this.showNotification(`${spellData.caster} casts ${spellData.name}!`, 'info');
                }
            });
        }, (error) => {
            console.error("Spell listener error:", error);
        });
        
        // Listener for purchase requests (admin only)
        if (this.isAdmin) {
            const requestsRef = collection(db, "purchase-requests");
            const qRequests = query(requestsRef, where("status", "==", "pending"));
            this.unsubscribeRequests = onSnapshot(qRequests, (snapshot) => {
                const count = snapshot.size;
                const badge = document.getElementById('potion-requests-badge');
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            });
        }
    },
    
    async saveProgress() {
        if (!this.isAdmin) {
            console.warn("Attempt to save by non-admin user was blocked.");
            this.showNotification("Only the administrator can make changes.", "error");
            return;
        }

        const dataToSave = {
            houses: this.HOUSES,
            studentData: this.studentData,
            groups: this.groups, // New
            currentAssignments: this.currentAssignments,
            history: this.history,
            lastUpdated: serverTimestamp(),
            logoUrl: this.logoUrl
        };
        
        try {
            await setDoc(this.dbRef, dataToSave);
            console.log("Progress saved to Firestore by admin.");
        } catch (error) {
            console.error("Error saving to Firestore:", error);
            this.showNotification("Error saving data.", "error");
        }
    },

    loadDefaultsAndSave() {
        console.log("Loading default data and saving to Firestore.");
        for (const houseName in this.HOUSES) {
            this.HOUSES[houseName].points = 0;
        }
        this.studentData = {};
        this.currentAssignments = {};
        this.history = [];
        this.logoUrl = "https://placehold.co/80x80/0C1C33/FFD700?text=LOGO";
        
        // Create student data
        this.DEFAULT_STUDENTS.forEach(name => {
            this.studentData[name] = { points: 0, achievements: [], hp: this.DEFAULT_HP, mp: this.DEFAULT_MP, inventory: [], authUid: null };
        });
        
        // Create default groups of 4
        this.groups = {};
        const groupSize = 4;
        for (let i = 0; i < this.DEFAULT_STUDENTS.length; i += groupSize) {
            const groupStudents = this.DEFAULT_STUDENTS.slice(i, i + groupSize);
            const groupId = `group_${(i/groupSize) + 1}`;
            this.groups[groupId] = {
                name: `Group ${(i/groupSize) + 1}`,
                students: groupStudents
            };
        }

        this.addHistory("System Initialized", "New database document created with student groups.");
        this.saveProgress();
    },

    // ==== CORE DISPLAY LOGIC ====
    updateDisplay() {
        this.updateHousePointsDisplay();
        this.updateStudentGroupsDisplay(); // Changed from updateStudentListDisplay
        this.updateUserDisplay();
    },
    
    updateAdminControls() {
        const adminSection = document.getElementById('admin-controls');
        if (this.isAdmin) {
            adminSection.classList.remove('admin-controls-disabled');
        } else {
            adminSection.classList.add('admin-controls-disabled');
        }
    },

    updateHousePointsDisplay() {
        const container = document.getElementById('house-points-container');
        if (!this.HOUSES) return;

        // NEW: Get sorted houses to determine rank
        const sortedHouses = Object.entries(this.HOUSES).sort(([, a], [, b]) => b.points - a.points);
        
        // NEW: Use grid for layout
        container.className = 'grid grid-cols-2 gap-4';
        container.innerHTML = ''; // Clear previous content

        sortedHouses.forEach(([houseName, house], index) => {
            const rank = index + 1;
            let rankIndicator = '';
            if (rank === 1 && house.points > 0) {
                rankIndicator = `<div class="absolute top-0 right-0 -mt-3 -mr-3 px-2 py-1 bg-yellow-400 text-gray-900 text-xs font-bold rounded-full shadow-lg">1st</div>`;
            }

            const houseEl = document.createElement('div');
            houseEl.className = 'relative p-4 rounded-lg shadow-lg flex flex-col items-center justify-center transition-transform transform hover:scale-105';
            // Use house colors for background/border
            houseEl.style.backgroundColor = house.color;
            houseEl.style.border = `2px solid ${house.secondary}`;
            // Use a dark/light text color based on the background for better contrast
            const textColor = (houseName === 'Hufflepuff') ? 'text-black' : 'text-white';

            houseEl.innerHTML = `
                ${rankIndicator}
                <div class="text-5xl mb-2">${house.animal}</div>
                <h3 class="font-bold text-lg ${textColor} font-magic-header">${houseName}</h3>
                <p class="font-black text-4xl ${textColor}" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${house.points}</p>
            `;
            container.appendChild(houseEl);
        });
    },

    updateStudentGroupsDisplay() {
        const container = document.getElementById('student-groups-container');
        if (!this.groups || !this.studentData) return;
        container.innerHTML = '';

        if (Object.keys(this.groups).length === 0) {
            container.innerHTML = `<p class="text-center p-4 text-gray-400">No student groups found.</p>`;
            return;
        }

        for (const groupId in this.groups) {
            const group = this.groups[groupId];
            
            const groupContainer = document.createElement('div');
            groupContainer.className = 'mb-6';

            const groupHeader = document.createElement('h3');
            groupHeader.className = 'text-xl font-magic-header text-yellow-300 mb-3 pl-2 border-l-4 border-yellow-300';
            groupHeader.textContent = group.name;
            if (this.isAdmin) {
                groupHeader.contentEditable = true;
                groupHeader.onblur = (e) => this.updateGroupName(groupId, e.target.textContent);
                groupHeader.title = "Click to edit group name";
            }
            groupContainer.appendChild(groupHeader);

            const studentGrid = document.createElement('div');
            studentGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4';

            group.students.forEach(studentName => {
                const student = this.studentData[studentName];
                if (!student) return; // Skip if student data doesn't exist

                const houseName = this.currentAssignments[studentName] || 'Unsorted';
                const house = this.HOUSES[houseName] || { color: '#FFFFFF', animal: '‚ùì' };

                const studentCard = document.createElement('div');
                studentCard.className = 'bg-[#1A2B3C] p-3 rounded-lg border border-[#3D5568] flex flex-col justify-between';
                studentCard.innerHTML = `
                    <div>
                        <div class="font-bold text-white">${studentName} ${this.currentPlayerName === studentName ? '(You)' : ''}</div>
                        <div class="text-sm" style="color: ${house.color};">${house.animal} ${houseName}</div>
                    </div>
                    <div class="flex justify-between items-center mt-3">
                        <div class="font-bold text-lg text-[#FFD700]">${student.points} pts</div>
                        <button class="btn text-xs bg-[#3D5568] text-white profile-btn" data-student-name="${studentName}">Profile</button>
                    </div>
                `;
                studentGrid.appendChild(studentCard);
            });
            
            groupContainer.appendChild(studentGrid);
            container.appendChild(groupContainer);
        }
    },
    
    updateUserDisplay() {
        const user = auth.currentUser;
        if (user) {
            let displayText = user.email;
            if (this.currentPlayerName) {
                displayText += ` (as ${this.currentPlayerName})`;
                castSpellBtn.disabled = false;
                castSpellBtn.title = "Cast a spell for everyone to see!";
            } else if (!this.isAdmin) {
                displayText += ` (Spectator)`;
                castSpellBtn.disabled = true;
                castSpellBtn.title = "Link your account to a student to cast spells.";
            } else {
                 castSpellBtn.disabled = false;
                 castSpellBtn.title = "Admins can cast shared spells.";
            }
            userDisplay.textContent = displayText;
        }
    },
    
    // ==== MODALS AND DIALOGS ====
    openModal(title, contentHTML, onConfirm, confirmText = 'Confirm') {
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        
        modalContent.innerHTML = `
            <span class="modal-close-btn" onclick="App.closeModal()">&times;</span>
            <h3 class="font-magic-header text-2xl text-[#FFD700] mb-4">${title}</h3>
            <div class="space-y-4">${contentHTML}</div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="modal-cancel" class="btn bg-gray-600 text-white">Cancel</button>
                ${onConfirm ? `<button id="modal-confirm" class="btn btn-gold">${confirmText}</button>` : ''}
            </div>
        `;
        
        modal.classList.add('show');

        modal.querySelector('#modal-cancel').addEventListener('click', () => this.closeModal());
        if (onConfirm) {
            const confirmBtn = modal.querySelector('#modal-confirm');
            confirmBtn.addEventListener('click', () => {
                onConfirm();
            });
        }
    },

    openGamesHub() {
        const gamesHubContent = document.getElementById('games-hub-content');
        const contentHTML = `
            <span class="modal-close-btn" onclick="document.getElementById('games-hub-modal').classList.remove('show')">&times;</span>
            <h3 class="font-magic-header text-3xl text-center text-[#FFD700] mb-6">Chamber of Games</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2">
                
                <div class="training-hub-card p-4 rounded-lg flex items-center gap-4" onclick="Quidditch.openGame(); document.getElementById('games-hub-modal').classList.remove('show');">
                    <div class="text-5xl">üßπ</div>
                    <div>
                        <h4 class="font-bold text-lg text-yellow-300">Quidditch Match</h4>
                        <p class="text-sm text-gray-300">Take to the skies and catch the Golden Snitch in this narrative simulation.</p>
                    </div>
                </div>

                <div class="training-hub-card p-4 rounded-lg flex items-center gap-4" onclick="DuelingClub.openDuelSetup(); document.getElementById('games-hub-modal').classList.remove('show');">
                    <div class="text-5xl">‚öîÔ∏è</div>
                    <div>
                        <h4 class="font-bold text-lg text-yellow-300">Dueling Club</h4>
                        <p class="text-sm text-gray-300">Test your spellcasting prowess in a turn-based duel against another student.</p>
                    </div>
                </div>

                <div class="training-hub-card p-4 rounded-lg flex items-center gap-4 md:col-span-2" onclick="TextAdventure.open(); document.getElementById('games-hub-modal').classList.remove('show');">
                    <div class="text-5xl">üìú</div>
                    <div>
                        <h4 class="font-bold text-lg text-yellow-300">HP1 Text Adventure</h4>
                        <p class="text-sm text-gray-300">Relive the first book in an interactive story where your commands shape the adventure.</p>
                    </div>
                </div>

            </div>
        `;
        gamesHubContent.innerHTML = contentHTML;
        document.getElementById('games-hub-modal').classList.add('show');
    },

    closeModal() {
        document.getElementById('modal').classList.remove('show');
    },
    
    openAwardPointsDialog() {
        const studentOptions = ['(Entire House)', ...Object.keys(this.studentData).sort()];
        const houseOptions = Object.keys(this.HOUSES);

        const content = `
            <div>
                <label class="block mb-1 text-sm font-medium">Target Student (optional)</label>
                <select id="points-student" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
                    ${studentOptions.map(s => `<option value="${s}">${s}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block mb-1 text-sm font-medium">Target House</label>
                <select id="points-house" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
                    ${houseOptions.map(h => `<option value="${h}">${h}</option>`).join('')}
                </select>
            </div>
            <div class="flex items-center gap-4">
                <input id="points-amount" type="number" value="10" class="w-24 bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
                <div class="flex gap-4">
                    <label><input type="radio" name="points-action" value="add" checked> Add</label>
                    <label><input type="radio" name="points-action" value="deduct"> Deduct</label>
                </div>
            </div>
            <div>
                <label class="block mb-1 text-sm font-medium">Reason</label>
                <input id="points-reason" type="text" placeholder="For excellent performance" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
            </div>
        `;

        this.openModal('Award/Deduct Points', content, () => {
            const student = document.getElementById('points-student').value;
            const house = document.getElementById('points-house').value;
            let amount = parseInt(document.getElementById('points-amount').value) || 0;
            const action = document.querySelector('input[name="points-action"]:checked').value;
            const reason = document.getElementById('points-reason').value || 'Student/House performance';
            if (action === 'deduct') amount = -amount;

            let historyAction = '';
            if (student !== '(Entire House)') {
                 if (this.currentAssignments[student] !== house) {
                    this.showNotification(`Error: ${student} is not in ${house}.`, 'error');
                    return;
                }
                this.studentData[student].points += amount;
                historyAction = `${amount > 0 ? '+' : ''}${amount} points to ${student} (${house})`;
            } else {
                Object.keys(this.currentAssignments).forEach(sName => {
                    if (this.currentAssignments[sName] === house) {
                        this.studentData[sName].points += amount;
                    }
                });
                historyAction = `${amount > 0 ? '+' : ''}${amount} points to everyone in ${house}`;
            }

            this.HOUSES[house].points += amount;
            this.addHistory(historyAction, reason);
            this.playSound(this.SOUNDS.points);
            this.saveProgress();
            this.closeModal();
        }, 'Apply');

        // Add listener to auto-select house
        const studentSelect = document.getElementById('points-student');
        const houseSelect = document.getElementById('points-house');
        studentSelect.addEventListener('change', (e) => {
            const selectedStudent = e.target.value;
            if (selectedStudent !== '(Entire House)') {
                const studentHouse = this.currentAssignments[selectedStudent];
                if (studentHouse) {
                    houseSelect.value = studentHouse;
                    houseSelect.disabled = true;
                }
            } else {
                houseSelect.disabled = false;
            }
        });
    },

    openAwardAchievementDialog() {
        if (Object.keys(this.studentData).length === 0) {
            this.showNotification("Add students first.", "error");
            return;
        }
        const studentOptions = Object.keys(this.studentData).sort();
        const achievementOptions = Object.keys(this.ACHIEVEMENTS);

        const content = `
             <div>
                <label class="block mb-1 text-sm font-medium">Select Student</label>
                <select id="ach-student" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
                    ${studentOptions.map(s => `<option value="${s}">${s}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block mb-1 text-sm font-medium">Select Achievement</label>
                <select id="ach-name" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
                    ${achievementOptions.map(a => `<option value="${a}">${a} (+${this.ACHIEVEMENTS[a].points} points)</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block mb-1 text-sm font-medium">Reason</label>
                <input id="ach-reason" type="text" placeholder="For an exceptional act" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
            </div>
        `;
        
        this.openModal('Grant Achievement', content, () => {
            const student = document.getElementById('ach-student').value;
            const achievementName = document.getElementById('ach-name').value;
            const reason = document.getElementById('ach-reason').value || 'Exceptional act';
            const house = this.currentAssignments[student];

            if (!house) {
                this.showNotification(`${student} is not in a house!`, 'error');
                return;
            }

            const achievement = this.ACHIEVEMENTS[achievementName];
            this.studentData[student].points += achievement.points;
            if (!this.studentData[student].achievements.includes(achievementName)) {
                this.studentData[student].achievements.push(achievementName);
            }
            this.HOUSES[house].points += achievement.points;

            this.addHistory(`Granted '${achievementName}' to ${student}`, reason);
            this.playSound(this.SOUNDS.achievement);
            this.saveProgress();
            this.closeModal();
            this.showNotification(`‚ú® ${student} earned the '${achievementName}' achievement!`, 'success');
        }, 'Grant');
    },

    openEditStudentsDialog() {
        const renderStudentList = () => {
            return Object.keys(this.studentData).sort().map(name => `
                <div class="flex items-center gap-2 mb-2">
                    <input type="text" value="${name}" data-original-name="${name}" class="student-name-entry flex-grow bg-[#0C1C33] p-2 rounded border border-[#3D5568]">
                    <button class="btn-destructive text-sm p-2 remove-student-btn" data-student-name="${name}">üóëÔ∏è</button>
                </div>
            `).join('');
        };

        const content = `
            <p class="text-sm text-gray-400 mb-4">Add or remove students from the master list. This does not assign them to groups.</p>
            <div class="flex gap-2 mb-4">
                <input id="new-student-name" type="text" placeholder="New student name" class="flex-grow bg-[#0C1C33] p-2 rounded border border-[#3D5568]">
                <button id="add-student-btn" class="btn btn-gold">Add</button>
            </div>
            <div id="edit-student-list-container" class="max-h-64 overflow-y-auto">
                ${renderStudentList()}
            </div>
        `;

        this.openModal('Manage Student Roster', content, () => {
            const entries = document.querySelectorAll('.student-name-entry');
            let historyAdded = false;
            entries.forEach(entry => {
                const oldName = entry.dataset.originalName;
                const newName = entry.value.trim();
                if (newName && newName !== oldName) {
                    if (this.studentData[newName]) {
                        this.showNotification(`A student named "${newName}" already exists.`, 'error');
                        entry.value = oldName; // revert
                    } else {
                        // This part is complex with groups. A simple rename is okay.
                        const oldStudentData = this.studentData[oldName];
                        this.studentData[newName] = oldStudentData;
                        delete this.studentData[oldName];

                        if (this.currentAssignments[oldName]) {
                            this.currentAssignments[newName] = this.currentAssignments[oldName];
                            delete this.currentAssignments[oldName];
                        }
                        
                        // Update name in groups
                        for(const groupId in this.groups) {
                            const studentIndex = this.groups[groupId].students.indexOf(oldName);
                            if (studentIndex > -1) {
                                this.groups[groupId].students[studentIndex] = newName;
                            }
                        }

                        if (!historyAdded) {
                           this.addHistory('Updated names in student list.', 'Manual edit');
                           historyAdded = true;
                        }
                    }
                }
            });
            this.saveProgress();
            this.closeModal();
        }, 'Save & Close');
        
        const modalContent = document.getElementById('modal-content');

        // Add student logic
        modalContent.querySelector('#add-student-btn').addEventListener('click', () => {
            const newNameInput = document.getElementById('new-student-name');
            const newName = newNameInput.value.trim();
            if (newName && !this.studentData[newName]) {
                this.studentData[newName] = { points: 0, achievements: [], hp: this.DEFAULT_HP, mp: this.DEFAULT_MP, inventory: [], authUid: null };
                this.addHistory(`Added new student: ${newName}`, 'Manual addition');
                this.saveProgress();
                this.closeModal();
                this.openEditStudentsDialog();
            } else if (this.studentData[newName]) {
                this.showNotification(`Student "${newName}" already exists!`, 'error');
            }
        });

        // Remove student logic using event delegation
        modalContent.querySelector('#edit-student-list-container').addEventListener('click', (e) => {
            if (e.target.matches('.remove-student-btn')) {
                const studentName = e.target.dataset.studentName;
                const confirmationContent = `<p>Are you sure you want to remove ${studentName} from the school? This will also remove them from any group they are in. This action is irreversible.</p>`;
                this.openModal('Confirm Deletion', confirmationContent, () => {
                    // This is a "sub-modal", so we close it and then proceed.
                    this.closeModal(); 
                    
                    delete this.studentData[studentName];
                    delete this.currentAssignments[studentName];
                    // Also remove from groups
                    for(const groupId in this.groups) {
                        this.groups[groupId].students = this.groups[groupId].students.filter(s => s !== studentName);
                    }
                    this.addHistory(`Removed student: ${studentName}`, 'Manual removal from roster');
                    this.saveProgress();
                    
                    // Re-open the edit modal to show the change
                    this.openEditStudentsDialog(); 
                }, 'Delete');
            }
        });
    },
    
    openLinkAccountsDialog() {
        const studentRows = Object.keys(this.studentData).sort().map(name => {
            const student = this.studentData[name];
            const currentUid = student.authUid || '';
            return `
                <div class="grid grid-cols-2 gap-4 items-center mb-2">
                    <label for="uid-${name}" class="text-right">${name}:</label>
                    <input type="text" id="uid-${name}" data-student-name="${name}" value="${currentUid}" placeholder="Not Linked" class="account-uid-entry bg-[#0C1C33] p-2 rounded border border-[#3D5568] text-sm">
                </div>
            `;
        }).join('');

        const content = `
            <p class="text-sm text-gray-400 mb-4">
                Enter the Firebase Auth UID for each student to link their login account to their profile. You can find the UID in the Firebase Console under Authentication.
            </p>
            <div id="link-accounts-list" class="max-h-72 overflow-y-auto">
                ${studentRows}
            </div>
        `;

        this.openModal('Link Student Accounts', content, () => {
            const inputs = document.querySelectorAll('.account-uid-entry');
            let changesMade = false;
            inputs.forEach(input => {
                const studentName = input.dataset.studentName;
                const newUid = input.value.trim() || null; 
                if (this.studentData[studentName].authUid !== newUid) {
                    this.studentData[studentName].authUid = newUid;
                    changesMade = true;
                }
            });

            if (changesMade) {
                this.addHistory('Updated student account links', 'Admin action');
                this.saveProgress();
                this.showNotification('Account links updated successfully!', 'success');
            }
            this.closeModal();
        }, 'Save Links');
    },
    
    openStudentProfile(studentName) {
        const student = this.studentData[studentName];
        const houseName = this.currentAssignments[studentName] || 'Unsorted';
        const house = this.HOUSES[houseName] || { color: '#FFFFFF', animal: '‚ùì', traits: 'N/A' };
        
        const achievementsHTML = student.achievements.length > 0 ? 
            student.achievements.map(achName => {
                const ach = this.ACHIEVEMENTS[achName];
                return `<div class="flex items-center gap-2"><span class="text-xl">${ach.icon}</span> <span>${achName}</span></div>`;
            }).join('') : '<p class="text-gray-400">No achievements yet.</p>';

        const inventoryHTML = student.inventory && student.inventory.length > 0 ?
            student.inventory.map(itemName => {
                const item = this.SHOP_ITEMS[itemName];
                const removeBtn = this.isAdmin ? `<button class="btn-destructive text-xs p-1" onclick="App.adminRemoveItem('${studentName}', '${itemName}')">X</button>` : '';
                return `<div class="flex items-center justify-between"><div class="flex items-center gap-2"><span class="text-xl">${item.icon}</span> <span>${itemName}</span></div> ${removeBtn}</div>`;
            }).join('') : '<p class="text-gray-400">No items.</p>';
        
        const adminInventoryControls = this.isAdmin ? `
            <div class="flex gap-2 mt-2">
                <select id="admin-add-item-select" class="w-full bg-[#2A3B4D] rounded p-1 border border-[#3D5568] text-sm">
                    ${Object.keys(this.SHOP_ITEMS).map(name => `<option value="${name}">${name}</option>`).join('')}
                </select>
                <button class="btn btn-gold text-sm" onclick="App.adminAddItem('${studentName}')">Add</button>
            </div>
        ` : '';

        const studentHistory = this.history.filter(entry => entry.action.includes(studentName));
        const historyHTML = studentHistory.length > 0 ? studentHistory.slice().reverse().map(entry => `
            <div class="p-2 border-b border-gray-700 text-sm">
                <p class="font-semibold">${entry.action}</p>
                <p class="text-gray-400 italic">"${entry.reason}" - ${entry.date}</p>
            </div>
        `).join('') : '<p class="text-gray-400">No points history.</p>';

        const content = `
            <div class="flex items-center gap-4 mb-4">
                <div class="text-6xl">${house.animal}</div>
                <div>
                    <h4 class="text-xl font-bold" style="color: ${house.color};">${studentName}</h4>
                    <p class="text-lg">${houseName}</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><strong>Points:</strong> <span class="text-[#FFD700]">${student.points}</span></div>
                <div><strong>HP:</strong> ${student.hp} / ${this.DEFAULT_HP}</div>
                <div><strong>MP:</strong> ${student.mp} / ${this.DEFAULT_MP}</div>
                <div><strong>Traits:</strong> ${house.traits}</div>
            </div>
            <div class="mt-4">
                <button class="btn btn-gold w-full" onclick="DiscussionQuestions.showStudentHomework('${studentName}')">üéì View Homework</button>
            </div>
            <hr class="my-4 border-gray-600">
            <h5 class="font-bold mb-2">üéí Inventory</h5>
            <div class="space-y-1 mb-2">${inventoryHTML}</div>
            ${adminInventoryControls}
            <hr class="my-4 border-gray-600">
            <h5 class="font-bold mb-2">üåü Achievements</h5>
            <div class="space-y-1 mb-2">${achievementsHTML}</div>
            <hr class="my-4 border-gray-600">
            <h5 class="font-bold mb-2">üìú Points History</h5>
            <div class="space-y-1 max-h-32 overflow-y-auto">${historyHTML}</div>
        `;
        this.openModal(`Student Profile: ${studentName}`, content, null);
    },

    showHistoryLog() {
        const historyHTML = this.history.slice().reverse().map(entry => `
            <div class="p-2 border-b border-gray-700">
                <p class="text-sm text-gray-400">${entry.date}</p>
                <p class="font-semibold">${entry.action}</p>
                <p class="text-sm text-gray-300 italic">"${entry.reason}"</p>
            </div>
        `).join('');

        const content = `<div class="max-h-96 overflow-y-auto">${historyHTML || '<p>Log is empty.</p>'}</div>`;
        this.openModal('Magical History Log', content);
    },
    
    // ==== CORE LOGIC ====
    identifyCurrentUser() {
        this.currentPlayerName = null;
        if (this.userId && this.studentData) {
            for (const studentName in this.studentData) {
                if (this.studentData[studentName].authUid === this.userId) {
                    this.currentPlayerName = studentName;
                    break;
                }
            }
        }
        console.log(`Current player identified as: ${this.currentPlayerName || 'None'}`);
    },

    openSortGroupDialog() {
        if (Object.keys(this.groups).length === 0) {
            this.showNotification("There are no groups to sort!", "error");
            return;
        }

        const groupOptions = Object.keys(this.groups).map(id => {
            const group = this.groups[id];
            return `<option value="${id}">${group.name}</option>`;
        }).join('');

        const content = `
            <div>
                <label for="group-to-sort" class="block mb-2 text-sm font-medium">Which group will the Sorting Hat sort?</label>
                <select id="group-to-sort" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
                    ${groupOptions}
                </select>
            </div>
        `;

        this.openModal('Sorting Ceremony', content, () => {
            const groupId = document.getElementById('group-to-sort').value;
            this.assignHousesForGroup(groupId);
            this.closeModal();
        }, 'Sort Group');
    },

    assignHousesForGroup(groupId) {
        const group = this.groups[groupId];
        if (!group || group.students.length === 0) {
            this.showNotification("Selected group is empty or invalid.", "error");
            return;
        }

        const studentsToSort = group.students;
        const houses = Object.keys(this.HOUSES);
        
        this.playSound(this.SOUNDS.sorting, 0.2);
        
        // Simple round-robin assignment
        let houseIndex = 0;
        let assignmentsText = `The Sorting Ceremony for ${group.name} is complete:\n`;
        
        studentsToSort.forEach((student) => {
            const assignedHouse = houses[houseIndex];
            this.currentAssignments[student] = assignedHouse;
            assignmentsText += `- ${student}: ${assignedHouse}\n`;
            houseIndex = (houseIndex + 1) % houses.length;
        });

        this.addHistory(`Sorted Group: ${group.name}`, assignmentsText);
        this.saveProgress();
        this.showNotification(`üé© ${group.name} has been sorted!`, "success");
    },
    
    // =================================================================================
    // ==== NEW GROUP MANAGEMENT LOGIC ====
    // =================================================================================
    openManageGroupsDialog() {
        const getUnassignedStudents = () => {
            const allStudents = new Set(Object.keys(this.studentData));
            const assignedStudents = new Set();
            Object.values(this.groups).forEach(group => {
                group.students.forEach(student => assignedStudents.add(student));
            });
            return [...allStudents].filter(student => !assignedStudents.has(student));
        };

        const renderGroupManager = () => {
            let html = '';
            const groupOptions = Object.keys(this.groups).map(id => `<option value="${id}">${this.groups[id].name}</option>`).join('');

            for (const groupId in this.groups) {
                const group = this.groups[groupId];
                const studentListHTML = group.students.map(studentName => `
                    <div class="flex items-center justify-between bg-[#0C1C33] p-2 rounded">
                        <span>${studentName}</span>
                        <div class="flex items-center gap-1">
                            <select class="transfer-student-select bg-[#2A3B4D] text-xs p-1 rounded" data-student-name="${studentName}" data-source-group="${groupId}">
                                <option value="">Transfer to...</option>
                                ${Object.keys(this.groups).filter(id => id !== groupId).map(id => `<option value="${id}">${this.groups[id].name}</option>`).join('')}
                            </select>
                            <button class="btn-destructive text-xs p-1" onclick="App.removeStudentFromGroup('${studentName}', '${groupId}')" title="Remove from group">‚úñ</button>
                        </div>
                    </div>
                `).join('');

                const unassignedStudents = getUnassignedStudents();
                const addStudentDropdownHTML = unassignedStudents.length > 0 ? `
                    <div class="flex gap-2 mt-2">
                        <select id="add-student-select-${groupId}" class="w-full bg-[#2A3B4D] p-1 rounded border border-[#3D5568] text-sm">
                            ${unassignedStudents.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                        <button class="btn btn-gold text-sm" onclick="App.addStudentToGroup('${groupId}')">Add</button>
                    </div>
                ` : '<p class="text-xs text-gray-400 mt-2">No unassigned students available.</p>';

                html += `
                    <div class="bg-[#1A2B3C] p-4 rounded-lg border border-[#3D5568]">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-lg text-yellow-300">${group.name}</h4>
                            <button class="btn btn-destructive text-sm" onclick="App.deleteGroup('${groupId}')">Delete Group</button>
                        </div>
                        <div class="space-y-2 mb-2">${studentListHTML || '<p class="text-sm text-gray-400">This group is empty.</p>'}</div>
                        ${addStudentDropdownHTML}
                    </div>
                `;
            }
            return html;
        };
        
        const content = `
            <div id="group-manager-container" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                ${renderGroupManager()}
            </div>
            <hr class="my-4 border-gray-600">
            <div>
                <h4 class="font-bold text-lg text-yellow-300 mb-2">Create New Group</h4>
                <div class="flex gap-2">
                    <input id="new-group-name" type="text" placeholder="New group name" class="flex-grow bg-[#0C1C33] p-2 rounded border border-[#3D5568]">
                    <button class="btn btn-gold" onclick="App.createGroup()">Create</button>
                </div>
            </div>
        `;

        this.openModal('Manage Groups', content, () => {
            this.closeModal();
        }, 'Done');

        // Add event listener for transfer dropdowns
        document.querySelectorAll('.transfer-student-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const studentName = e.target.dataset.studentName;
                const sourceGroupId = e.target.dataset.sourceGroup;
                const destGroupId = e.target.value;
                if (studentName && sourceGroupId && destGroupId) {
                    this.transferStudent(studentName, sourceGroupId, destGroupId);
                }
            });
        });
    },

    createGroup() {
        const groupNameInput = document.getElementById('new-group-name');
        const groupName = groupNameInput.value.trim();
        if (!groupName) {
            this.showNotification("Group name cannot be empty.", "error");
            return;
        }

        const newGroupId = `group_${Date.now()}`;
        this.groups[newGroupId] = { name: groupName, students: [] };
        
        this.addHistory(`Created new group: ${groupName}`, 'Admin action');
        this.saveProgress();
        this.openManageGroupsDialog(); // Refresh the dialog
    },

    deleteGroup(groupId) {
        const groupName = this.groups[groupId].name;
        const confirmationContent = `<p>Are you sure you want to permanently delete the group "${groupName}"? The students will become unassigned but will not be deleted.</p>`;
        this.openModal('Confirm Deletion', confirmationContent, () => {
            delete this.groups[groupId];
            this.addHistory(`Deleted group: ${groupName}`, 'Admin action');
            this.saveProgress();
            this.closeModal(); // Close confirmation
            this.openManageGroupsDialog(); // Refresh main dialog
        }, 'Delete');
    },

    addStudentToGroup(groupId) {
        const select = document.getElementById(`add-student-select-${groupId}`);
        const studentName = select.value;
        if (!studentName) {
            this.showNotification("No student selected.", "error");
            return;
        }

        this.groups[groupId].students.push(studentName);
        this.addHistory(`Added ${studentName} to group ${this.groups[groupId].name}`, 'Admin action');
        this.saveProgress();
        this.openManageGroupsDialog(); // Refresh
    },

    removeStudentFromGroup(studentName, groupId) {
        this.groups[groupId].students = this.groups[groupId].students.filter(s => s !== studentName);
        this.addHistory(`Removed ${studentName} from group ${this.groups[groupId].name}`, 'Admin action');
        this.saveProgress();
        this.openManageGroupsDialog(); // Refresh
    },

    transferStudent(studentName, sourceGroupId, destGroupId) {
        // Remove from source
        this.groups[sourceGroupId].students = this.groups[sourceGroupId].students.filter(s => s !== studentName);
        // Add to destination
        this.groups[destGroupId].students.push(studentName);
        
        this.addHistory(`Transferred ${studentName} from ${this.groups[sourceGroupId].name} to ${this.groups[destGroupId].name}`, 'Admin action');
        this.saveProgress();
        this.showNotification(`Transferred ${studentName} successfully.`, 'success');
        this.openManageGroupsDialog(); // Refresh
    },
    
    // =================================================================================

    triggerRandomEvent() {
        const events = [
            { name: "Successful Quidditch practice pays off!", p1: 10, p2: 5 },
            { name: "A minor incident in Potions class.", p1: -5, p2: 0 },
            { name: "Helpful research in the library.", p1: 10, p2: 0 },
            { name: "Peeves causes a bit of a ruckus.", p1: -3, p2: -3 },
        ];
        const event = events[Math.floor(Math.random() * events.length)];
        const houses = Object.keys(this.HOUSES);
        const [h1, h2] = houses.sort(() => 0.5 - Math.random());

        this.HOUSES[h1].points += event.p1;
        this.HOUSES[h2].points += event.p2;

        const reason = `${h1}: ${event.p1 > 0 ? '+' : ''}${event.p1} points, ${h2}: ${event.p2 > 0 ? '+' : ''}${event.p2} points.`;
        this.addHistory(`Random Event: ${event.name}`, reason);
        this.saveProgress();
        this.showNotification(`‚ö° Random Event: ${event.name}!`, 'success');
    },

    confirmResetPoints() {
        const confirmationContent = `<p>Reset ALL house and student points to their initial values? This action is irreversible!</p>`;
        this.openModal('Confirm Reset', confirmationContent, () => {
            this.loadDefaultsAndSave();
            this.playSound(this.SOUNDS.error);
            this.showNotification("All points have been reset.", "success");
            this.closeModal();
        }, 'Reset');
    },

    async broadcastSpellEffect() {
        const casterName = this.isAdmin ? "The Headmaster" : this.currentPlayerName;
        if (!casterName) {
            this.showNotification("Only linked students can cast shared spells.", "error");
            return;
        }
        const spellName = this.SPELLS[Math.floor(Math.random() * this.SPELLS.length)];
        const houseName = this.currentAssignments[this.currentPlayerName] || 'Gryffindor';
        const houseColor = this.HOUSES[houseName].color;

        try {
            await addDoc(collection(db, "spell-effects"), {
                name: spellName,
                color: houseColor,
                caster: casterName,
                timestamp: serverTimestamp()
            });
        } catch (error) {
            console.error("Error broadcasting spell:", error);
            this.showNotification("Could not cast the spell.", "error");
        }
    },

    createVisualSpell(spellName, color) {
        const container = document.getElementById('spell-effect-container');
        const spellEl = document.createElement('div');
        spellEl.className = 'spell-effect';
        spellEl.textContent = `‚ú® ${spellName} ‚ú®`;
        
        const startX = Math.random() * window.innerWidth;
        spellEl.style.left = `${startX}px`;
        spellEl.style.bottom = '0px';
        spellEl.style.color = color || '#FFD700';

        container.appendChild(spellEl);
        this.playSound(this.SOUNDS.spell_cast_ui, 0.1);

        setTimeout(() => {
            spellEl.remove();
        }, 1500);
    },

    // ==== UTILITIES & HELPERS ====
    addHistory(action, reason) {
        const date = new Date().toLocaleString('en-US');
        this.history.push({ date, action, reason });
        if (this.history.length > 100) {
            this.history.shift();
        }
    },

    playSound(notes, duration = 0.1, type = "triangle") {
        if (this.isMuted) return;
        if (typeof Tone === 'undefined') return;
        try {
            const synth = new Tone.Synth({
                oscillator: { type },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
            }).toDestination();
            
            const now = Tone.now();
            if (Array.isArray(notes)) {
                notes.forEach((note, i) => {
                    synth.triggerAttackRelease(note, "8n", now + i * duration);
                });
            } else {
                synth.triggerAttackRelease(notes, "8n", now);
            }
        } catch (e) {
            console.error("Error playing sound:", e);
        }
    },

    updateMuteButton() {
        const muteBtn = document.getElementById('mute-btn');
        if (muteBtn) {
            muteBtn.textContent = this.isMuted ? 'üîá' : 'üîä';
        }
        localStorage.setItem('isMuted', this.isMuted);
    },

    showNotification(message, type = 'success') {
        const notif = document.createElement('div');
        notif.textContent = message;
        notif.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white font-bold z-[3000]`; // Increased z-index
        
        let bgColor;
        switch(type) {
            case 'success':
                bgColor = '#2A623D';
                break;
            case 'error':
                bgColor = '#AE0001';
                break;
            case 'info':
                bgColor = '#2B4C7E'; // Ravenclaw blue for info
                break;
            default:
                bgColor = '#2A623D';
        }
        notif.style.backgroundColor = bgColor;

        document.body.appendChild(notif);
        setTimeout(() => {
            notif.remove();
        }, 3000);
    },

    updateGroupName(groupId, newName) {
        if (!this.isAdmin) return;
        const cleanedName = newName.trim();
        if (cleanedName && this.groups[groupId] && this.groups[groupId].name !== cleanedName) {
            this.groups[groupId].name = cleanedName;
            this.addHistory(`Renamed group to "${cleanedName}"`, 'Admin action');
            this.saveProgress();
            this.showNotification(`Group renamed to "${cleanedName}"`, 'success');
        }
    },

    // ==== LOGO FUNCTIONALITY ====
    setupLogoUploader() {
        const logoImg = document.getElementById('school-logo');
        const logoUploadInput = document.getElementById('logo-upload');
        const logoContainer = logoImg.parentElement;

        if (this.isAdmin) {
            logoContainer.addEventListener('click', () => {
                logoUploadInput.click();
            });

            logoUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageDataUrl = e.target.result;
                        this.logoUrl = imageDataUrl;
                        this.saveProgress();
                        this.showNotification('Logo updated successfully!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });
        } else {
            // Remove hover effect for non-admin
            logoContainer.classList.remove('group');
            const hoverDiv = logoContainer.querySelector('div');
            if (hoverDiv) hoverDiv.remove();
            logoContainer.style.cursor = 'default';
        }
    },

    // ==== NEW POTION & INVENTORY LOGIC ====
    async requestPurchase(studentName, itemName) {
        const item = this.SHOP_ITEMS[itemName];
        const student = this.studentData[studentName];
        if (!item || !student) return;

        if (student.points < item.cost) {
            this.showNotification("You do not have enough points for this item.", "error");
            return;
        }

        try {
            await addDoc(collection(db, "purchase-requests"), {
                studentName,
                itemName,
                itemCost: item.cost,
                status: "pending",
                timestamp: serverTimestamp()
            });
            this.showNotification("Purchase request sent to the admin for approval.", "success");
            this.closeModal();
        } catch (error) {
            console.error("Error sending purchase request:", error);
            this.showNotification("Could not send purchase request.", "error");
        }
    },

    async openPurchaseRequestsDialog() {
        try {
            const requestsRef = collection(db, "purchase-requests");
            const q = query(requestsRef, where("status", "==", "pending"), orderBy("timestamp", "asc"));
            const snapshot = await getDocs(q);

            let requestsHTML = '';
            if (snapshot.empty) {
                requestsHTML = '<p class="text-center text-gray-400">No pending requests.</p>';
            } else {
                snapshot.forEach(doc => {
                    const req = doc.data();
                    const item = this.SHOP_ITEMS[req.itemName];
                    if (!item) return; // Skip if item is no longer sold
                    requestsHTML += `
                        <div class="p-3 bg-[#0C1C33] rounded-lg border border-[#3D5568] flex justify-between items-center">
                            <div>
                                <p><strong>${req.studentName}</strong> requests <strong>${item.icon} ${req.itemName}</strong></p>
                                <p class="text-sm text-gray-400">Cost: ${req.itemCost} points</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn bg-green-600 text-white text-sm" onclick="App.handlePurchaseRequest('${doc.id}', true)">Approve</button>
                                <button class="btn btn-destructive text-sm" onclick="App.handlePurchaseRequest('${doc.id}', false)">Deny</button>
                            </div>
                        </div>
                    `;
                });
            }

            const content = `<div class="space-y-3 max-h-96 overflow-y-auto">${requestsHTML}</div>`;
            this.openModal('Potion Purchase Requests', content);
        } catch (error) {
            console.error("Error opening purchase requests:", error);
            this.showNotification("Could not load purchase requests. Check console for details.", "error");
            const content = `<p class="text-red-400">Failed to load requests. This is likely due to a missing Firestore index. Please check the browser console (F12) for a detailed error message and a link to create the necessary index.</p>`;
            this.openModal('Error Loading Requests', content);
        }
    },

    async handlePurchaseRequest(requestId, isApproved) {
        if (!this.isAdmin) return;

        const requestRef = doc(db, "purchase-requests", requestId);
        const requestSnap = await getDoc(requestRef);
        if (!requestSnap.exists()) {
            this.showNotification("Request not found.", "error");
            return;
        }

        const requestData = requestSnap.data();
        const { studentName, itemName, itemCost } = requestData;
        
        const batch = writeBatch(db);
        const mainStateRef = this.dbRef;

        if (isApproved) {
            const latestDoc = await getDoc(mainStateRef);
            const latestStudentData = latestDoc.data().studentData;
            const student = latestStudentData[studentName];
            
            if (!student) {
                this.showNotification(`Student ${studentName} not found.`, "error");
                batch.update(requestRef, { status: "denied", reason: "Student not found" });
            } else if (student.points < itemCost) {
                this.showNotification(`${studentName} no longer has enough points.`, "error");
                batch.update(requestRef, { status: "denied", reason: "Insufficient points" });
            } else {
                student.points -= itemCost;
                if (!student.inventory) student.inventory = [];
                student.inventory.push(itemName);
                
                batch.update(mainStateRef, { [`studentData.${studentName}`]: student });
                
                batch.update(requestRef, { status: "approved" });
                this.addHistory(`Approved ${itemName} for ${studentName}`, `Cost: ${itemCost} points.`);
                this.showNotification("Purchase approved!", "success");
            }
        } else {
            batch.update(requestRef, { status: "denied", reason: "Admin denied" });
            this.showNotification("Purchase denied.", "info");
        }

        await batch.commit();
        this.openPurchaseRequestsDialog(); // Refresh the dialog
    },
    
    async adminAddItem(studentName) {
        const itemName = document.getElementById('admin-add-item-select').value;
        if (!itemName) return;

        const student = this.studentData[studentName];
        if (!student.inventory) student.inventory = [];
        student.inventory.push(itemName);

        await updateDoc(this.dbRef, { [`studentData.${studentName}`]: student });
        this.showNotification(`Added ${itemName} to ${studentName}'s inventory.`, 'success');
        this.openStudentProfile(studentName); // Refresh profile
    },

    async adminRemoveItem(studentName, itemName) {
        const student = this.studentData[studentName];
        const itemIndex = student.inventory.indexOf(itemName);
        if (itemIndex > -1) {
            student.inventory.splice(itemIndex, 1);
        }

        await updateDoc(this.dbRef, { [`studentData.${studentName}`]: student });
        this.showNotification(`Removed ${itemName} from ${studentName}'s inventory.`, 'success');
        this.openStudentProfile(studentName); // Refresh profile
    },
    openChangePasswordDialog() {
        const content = `
            <div>
                <label for="current-password" class="block mb-1 text-sm font-medium">Current Password</label>
                <input id="current-password" type="password" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
            </div>
            <div>
                <label for="new-password" class="block mb-1 text-sm font-medium">New Password (min. 6 characters)</label>
                <input id="new-password" type="password" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
            </div>
            <div>
                <label for="new-password-confirm" class="block mb-1 text-sm font-medium">Confirm New Password</label>
                <input id="new-password-confirm" type="password" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
            </div>
        `;

        this.openModal('Change Password', content, () => {
            this.handleChangePassword();
        }, 'Update Password');
    },

    async handleChangePassword() {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const newPasswordConfirm = document.getElementById('new-password-confirm').value;

        if (!currentPassword || !newPassword || !newPasswordConfirm) {
            this.showNotification("All password fields are required.", "error");
            return;
        }

        if (newPassword !== newPasswordConfirm) {
            this.showNotification("New passwords do not match.", "error");
            return;
        }

        if (newPassword.length < 6) {
            this.showNotification("New password must be at least 6 characters long.", "error");
            return;
        }

        const user = auth.currentUser;
        if (!user) {
            this.showNotification("No user is currently logged in.", "error");
            return;
        }
        
        const credential = EmailAuthProvider.credential(user.email, currentPassword);

        try {
            // Re-authenticate user to confirm their identity
            await reauthenticateWithCredential(user, credential);
            
            // If successful, update the password
            await updatePassword(user, newPassword);
            
            this.showNotification("Password updated successfully!", "success");
            this.closeModal();

        } catch (error) {
            console.error("Password change error:", error);
            let errorMessage = "Failed to change password. Please try again.";
            if (error.code === 'auth/wrong-password') {
                errorMessage = "The current password you entered is incorrect.";
            } else if (error.code === 'auth/weak-password') {
                errorMessage = "The new password is too weak.";
            }
            this.showNotification(errorMessage, "error");
        }
    },
};

window.App = App;

// =================================================================================
// DISCUSSION QUESTIONS MODULE (REVISED FOR HOMEWORK)
// =================================================================================
const DiscussionQuestions = {
    app: null,
    
    CHAPTER_QUESTIONS: {
        "chapter1": {
            "title": "The Boy Who Lived",
            "houses": {
                "Gryffindor": {
                    "traits": "Bravery, Courage, Daring",
                    "questions": [
                        "Do you think it was brave of Professor McGonagall to confront Dumbledore about leaving Harry with the Dursleys? Why or why not?",
                        "If you were in Hagrid‚Äôs place, would you have dared to fly with baby Harry on a motorcycle through the night?",
                        "Was Dumbledore brave to leave Harry in a ‚Äúnormal‚Äù family instead of keeping him in the wizarding world?",
                        "Have you ever had to make a brave choice for the good of someone else?"
                    ]
                },
                "Ravenclaw": {
                    "traits": "Wisdom, Curiosity, Intelligence",
                    "questions": [
                        "Why do you think Dumbledore trusted the Dursleys with Harry despite knowing their attitude?",
                        "What can we learn about the wizarding world from the way wizards celebrate Voldemort‚Äôs fall in this chapter?",
                        "What details in the chapter give us clues about how magical and non-magical worlds are different?",
                        "If you could ask Dumbledore one question after reading this chapter, what would it be?"
                    ]
                },
                "Hufflepuff": {
                    "traits": "Loyalty, Kindness, Fairness",
                    "questions": [
                        "How do you feel about the way the Dursleys treated Harry‚Äôs parents‚Äô memory? Was it fair?",
                        "Was it kind of Dumbledore to leave Harry with relatives, even if they didn‚Äôt want him?",
                        "How does Hagrid show loyalty to Dumbledore in this chapter?",
                        "Do you think family is about blood ties or about love and care? Why?"
                    ]
                },
                "Slytherin": {
                    "traits": "Ambition, Cunning, Resourcefulness",
                    "questions": [
                        "If you were in Dumbledore‚Äôs position, how would you make sure Harry‚Äôs identity remained secret and safe?",
                        "Do you think Voldemort‚Äôs ambition was the main reason for his downfall? Why or why not?",
                        "What do you think Petunia gained from pretending that the Potters didn‚Äôt exist?",
                        "If you had Harry‚Äôs fame from the very beginning, how would you use it to your advantage?"
                    ]
                }
            }
        }
        // Add more chapters here, e.g., "chapter2": { ... }
    },

    open() {
        const modal = document.getElementById('questions-modal');
        const modalContent = modal.querySelector('#questions-modal-content');

        const chaptersHTML = Object.entries(this.CHAPTER_QUESTIONS).map(([id, chapter]) => `
            <div class="book-card bg-[#0C1C33] p-4 rounded-lg flex items-center justify-between mb-4" onclick="DiscussionQuestions.openChapter('${id}')">
                <h4 class="font-bold text-lg text-yellow-300 cursor-pointer">${chapter.title}</h4>
                <button class="btn btn-gold">
                    <span class="mr-1">‚úçÔ∏è</span> Answer
                </button>
            </div>
        `).join('');

        modalContent.innerHTML = `
            <span class="modal-close-btn" onclick="DiscussionQuestions.close()">&times;</span>
            <h3 class="font-magic-header text-3xl text-center text-[#FFD700] mb-6">Homework Assignments</h3>
            <div class="max-h-[75vh] overflow-y-auto pr-2">
                ${chaptersHTML}
            </div>
        `;

        modal.classList.add('show');
    },

    async openChapter(chapterId) {
        if (!this.app.currentPlayerName) {
            this.app.showNotification("You must be linked to a student to answer questions.", "error");
            return;
        }
        const modalContent = document.getElementById('questions-modal-content');
        modalContent.innerHTML = `<div class="flex justify-center items-center h-48"><div class="spinner"></div></div>`;

        const chapterData = this.CHAPTER_QUESTIONS[chapterId];
        const studentAnswers = await this.loadAnswers(chapterId);

        let contentHTML = '';
        for (const houseName in chapterData.houses) {
            const houseQuestions = chapterData.houses[houseName];
            const houseInfo = this.app.HOUSES[houseName];

            const questionsHTML = houseQuestions.questions.map((q, index) => {
                const answerKey = `${houseName}_${index}`;
                const savedAnswer = studentAnswers[answerKey] || '';
                return `
                <div class="mb-4">
                    <p class="mb-2 pl-4 border-l-2 border-gray-600/50 text-gray-300">${q}</p>
                    <textarea id="answer-${chapterId}-${houseName}-${index}" class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568] text-white h-24" placeholder="Your answer...">${savedAnswer}</textarea>
                    <div class="text-right mt-1">
                        <button class="btn btn-gold text-sm" onclick="DiscussionQuestions.saveAnswer('${chapterId}', '${houseName}', ${index})">Save Answer</button>
                    </div>
                </div>
                `;
            }).join('');

            contentHTML += `
                <div class="mb-4 bg-[#0C1C33] p-5 rounded-lg border border-[#3D5568]">
                    <h4 class="font-magic-header text-2xl mb-3 flex items-center gap-3" style="color: ${houseInfo.color};">
                        <span class="text-3xl">${houseInfo.animal}</span>
                        <span>${houseName}</span>
                    </h4>
                    ${questionsHTML}
                </div>
            `;
        }

        modalContent.innerHTML = `
            <span class="modal-close-btn" onclick="DiscussionQuestions.open()">&times;</span>
            <button class="btn bg-gray-600 mb-4" onclick="DiscussionQuestions.open()">‚Üê Back to Chapters</button>
            <h3 class="font-magic-header text-3xl text-center text-[#FFD700] mb-6">${chapterData.title}</h3>
            <div class="max-h-[70vh] overflow-y-auto pr-2">
                ${contentHTML}
            </div>
        `;
    },

    async saveAnswer(chapterId, houseName, questionIndex) {
        const textarea = document.getElementById(`answer-${chapterId}-${houseName}-${questionIndex}`);
        const answerText = textarea.value.trim();
        if (!answerText) {
            this.app.showNotification("Answer cannot be empty.", "error");
            return;
        }

        if (!this.app.userId) {
            this.app.showNotification("You are not logged in.", "error");
            return;
        }

        const answerKey = `${houseName}_${questionIndex}`;
        const docRef = doc(this.app.db, "homework", this.app.userId, "answers", chapterId);

        try {
            await setDoc(docRef, { [answerKey]: answerText }, { merge: true });
            this.app.showNotification("Answer saved successfully!", "success");
        } catch (error) {
            console.error("Error saving answer:", error);
            this.app.showNotification("Could not save your answer.", "error");
        }
    },

    async loadAnswers(chapterId) {
        if (!this.app.userId) return {};
        try {
            const docRef = doc(this.app.db, "homework", this.app.userId, "answers", chapterId);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? docSnap.data() : {};
        } catch (error) {
            console.error("Error loading answers:", error);
            return {};
        }
    },

    async showStudentHomework(studentName) {
        const student = this.app.studentData[studentName];
        if (!student || !student.authUid) {
            this.app.showNotification("This student account is not linked to a login. Cannot retrieve homework.", "error");
            return;
        }

        this.app.closeModal(); // Close the profile modal first
        const questionsModal = document.getElementById('questions-modal');
        const modalContent = questionsModal.querySelector('#questions-modal-content');
        modalContent.innerHTML = `<div class="flex justify-center items-center h-48"><div class="spinner"></div></div>`;
        questionsModal.classList.add('show');

        try {
            const answersCollectionRef = collection(this.app.db, "homework", student.authUid, "answers");
            const querySnapshot = await getDocs(answersCollectionRef);
            
            if (querySnapshot.empty) {
                modalContent.innerHTML = `
                    <span class="modal-close-btn" onclick="DiscussionQuestions.close()">&times;</span>
                    <h3 class="font-magic-header text-3xl text-center text-[#FFD700] mb-6">${studentName}'s Homework</h3>
                    <p class="text-center text-gray-400">This student has not submitted any homework yet.</p>
                `;
                return;
            }

            let homeworkHTML = '';
            for (const doc of querySnapshot.docs) {
                const chapterId = doc.id;
                const answers = doc.data();
                const chapterData = this.CHAPTER_QUESTIONS[chapterId];
                if (!chapterData) continue;

                let chapterAnswersHTML = '';
                for (const answerKey in answers) {
                    const [houseName, questionIndex] = answerKey.split('_');
                    const questionText = chapterData.houses[houseName]?.questions[questionIndex];
                    if (questionText) {
                        chapterAnswersHTML += `
                            <div class="mb-4">
                                <p class="mb-1 pl-3 border-l-2 border-gray-500 text-gray-400 italic">Q: ${questionText}</p>
                                <p class="p-2 bg-[#2A3B4D] rounded text-white">A: ${answers[answerKey]}</p>
                            </div>
                        `;
                    }
                }

                if(chapterAnswersHTML) {
                    homeworkHTML += `
                        <div class="mb-4 bg-[#0C1C33] p-5 rounded-lg border border-[#3D5568]">
                            <h4 class="font-magic-header text-2xl mb-3 text-yellow-300">${chapterData.title}</h4>
                            ${chapterAnswersHTML}
                        </div>
                    `;
                }
            }

            modalContent.innerHTML = `
                <span class="modal-close-btn" onclick="DiscussionQuestions.close()">&times;</span>
                <h3 class="font-magic-header text-3xl text-center text-[#FFD700] mb-6">${studentName}'s Homework</h3>
                <div class="max-h-[70vh] overflow-y-auto pr-2">
                    ${homeworkHTML || '<p class="text-center text-gray-400">No valid homework answers found.</p>'}
                </div>
            `;

        } catch (error) {
            console.error("Error fetching student homework:", error);
            this.app.showNotification("Access denied", "Oops");
            modalContent.innerHTML = `
                <span class="modal-close-btn" onclick="DiscussionQuestions.close()">&times;</span>
                <h3 class="font-magic-header text-3xl text-center text-[#FFD700] mb-6">Oops!</h3>
                <p class="text-center text-red-400">This door is magically sealed. A higher level of access is required.</p>
            `;
        }
    },

    close() {
        document.getElementById('questions-modal').classList.remove('show');
    }
};
window.DiscussionQuestions = DiscussionQuestions;


// =================================================================================
// DICTIONARY MODULE
// =================================================================================
// =================================================================================
// DICTIONARY MODULE (REVISED AND FIXED)
// =================================================================================
const Dictionary = {
    app: null,
    userWords: {},

    async openDictionary() {
        if (!this.app.userId) {
            this.app.showNotification("You must be logged in to view your dictionary.", "error");
            return;
        }
        const modal = document.getElementById('dictionary-modal');
        const modalContent = modal.querySelector('#dictionary-modal-content');
        modalContent.innerHTML = `<div class="flex justify-center items-center h-48"><div class="spinner"></div></div>`;
        modal.classList.add('show');

        await this.loadUserWords();
        this.renderDictionary();
    },

    async loadUserWords() {
        if (!this.app.userId) return;
        try {
            const docRef = doc(this.app.db, "dictionaries", this.app.userId);
            const docSnap = await getDoc(docRef);
            this.userWords = docSnap.exists() ? docSnap.data().words || {} : {};
        } catch (error) {
            console.error("Error fetching dictionary:", error);
            this.app.showNotification("Could not load your dictionary.", "error");
            this.userWords = {};
        }
    },

    renderDictionary(targetId = 'dictionary-modal-content') {
        const container = document.getElementById(targetId);
        if (!container) return;

        const wordsHTML = Object.entries(this.userWords)
            .sort(([wordA], [wordB]) => wordA.localeCompare(wordB))
            .map(([word, data]) => {
                // Handle both old (string) and new (object) data formats
                const definition = typeof data === 'string' ? data : data.definition;
                return `
                <div class="dictionary-word-card p-4 rounded-lg flex justify-between items-start gap-4" data-word="${word.toLowerCase()}">
                    <div class="flex-grow">
                        <h4 class="font-bold text-lg text-yellow-300 capitalize">${word}</h4>
                        <p class="text-gray-300 mt-1 text-sm">${definition}</p>
                    </div>
                    <div class="flex-shrink-0 flex flex-col gap-2">
                         <button class="btn bg-blue-600 hover:bg-blue-700 text-white text-xs p-2" onclick="Dictionary.viewOnMerriamWebster('${word}')">M-W</button>
                         <button class="btn btn-destructive text-xs p-2" onclick="Dictionary.deleteWord('${word}')">Delete</button>
                    </div>
                </div>
            `}).join('');

        if (targetId === 'dictionary-modal-content') {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            const alphabetHTML = alphabet.map(letter => `<button class="alpha-btn" onclick="Dictionary.filterByLetter('${letter}')">${letter}</button>`).join('');

            container.innerHTML = `
                <span class="modal-close-btn" onclick="Dictionary.closeDictionary()">&times;</span>
                <div class="flex justify-between items-center mb-4 border-b-2 border-yellow-600 pb-3">
                    <h3 class="font-magic-header text-2xl text-[#FFD700]">Your Personal Dictionary</h3>
                </div>

                <div class="mb-4 p-2 bg-[#0C1C33] rounded-lg">
                    <input type="text" id="dictionary-search-input" onkeyup="Dictionary.filterWords()" placeholder="Search for a word..." class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568] mb-2">
                    <div id="alphabet-filter" class="flex flex-wrap justify-center gap-1">
                        <button class="alpha-btn active" onclick="Dictionary.filterByLetter('All')">All</button>
                        ${alphabetHTML}
                    </div>
                </div>

                <div id="dictionary-word-list" class="space-y-3 max-h-[50vh] overflow-y-auto p-1">
                    ${Object.keys(this.userWords).length > 0 ? wordsHTML : '<p class="text-center text-gray-400 p-8">Your dictionary is empty. Click words in books to add them!</p>'}
                </div>
            `;
        } else { // For reading mode sidebar
            container.innerHTML = `
                 <h3 class="font-magic-header text-xl text-center text-[#8B4513] mb-4 border-b-2 border-[#d3c0a5] pb-2">Dictionary</h3>
                 <div class="space-y-2 overflow-y-auto flex-grow pr-2">
                    ${Object.keys(this.userWords).length > 0 ? wordsHTML : '<p class="text-center text-gray-600 p-4 text-sm">Your dictionary is empty.</p>'}
                 </div>
            `;
        }
    },

    closeDictionary() {
        document.getElementById('dictionary-modal').classList.remove('show');
    },

    filterWords() {
        const input = document.getElementById('dictionary-search-input');
        const filter = input.value.toLowerCase();
        const wordList = document.getElementById('dictionary-word-list');
        if (!wordList) return;
        const cards = wordList.getElementsByClassName('dictionary-word-card');

        for (let i = 0; i < cards.length; i++) {
            const word = cards[i].dataset.word;
            if (word.includes(filter)) {
                cards[i].style.display = "flex";
            } else {
                cards[i].style.display = "none";
            }
        }
    },

    filterByLetter(letter) {
        const wordList = document.getElementById('dictionary-word-list');
        if (!wordList) return;
        const cards = wordList.getElementsByClassName('dictionary-word-card');
        const lowerLetter = letter.toLowerCase();

        // Update active button style
        document.querySelectorAll('#alphabet-filter .alpha-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.textContent === letter) btn.classList.add('active');
        });
        
        // Clear search input to avoid conflicts
        const searchInput = document.getElementById('dictionary-search-input');
        if(searchInput) searchInput.value = '';

        for (let i = 0; i < cards.length; i++) {
            const word = cards[i].dataset.word;
            if (letter === 'All' || word.startsWith(lowerLetter)) {
                cards[i].style.display = "flex";
            } else {
                cards[i].style.display = "none";
            }
        }
    },
    
    viewOnMerriamWebster(word) {
        const url = `https://www.merriam-webster.com/dictionary/${encodeURIComponent(word)}`;
        window.open(url, '_blank');
    },

    async showDefinitionPopup(word) {
        const modal = document.getElementById('definition-popup-modal');
        const modalContent = document.getElementById('definition-popup-content');
        modal.classList.add('show');

        modalContent.innerHTML = `
            <span class="modal-close-btn" onclick="document.getElementById('definition-popup-modal').classList.remove('show')">&times;</span>
            <h3 class="font-magic-header text-2xl text-[#FFD700] mb-4 capitalize">${word}</h3>
            <div id="definition-display" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"><div class="flex justify-center p-4"><div class="spinner"></div></div></div>
            <div class="flex justify-between mt-4">
                <button class="btn bg-blue-600 text-white hover:bg-blue-700 hover:-translate-y-0.5 hover:shadow-lg" onclick="Dictionary.viewOnMerriamWebster('${word}')">View on M-W</button>
                <button class="btn btn-gold" id="save-definition" disabled>Save Selected</button>
            </div>`;

        const defs = await this._fetchDefinitions(word);
        const display = modalContent.querySelector("#definition-display");
        display.innerHTML = ''; // Clear spinner

        if (defs.length > 0) {
            defs.forEach((d) => {
                const card = document.createElement('div');
                card.className = "p-3 rounded border border-[#3D5568] bg-[#182635] hover:border-yellow-300 transition cursor-pointer";
                card.innerHTML = `<p class="text-gray-200">${d.definition}</p>${d.example ? `<p class="text-gray-400 text-xs italic mt-1">${d.example}</p>` : ''}`;
                card.addEventListener('click', () => {
                    modalContent.querySelectorAll('#definition-display div.border-yellow-300').forEach(el => el.classList.remove('border-yellow-300', 'bg-[#2A3B4D]'));
                    card.classList.add('border-yellow-300', 'bg-[#2A3B4D]');
                    modalContent.querySelector("#save-definition").disabled = false;
                    modalContent.querySelector("#save-definition").onclick = () => this.saveWord(word, d.definition);
                });
                display.appendChild(card);
            });
        }
        
        const custom = document.createElement('div');
        custom.className = "p-3 rounded border border-dashed border-[#3D5568] bg-transparent mt-4";
        custom.innerHTML = `<p class="text-yellow-300 mb-2 text-sm">${defs.length > 0 ? 'Or add your own custom definition:' : 'No definitions found. Please add your own:'}</p>
            <textarea id="custom-def" class="w-full bg-[#2A3B4D] text-white p-2 rounded"></textarea>
            <div class="text-right mt-2"><button class="btn btn-gold" onclick="Dictionary.saveCustom('${word}')">Save Custom</button></div>`;
        display.appendChild(custom);
    },

    async _fetchDefinitions(word) {
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
            if (!res.ok) return [];
            const data = await res.json();
            return data.flatMap(entry => entry.meanings.flatMap(m => 
                m.definitions.map(d => ({definition: d.definition, example: d.example||""})))).slice(0, 5);
        } catch {
            return [];
        }
    },

    saveCustom(word) {
        const text = document.getElementById('custom-def')?.value.trim();
        if (!text) {
            this.app.showNotification("Please enter a definition.", "error");
            return;
        }
        this.saveWord(word, text);
    },

    async saveWord(word, definition) {
        if (!this.app.userId) return;
        const cleanedWord = word.toLowerCase();

        if (this.userWords[cleanedWord]) {
            this.app.showNotification(`"${word}" is already in your dictionary.`, "info");
            document.getElementById('definition-popup-modal').classList.remove('show');
            return;
        }

        const docRef = doc(this.app.db, "dictionaries", this.app.userId);
        try {
            await setDoc(docRef, { words: { [cleanedWord]: definition } }, { merge: true });
            this.userWords[cleanedWord] = definition;
            this.app.playSound(this.app.SOUNDS.add_word);
            this.app.showNotification(`Added "${word}" to your dictionary!`, "success");
            document.getElementById('definition-popup-modal').classList.remove('show');
            this.refreshAllViews();
        } catch (e) {
            console.error("Firestore save error:", e);
            this.app.showNotification("Error: Could not save word.", "error");
        }
    },

    async deleteWord(word) {
        if (!this.app.userId) return;
        const docRef = doc(this.app.db, "dictionaries", this.app.userId);
        try {
            await updateDoc(docRef, { [`words.${word}`]: deleteField() });
            delete this.userWords[word];
            this.app.showNotification(`Removed "${word}" from your dictionary.`, "success");
            this.refreshAllViews();
        } catch (e) {
            console.error("Firestore delete error:", e);
            this.app.showNotification("Error: Could not delete word.", "error");
        }
    },
    
    refreshAllViews() {
        if (document.getElementById('dictionary-modal').classList.contains('show')) {
            this.renderDictionary();
        }
        if (document.getElementById('reading-mode-container').classList.contains('reading-mode-active')) {
            Dictionary.renderDictionary('reading-mode-dictionary');
        }
    }
};
window.Dictionary = Dictionary;

// =================================================================================
// LIBRARY MODULE
// =================================================================================
const Library = {
    app: null,
    readerSettings: {
        fontFamily: "'Roboto Slab', serif"
    },
    currentBookId: null,
    currentChapterId: null,

    async openLibrary() {
        const modal = document.getElementById('library-modal');
        const modalContent = modal.querySelector('#library-modal-content');
        modalContent.innerHTML = `<h3 class="font-magic-header text-2xl text-[#FFD700] mb-4 text-center">Loading Library...</h3>`;
        modal.classList.add('show');
        this.app.playSound(this.app.SOUNDS.open_book);

        try {
            const booksRef = collection(this.app.db, 'books');
            const querySnapshot = await getDocs(booksRef);
            const books = [];
            querySnapshot.forEach(doc => {
                books.push({ id: doc.id, ...doc.data() });
            });

            const booksHTML = books.map(book => {
                const editButtonHTML = this.app.isAdmin ?
                    `<button class="btn bg-[#3D5568] text-white text-sm ml-2" onclick="Library.toggleEditMode(this, 'book', '${book.id}')">‚úèÔ∏è</button>` : '';
                
                return `
                <div class="book-card bg-[#0C1C33] p-4 rounded-lg flex items-center justify-between mb-4">
                    <div class="flex-grow">
                        <h4 class="font-bold text-lg" data-book-id="${book.id}" style="color: #E0E0E0;">${book.title || book.id}</h4>
                        <p class="text-sm text-gray-400">${book.author || 'J. K. Rowling'}</p>
                    </div>
                    <div class="flex items-center">
                        <button class="btn btn-gold" onclick="Library.openBook('${book.id}')">
                            <span class="mr-1">üìñ</span> Read
                        </button>
                        ${editButtonHTML}
                    </div>
                </div>`;
            }).join('');

            modalContent.innerHTML = `
                <span class="modal-close-btn" onclick="document.getElementById('library-modal').classList.remove('show')">&times;</span>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-magic-header text-2xl text-[#FFD700]">The Library</h3>
                </div>
                <div class="space-y-4">
                    ${books.length > 0 ? booksHTML : '<p class="text-center text-gray-400 py-4">The library is currently empty.</p>'}
                </div>
            `;
        } catch (error) {
            console.error("Error fetching books:", error);
            this.app.showNotification("Could not open the library.", "error");
            modalContent.innerHTML = `<p class="text-center text-red-400">Error loading library. Check Firestore security rules.</p>
            <button class="btn btn-gold mt-4" onclick="document.getElementById('library-modal').classList.remove('show')">Close</button>`;
        }
    },

    async openBook(bookId) {
        this.currentBookId = bookId;
        document.getElementById('library-modal').classList.remove('show');
        const readerModal = document.getElementById('reader-modal');
        const readerContent = readerModal.querySelector('#reader-modal-content');
        
        const bookRef = doc(this.app.db, 'books', bookId);
        const bookSnap = await getDoc(bookRef);
        const bookTitle = bookSnap.exists() ? bookSnap.data().title : 'Book Not Found';

        readerContent.innerHTML = `<h3 class="font-magic-header text-2xl text-[#FFD700] mb-4 text-center">Opening ${bookTitle}...</h3>`;
        readerModal.classList.add('show');

        try {
            const chaptersRef = collection(this.app.db, 'books', bookId, 'chapters');
            const querySnapshot = await getDocs(chaptersRef);
            const chapters = [];
            querySnapshot.forEach(doc => {
                chapters.push({ id: doc.id, ...doc.data() });
            });

            chapters.sort((a, b) => {
                const numA = parseInt(a.id.match(/\d+/g)?.[0] || 0);
                const numB = parseInt(b.id.match(/\d+/g)?.[0] || 0);
                return numA - numB;
            });

            const chaptersHTML = chapters.map(chap => {
                 const editButtonHTML = this.app.isAdmin ?
                    `<button class="btn bg-[#3D5568] text-white text-xs p-1 ml-2" onclick="Library.toggleEditMode(this, 'chapter', '${bookId}', '${chap.id}')">‚úèÔ∏è</button>` : '';

                return `<li class="chapter-item p-2 rounded hover:bg-[#2A3B4D] cursor-pointer">
                    <div class="flex items-center justify-between">
                        <a href="#" class="flex-grow" data-chapter-id="${chap.id}" onclick="Library.loadChapter('${bookId}', '${chap.id}')" style="color: #E0E0E0;">${chap.title || chap.id}</a>
                        ${editButtonHTML}
                    </div>
                </li>`;
            }).join('');

            const savedSettings = localStorage.getItem('readerSettings');
            if (savedSettings) {
                this.readerSettings = JSON.parse(savedSettings);
            }

            readerContent.innerHTML = `
                <span class="modal-close-btn" onclick="Library.closeReader()">&times;</span>
                <div class="flex justify-between items-center mb-4 border-b border-[#3D5568] pb-4">
                    <h3 class="font-magic-header text-2xl text-[#FFD700]">${bookTitle}</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="md:col-span-1">
                        <h4 class="font-bold mb-2 text-white">Chapters</h4>
                        <ul id="chapter-list" class="space-y-1 max-h-[70vh] overflow-y-auto">${chaptersHTML}</ul>
                    </div>
                    <div class="md:col-span-3 flex flex-col">
                        <div id="reader-toolbar" class="reader-toolbar flex items-center gap-2 mb-4 p-3">
                            <button id="reading-mode-btn" class="toolbar-btn flex items-center">
                                <span class="mr-1">üìñ</span> Reading mode
                            </button>
                            <select id="font-family-select" class="toolbar-btn bg-[#2A3B4D] text-white p-1 rounded">
                                <option value="'Roboto Slab', serif" class="font-option" style="font-family: 'Roboto Slab', serif;">Roboto Slab (Default)</option>
                                <option value="'IM Fell English', serif" class="font-option" style="font-family: 'IM Fell English', serif;">IM Fell English</option>
                                <option value="'Inter', sans-serif" class="font-option" style="font-family: 'Inter', sans-serif;">Inter</option>
                                <option value="'Merriweather', serif" class="font-option" style="font-family: 'Merriweather', serif;">Merriweather</option>
                                <option value="'Lora', serif" class="font-option" style="font-family: 'Lora', serif;">Lora</option>
                                <option value="'Playfair Display', serif" class="font-option" style="font-family: 'Playfair Display', serif;">Playfair Display</option>
                                <option value="'EB Garamond', serif" class="font-option" style="font-family: 'EB Garamond', serif;">EB Garamond</option>
                                <option value="'Lato', sans-serif" class="font-option" style="font-family: 'Lato', sans-serif;">Lato</option>
                                <option value="'Open Sans', sans-serif" class="font-option" style="font-family: 'Open Sans', sans-serif;">Open Sans</option>
                                <option value="'Cormorant Garamond', serif" class="font-option" style="font-family: 'Cormorant Garamond', serif;">Cormorant Garamond</option>
                                <option value="'Alegreya', serif" class="font-option" style="font-family: 'Alegreya', serif;">Alegreya</option>
                                <option value="'Uncial Antiqua', cursive" class="font-option" style="font-family: 'Uncial Antiqua', cursive;">Uncial Antiqua</option>
                            </select>
                        </div>
                        <div id="reader-content-container" class="flex-grow p-6 rounded-lg overflow-y-auto parchment">
                            <div id="reader-content">
                                <p class="text-center">Select a chapter to begin reading.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            readerContent.querySelector('#reading-mode-btn').addEventListener('click', () => this.enterReadingMode());
            readerContent.querySelector('#font-family-select').addEventListener('change', (e) => this.changeFontFamily(e.target.value));
            
            readerContent.querySelector('#font-family-select').value = this.readerSettings.fontFamily;
            
            if (chapters.length > 0) {
                this.loadChapter(bookId, chapters[0].id);
            }

        } catch (error) {
            console.error(`Error fetching chapters for ${bookId}:`, error);
            this.app.showNotification("Could not open book.", "error");
            readerContent.innerHTML = `<p>Error loading book. Please try again later.</p>`;
        }
    },

    closeReader() {
        const readerModal = document.getElementById('reader-modal');
        readerModal.classList.remove('show');
        this.openLibrary();
    },

    async loadChapter(bookId, chapterId) {
        this.currentBookId = bookId;
        this.currentChapterId = chapterId;
        const contentContainer = document.getElementById('reader-content');
        if (!contentContainer) return;
        contentContainer.innerHTML = `<p class="text-center py-8">Loading chapter...</p>`;
        this.app.playSound(this.app.SOUNDS.turn_page);

        document.querySelectorAll('#chapter-list .chapter-item').forEach(el => el.classList.remove('active'));
        const activeLink = document.querySelector(`#chapter-list li a[onclick*="'${chapterId}'"]`);
        if(activeLink) {
            activeLink.parentElement.parentElement.classList.add('active');
        }

        try {
            const chapterRef = doc(this.app.db, 'books', bookId, 'chapters', chapterId);
            const docSnap = await getDoc(chapterRef);

        if (docSnap.exists()) {
            const chapterData = docSnap.data();
            const formattedContent = this.formatChapterContent(chapterData);
            
            contentContainer.innerHTML = `
                <h4 class="text-xl font-bold mb-4 text-center">${chapterData.title || chapterId}</h4>
                ${formattedContent}
            `;
            
            this.applyReaderSettings();
            this.addWordClickListener(contentContainer);

        } else {
            contentContainer.innerHTML = `<p class="text-center py-8">Chapter content not found.</p>`;
        }
        } catch (error) {
            console.error(`Error loading chapter ${chapterId}:`, error);
            contentContainer.innerHTML = `<p class="text-center py-8">Error loading chapter content.</p>`;
            this.app.showNotification("Failed to load chapter.", "error");
        }
    },

    formatChapterContent(chapterData) {
        const chapterText = chapterData.content || chapterData.text;
        if (chapterText && typeof chapterText === 'string') {
            return chapterText
                .split('\n')
                .filter(p => p.trim() !== '')
                .map(p => {
                    const words = p.trim().split(' ').map(word => `<span class="clickable-word">${word}</span>`).join(' ');
                    return `<p>${words}</p>`;
                })
                .join('');
        }
        return '<p class="text-center">This chapter appears to be empty.</p>';
    },

    addWordClickListener(container) {
        container.addEventListener('click', (e) => {
            if (e.target.classList.contains('clickable-word')) {
                let selectedText = e.target.textContent.trim().toLowerCase();
                selectedText = selectedText.replace(/^[^\w-]+|[^\w-]+$/g, ''); 

                if (selectedText && selectedText.length > 1 && !selectedText.includes(' ')) {
                    Dictionary.showDefinitionPopup(selectedText);
                }
            }
        });
    },
    
    applyReaderSettings() {
        const contentElements = [
            document.getElementById('reader-content'),
            document.getElementById('reading-mode-content')
        ];
        contentElements.forEach(content => {
            if (content) {
                content.style.fontFamily = this.readerSettings.fontFamily;
            }
        });
    },
    
    changeFontFamily(fontFamily) {
        this.readerSettings.fontFamily = fontFamily;
        this.applyReaderSettings();
        this.saveReaderSettings();
    },
    
    saveReaderSettings() {
        localStorage.setItem('readerSettings', JSON.stringify(this.readerSettings));
    },
    
    async enterReadingMode() {
        const readerModal = document.getElementById('reader-modal');
        const readingModeContainer = document.getElementById('reading-mode-container');
        const readingModeContent = document.getElementById('reading-mode-content');
        const originalContent = document.getElementById('reader-content').innerHTML;

        if (!readingModeContainer || !readingModeContent) return;

        // Copy content and apply settings
        readingModeContent.innerHTML = originalContent;
        this.applyReaderSettings();
        this.addWordClickListener(readingModeContent);

        // Show reading mode and hide modal
        readingModeContainer.classList.remove('hidden');
        readingModeContainer.classList.add('reading-mode-active');
        readerModal.classList.remove('show');
        
        // Load and render dictionary
        await Dictionary.loadUserWords();
        Dictionary.renderDictionary('reading-mode-dictionary');

        // Setup exit button
        document.getElementById('exit-reading-mode-btn').onclick = () => this.exitReadingMode();
    },

    exitReadingMode() {
        const readingModeContainer = document.getElementById('reading-mode-container');
        if (!readingModeContainer) return;

        readingModeContainer.classList.add('hidden');
        readingModeContainer.classList.remove('reading-mode-active');
        
        // Re-open the book in the standard modal view
        if (this.currentBookId) {
            this.openBook(this.currentBookId).then(() => {
                if (this.currentChapterId) {
                    this.loadChapter(this.currentBookId, this.currentChapterId);
                }
            });
        }
    },
    
    toggleEditMode(button, type, id1, id2 = null) {
        let titleElement;
        if (type === 'book') {
            titleElement = document.querySelector(`h4[data-book-id="${id1}"]`);
        } else { // chapter
            titleElement = document.querySelector(`a[data-chapter-id="${id2}"]`);
        }

        const isEditing = titleElement.isContentEditable;

        if (isEditing) {
            titleElement.contentEditable = false;
            button.textContent = '‚úèÔ∏è';
            titleElement.style.outline = 'none';
            titleElement.style.backgroundColor = 'transparent';
            if (type === 'book') titleElement.style.color = '#E0E0E0'; 
            else if(!titleElement.parentElement.parentElement.classList.contains('active')) titleElement.style.color = '#E0E0E0';

            const newTitle = titleElement.textContent.trim();
            this.saveTitle(type, id1, id2, newTitle);
        } else {
            titleElement.contentEditable = true;
            button.textContent = 'üíæ'; // Save icon
            titleElement.style.color = '#5a4429'; 
            titleElement.focus();
            
            const range = document.createRange();
            range.selectNodeContents(titleElement);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
    },

    async saveTitle(type, id1, id2, newTitle) {
        if (!newTitle) {
            this.app.showNotification("Title cannot be empty.", "error");
            if (type === 'book') this.openLibrary();
            else this.openBook(id1);
            return;
        }

        let docRef;
        if (type === 'book') {
            docRef = doc(this.app.db, 'books', id1);
        } else { // chapter
            docRef = doc(this.app.db, 'books', id1, 'chapters', id2);
        }

        try {
            await updateDoc(docRef, { title: newTitle });
            this.app.showNotification("Title updated successfully!", "success");
        } catch (error) {
            console.error("Error updating title:", error);
            this.app.showNotification("Error updating title.", "error");
            if (type === 'book') this.openLibrary();
            else this.openBook(id1);
        }
    }
};
window.Library = Library;


// =================================================================================
// MAGIC SHOP MODULE
// =================================================================================
const Shop = {
    app: null,

    open() {
        const studentName = this.app.currentPlayerName;
        if (!studentName) {
             this.app.showNotification("You must be linked to a student profile to shop. An admin can link your account.", "error");
             return;
        }
        
        const student = this.app.studentData[studentName];

        const itemsHTML = Object.entries(this.app.SHOP_ITEMS).map(([name, item]) => `
            <div class="flex items-center justify-between p-3 bg-[#0C1C33] rounded-lg border border-[#3D5568]">
                <div class="flex items-center gap-4">
                    <span class="text-3xl">${item.icon}</span>
                    <div>
                        <p class="font-bold">${name}</p>
                        <p class="text-sm text-gray-400">${item.desc}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold text-[#FFD700]">${item.cost} points</p>
                    <button class="btn btn-gold text-sm mt-1" onclick="Shop.buyItem('${studentName}', '${name}')" 
                        ${student.points < item.cost ? 'disabled' : ''}>
                        Buy
                    </button>
                </div>
            </div>
        `).join('');

        const content = `
            <p class="text-right mb-2">Your Points: <span class="font-bold text-xl text-[#FFD700]">${student.points}</span></p>
            <div class="space-y-3 max-h-96 overflow-y-auto p-1">${itemsHTML}</div>
        `;

        this.app.openModal('Diagon Alley Emporium', content, null);
    },

    buyItem(studentName, itemName) {
        this.app.requestPurchase(studentName, itemName);
    }
};
window.Shop = Shop;

// =================================================================================
// DUELING CLUB MODULE
// =================================================================================
const DuelingClub = {
    app: null,
    duelist1: null,
    duelist2: null,
    roundCount: 0,
    gameOver: false,
    isProcessing: false,
    isPaused: false,
    isFastMode: false,
    turnTimeout: null,
    currentCaster: null,
    currentTarget: null,
    WORDS_TO_HIGHLIGHT: ['damage', 'shield', 'heals', 'restores', 'victorious', 'fails', 'attempts', 'defensive', 'offensive', 'success', 'failure', 'blocks', 'broken', 'fades', 'backfires', 'potion', 'lucky'],

    DESCRIPTIONS: {
        cast: [
            "{caster} raises their wand and shouts, '{spellName}!'",
            "With a flick of their wrist, {caster} casts {spellName}!",
            "{caster} focuses their energy, unleashing {spellName} at {target}."
        ],
        hit: [
            "The spell strikes {target}, who staggers back, taking {damage} damage!",
            "A direct hit! {target} is blasted by the spell for {damage} damage.",
            "The curse finds its mark, inflicting {damage} damage upon {target}."
        ],
        miss: [
            "{caster}'s spell goes wide, missing {target} completely!",
            "{target} deftly dodges the incoming {spellName}!",
            "The spell fizzles out, failing to reach its target."
        ],
        crit_fail: [
            "A catastrophic failure! The spell {backfires} and explodes in {caster}'s face!",
            "The magic is unstable! {caster}'s own {spellName} turns against them!",
            "Disaster! The wand backfires, hitting {caster} with their own spell!"
        ],
        shield_block: [
            "{target}'s shield flares, absorbing {blocked} damage from the attack!",
            "The {spellName} impacts harmlessly against {target}'s magical barrier, blocking {blocked} damage."
        ],
        shield_break: [
            "The force of the spell is too much! {target}'s shield shatters!",
            "With a loud crack, the defensive barrier around {target} is {broken}!"
        ],
        heal: [
            "A warm glow surrounds {caster}, restoring {healedAmount} HP.",
            "{caster} mends their wounds with magic, healing for {healedAmount} HP."
        ],
        potion_heal: [
            "{caster} quickly drinks a potion, restoring {healedAmount} HP.",
            "The Wiggenweld Potion soothes {caster}'s injuries, healing for {healedAmount} HP."
        ],
        potion_mp: [
            "{caster} consumes a Focus Draught, restoring {restoredMp} MP.",
            "Energy flows back into {caster} as they drink the draught, restoring {restoredMp} MP."
        ]
    },

    getDuelLogEntry(type, context) {
        const templates = this.DESCRIPTIONS[type];
        if (!templates) return "An unknown action occurred.";
        
        let entry = templates[Math.floor(Math.random() * templates.length)];
        
        for (const key in context) {
            entry = entry.replace(new RegExp(`\\{${key}\\}`, 'g'), context[key]);
        }

        return entry;
    },

    openDuelSetup() {
        if (Object.keys(this.app.studentData).length < 2) {
            this.app.showNotification("Need at least two students to start a duel.", "error");
            return;
        }

        const studentOptions = Object.keys(this.app.studentData).sort();
        const content = `
            <span class="modal-close-btn" onclick="DuelingClub.closeDuelModal()">&times;</span>
            <div class="text-center mb-4">
                 <h3 class="font-magic-header text-3xl text-[#FFD700]">The Dueling Club</h3>
                 <p>Choose two students and a duel mode.</p>
            </div>
            <div class="flex justify-around items-center mb-6">
                <select id="duelist1-select" class="bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
                    ${studentOptions.map(s => `<option value="${s}">${s}</option>`).join('')}
                </select>
                <span class="font-magic-title text-2xl text-[#FFD700]">VS</span>
                <select id="duelist2-select" class="bg-[#2A3B4D] rounded p-2 border border-[#3D5568]">
                    ${studentOptions.map((s, i) => `<option value="${s}" ${i === 1 ? 'selected' : ''}>${s}</option>`).join('')}
                </select>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                 <button id="start-duel-btn" class="btn btn-gold text-lg">üìú Begin Duel!</button>
                 <button id="start-fast-duel-btn" class="btn bg-blue-600 text-white text-lg">‚ö° Fast Duel</button>
            </div>
        `;
        
        const modal = document.getElementById('duel-modal');
        const modalContent = modal.querySelector('#duel-modal-content');
        modalContent.innerHTML = content;
        
        modal.classList.add('show');
        modal.querySelector('#start-duel-btn').addEventListener('click', () => this.startDuel(false));
        modal.querySelector('#start-fast-duel-btn').addEventListener('click', () => this.startDuel(true));
    },

    closeDuelModal() {
        clearTimeout(this.turnTimeout);
        document.getElementById('duel-modal').classList.remove('show');
        this.duelist1 = null; this.duelist2 = null;
    },

    startDuel(isFastMode = false) {
        const d1Name = document.getElementById('duelist1-select').value;
        const d2Name = document.getElementById('duelist2-select').value;

        if (d1Name === d2Name) {
            this.app.showNotification("A duelist cannot fight themself!", "error");
            return;
        }
        
        this.duelPlaySound(this.app.SOUNDS.duel_start);

        this.duelist1 = this.createDuelistState(d1Name);
        this.duelist2 = this.createDuelistState(d2Name);
        this.roundCount = 0;
        this.gameOver = false;
        this.isProcessing = false;
        this.isPaused = false;
        this.isFastMode = isFastMode;
        this.currentCaster = this.duelist1;
        this.currentTarget = this.duelist2;
        
        this.renderDuelArena();
        this.log(`A duel begins between ${d1Name} and ${d2Name}!`);
        
        if (this.isFastMode) {
            this.continueFastDuel();
        } else {
            this.log(`It's ${this.currentCaster.name}'s turn.`, 'yellow');
        }
    },
    
    createDuelistState(name) {
        const student = this.app.studentData[name];
        // Deep copy of inventory to avoid modifying original data during duel
        const inventoryCopy = student.inventory ? JSON.parse(JSON.stringify(student.inventory)) : [];
        return {
            name: name,
            house: this.app.currentAssignments[name] || 'Unsorted',
            hp: student.hp, maxHp: this.app.DEFAULT_HP,
            mp: student.mp, maxMp: this.app.DEFAULT_MP,
            shield: null, statusEffects: {},
            inventory: inventoryCopy,
            effects: {}
        };
    },

    renderDuelArena() {
        let controlsHTML = '';
        if (this.isFastMode) {
            controlsHTML = `<button id="pause-resume-btn" class="btn btn-gold">Pause</button>`;
        } else {
            controlsHTML = `<button id="make-move-btn" class="btn btn-gold">Make a Move</button>`;
        }

        const content = `
            <span class="modal-close-btn" onclick="DuelingClub.closeDuelModal()">&times;</span>
            <div id="duel-arena" class="p-4 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div id="duelist1-panel" class="duelist-panel bg-[#0C1C33] p-4 rounded-lg border border-gray-600"></div>
                    <div class="bg-[#0C1C33] p-4 rounded-lg border border-gray-600 flex flex-col justify-center items-center">
                        <h4 class="font-magic-header text-xl text-center text-[#FFD700] mb-2">üìú Duel Log üìú</h4>
                        <div id="duel-log" class="h-64 w-full overflow-y-auto text-sm space-y-2 pr-2 mb-4"></div>
                        <div id="d20-dice"><div id="d20-cube"><div id="d20-face-display" class="d20-face">20</div></div></div>
                        <p id="roll-target-text" class="text-sm text-gray-400 mt-2 h-4"></p>
                    </div>
                    <div id="duelist2-panel" class="duelist-panel bg-[#0C1C33] p-4 rounded-lg border border-gray-600"></div>
                </div>
                <div id="duel-controls" class="text-center mt-4 h-10">
                    ${controlsHTML}
                </div>
            </div>
        `;
        const modalContent = document.getElementById('duel-modal-content');
        modalContent.innerHTML = content;
        
        if (this.isFastMode) {
            modalContent.querySelector('#pause-resume-btn').addEventListener('click', () => this.togglePause());
        } else {
            modalContent.querySelector('#make-move-btn').addEventListener('click', () => this.makeMove());
        }

        this.updateDuelUI();
    },

    makeMove() {
        if (this.isProcessing || this.gameOver) return;
        this.isProcessing = true;
        this.updateDuelUI(); // This will disable the button
        this.processTurn();
    },

    togglePause() {
        this.isPaused = !this.isPaused;
        const btn = document.getElementById('pause-resume-btn');
        if (this.isPaused) {
            btn.textContent = 'Resume';
            this.log('Duel paused.', 'yellow');
            clearTimeout(this.turnTimeout);
        } else {
            btn.textContent = 'Pause';
            this.log('Duel resuming...', 'yellow');
            this.continueFastDuel();
        }
    },
    
    updateDuelUI() {
        if (!this.duelist1) return;
        const renderPanel = (duelist, panelId) => {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            const house = this.app.HOUSES[duelist.house] || {};
            const statusText = Object.keys(duelist.statusEffects).length > 0 ?
                Object.keys(duelist.statusEffects).map(k => `${k}(${duelist.statusEffects[k].duration})`).join(', ') : 'Normal';

            const inventoryText = duelist.inventory.map(itemName => {
                const item = this.app.SHOP_ITEMS[itemName];
                return `<span title="${item.desc}">${item.icon}</span>`;
            }).join(' ');
            
            const felixText = (duelist.effects.guaranteed_hit && duelist.effects.guaranteed_hit.duration > 0) ? 
                `<p class="text-sm text-yellow-300">‚ú® Lucky (${duelist.effects.guaranteed_hit.duration})</p>` : '';

            let panelHTML = `
                <h4 class="font-bold text-lg" style="color:${house.color}">${house.animal} ${duelist.name}</h4>
                <div class="my-2">
                    <p>HP: ${duelist.hp} / ${duelist.maxHp}</p>
                    <div class="progress-bar"><div class="progress-bar-inner bg-red-500" style="width:${(duelist.hp/duelist.maxHp)*100}%"></div></div>
                </div>
                <div class="my-2">
                    <p>MP: ${duelist.mp} / ${duelist.maxMp}</p>
                    <div class="progress-bar"><div class="progress-bar-inner bg-blue-500" style="width:${(duelist.mp/duelist.maxMp)*100}%"></div></div>
                </div>
                <p class="text-sm">Status: <span class="text-yellow-400">${statusText}</span></p>
                ${duelist.shield ? `<p class="text-sm text-cyan-400">Shield: ${duelist.shield.name} (${duelist.shield.strength})</p>` : ''}
                ${felixText}
                <p class="text-sm mt-1">Inventory: ${inventoryText || 'Empty'}</p>
            `;
            if (this.currentCaster === duelist && !this.isProcessing && !this.gameOver && !this.isFastMode && duelist.inventory.length > 0) {
                panelHTML += `<div class="mt-2">
                    <button class="btn text-sm bg-green-600 text-white" onclick="DuelingClub.openItemMenu()">Use Item</button>
                </div>`;
            }
            panel.innerHTML = panelHTML;
        };
        renderPanel(this.duelist1, 'duelist1-panel');
        renderPanel(this.duelist2, 'duelist2-panel');

        if (!this.isFastMode) {
            const makeMoveBtn = document.getElementById('make-move-btn');
            if (makeMoveBtn) {
                makeMoveBtn.disabled = this.isProcessing || this.gameOver;
            }
        }
    },
    
    highlightWords(text) {
        let newText = text;
        this.WORDS_TO_HIGHLIGHT.forEach(word => {
            const regex = new RegExp(`\\b(${word})\\b`, 'gi');
            newText = newText.replace(regex, `<span class="learn-word">$1</span>`);
        });
        return newText;
    },

    log(message, color = '#E0E0E0') {
        const logContainer = document.getElementById('duel-log');
        if (!logContainer) return;
        const entry = document.createElement('p');
        entry.innerHTML = this.highlightWords(message);
        entry.style.color = color;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
    },
    
    continueFastDuel() {
        if (this.gameOver || this.isPaused) return;
        
        this.isProcessing = true;
        this.processTurn();
    },

    processTurn() {
        if (this.gameOver) return;

        const caster = this.currentCaster;
        const target = this.currentTarget;

        document.querySelectorAll('.duelist-panel').forEach(p => p.classList.remove('active-turn'));
        document.getElementById(caster === this.duelist1 ? 'duelist1-panel' : 'duelist2-panel').classList.add('active-turn');

        if (caster === this.duelist1) {
            this.roundCount++;
            this.log(`\n--- Round ${this.roundCount} ---`, '#C0C0C0');
            this.tickEffects(this.duelist1);
            this.tickEffects(this.duelist2);
            if (this.checkGameOver()) { this.isProcessing = false; return; }
        }
        
        this.updateDuelUI(); 

        const executeAction = () => {
            // NEW: Check for debilitating status effects
            if (caster.statusEffects.stun) {
                this.log(`${caster.name} is stunned and cannot move!`, 'orange');
                this.endTurn();
                return;
            }
            if (caster.statusEffects.control) {
                this.log(`${caster.name} is controlled by the Imperius Curse and attacks themself!`, '#f472b6');
                this.executeSpell(caster, caster, "Stupefy"); // Casts a generic spell on themself
                this.endTurn();
                return;
            }
            if (caster.statusEffects.confuse && Math.random() < 0.5) {
                this.log(`${caster.name} is confused and misses their turn!`, 'orange');
                this.endTurn();
                return;
            }

            // In Fast Mode, AI considers using a potion
            if (this.isFastMode && this.considerUsingPotion()) {
                if (this.checkGameOver()) { this.isProcessing = false; return; }
                this.endTurn();
                return;
            }

            const spellName = this.chooseSpell(caster);
            const spell = this.app.SPELL_DETAILS[spellName];
            
            if (spellName === "Struggle") {
                this.log(`${caster.name} is silenced and cannot cast spells! They struggle futilely.`, 'gray');
                this.endTurn();
                return;
            }
            
            this.log(this.getDuelLogEntry('cast', { caster: caster.name, target: target.name, spellName }));
            
            const rollTargetText = document.getElementById('roll-target-text');
            if(rollTargetText) rollTargetText.textContent = `Roll Target: ${spell.accuracy}+`;
            
            // *** NEW: Check for Felix Felicis effect ***
            if (caster.effects.guaranteed_hit && caster.effects.guaranteed_hit.duration > 0) {
                this.log(`${caster.name} is under the effect of Felix Felicis!`, '#FFD700');
                caster.effects.guaranteed_hit.duration--;
                
                // Animate the dice to show 20
                this.animateD20(() => {
                    this.log(`d20 Roll: 20. Critical Success!`, '#FFD700');
                    this.executeSpell(caster, target, spellName);
                    
                    if (caster.effects.guaranteed_hit.duration <= 0) {
                        delete caster.effects.guaranteed_hit;
                        this.log('The luck of Felix Felicis wears off.', 'cyan');
                    }
                    
                    if (this.checkGameOver()) { this.isProcessing = false; return; }
                    this.endTurn();
                }, 21, 20); // accuracy > 20 to force success style, force result to 20
                return; // Skip normal roll
            }
            
            // Normal roll if not lucky
            this.animateD20((rollResult) => {
                // Modified to check against effect_chance for status spells
                const success = rollResult >= spell.accuracy;
                const effectSuccess = spell.effect_chance ? rollResult >= spell.effect_chance : success;
                const critFail = rollResult === 1;

                if (critFail) {
                    this.log(this.getDuelLogEntry('crit_fail', { caster: caster.name, spellName }), '#f472b6');
                    this.duelPlaySound(this.app.SOUNDS.crit_fail_sound);
                    if (spell.type.includes('offensive')) {
                        this.executeSpell(caster, caster, spellName, true); // Target self, always succeed on backfire
                    } else {
                        this.log(`The ${spellName} spell erupts in harmless sparks.`, 'gray');
                    }
                } else if (success) {
                    this.log(`d20 Roll: ${rollResult}. Success!`, '#34D399');
                    this.executeSpell(caster, target, spellName, effectSuccess);
                } else {
                    this.log(`d20 Roll: ${rollResult}. Failure!`, '#F87171');
                    this.log(this.getDuelLogEntry('miss', { caster: caster.name, target: target.name, spellName }), 'gray');
                    this.duelPlaySound(this.app.SOUNDS.duel_miss);
                }
                
                if (this.checkGameOver()) { this.isProcessing = false; return; }
                this.endTurn();
            }, spell.accuracy);
        };

        const delay = this.isFastMode ? 200 : 1500;
        this.turnTimeout = setTimeout(executeAction, delay);
    },

    endTurn() {
        this.updateDuelUI();

        if (this.checkGameOver()) {
            this.isProcessing = false;
            return;
        }

        const nextCaster = this.currentTarget;
        const nextTarget = this.currentCaster;
        this.currentCaster = nextCaster;
        this.currentTarget = nextTarget;
        
        const isEndOfRound = this.currentTarget === this.duelist1;
        if (isEndOfRound) {
            this.currentCaster.mp = Math.min(this.currentCaster.maxMp, this.currentCaster.mp + 5);
            this.currentTarget.mp = Math.min(this.currentTarget.maxMp, this.currentTarget.mp + 5);
            this.log('End of round. Duelists recover some energy.');
            this.updateDuelUI();
        }

        if (this.isFastMode) {
            const delay = isEndOfRound ? 1000 : 500;
            this.turnTimeout = setTimeout(() => this.continueFastDuel(), delay);
        } else {
            this.isProcessing = false;
            this.updateDuelUI();
            this.log(`It's now ${this.currentCaster.name}'s turn.`, 'yellow');
        }
    },

    animateD20(callback, accuracy, forceResult = null) {
        this.duelPlaySound(this.app.SOUNDS.dice_roll, 0.05);
        const cube = document.getElementById('d20-cube');
        const face = document.getElementById('d20-face-display');
        if (!cube || !face) { if (callback) callback(forceResult || Math.ceil(Math.random() * 20)); return; }

        face.classList.remove('success', 'failure', 'crit-fail', 'crit-success');
        cube.classList.add('rolling');

        let rollInterval;
        if (!this.isFastMode) {
            rollInterval = setInterval(() => {
                if (this.isPaused) return;
                face.textContent = Math.ceil(Math.random() * 20);
            }, 50);
        }

        const animationDuration = this.isFastMode ? 100 : 1000;
        setTimeout(() => {
            if(rollInterval) clearInterval(rollInterval);
            cube.classList.remove('rolling');
            const finalResult = forceResult !== null ? forceResult : Math.ceil(Math.random() * 20);
            face.textContent = finalResult;
            if (finalResult === 20) {
                face.classList.add('crit-success');
            } else if (finalResult === 1) {
                face.classList.add('crit-fail');
            } else if (finalResult >= accuracy) {
                face.classList.add('success');
            } else {
                face.classList.add('failure');
            }
            if (callback) callback(finalResult);
        }, animationDuration);
    },

    tickEffects(duelist) {

        for (const effect in duelist.statusEffects) {
            const status = duelist.statusEffects[effect];
            if (status.dot_dmg) {
                const dotDamage = status.dot_dmg;
                duelist.hp = Math.max(0, duelist.hp - dotDamage);
                this.log(`${duelist.name} takes ${dotDamage} damage from ${effect}!`, 'red');
            }
        }

        for (const effect in duelist.statusEffects) {
            duelist.statusEffects[effect].duration--;
            if (duelist.statusEffects[effect].duration <= 0) {
                this.log(`${duelist.name} is no longer affected by ${effect}.`, 'cyan');
                delete duelist.statusEffects[effect];
            }
        }
        if (duelist.shield) {
            duelist.shield.duration--;
            if (duelist.shield.duration <= 0) {
                this.log(`${duelist.shield.name} on ${duelist.name} fades.`, 'cyan');
                duelist.shield = null;
            }
        }
        this.updateDuelUI();
    },

    chooseSpell(duelist) {
        const availableSpells = Object.keys(this.app.SPELL_DETAILS).filter(s => {
            const spell = this.app.SPELL_DETAILS[s];
            return spell.mp <= duelist.mp && !duelist.statusEffects.silence;
        });
        if (availableSpells.length === 0) return "Struggle"; 
        
        // Let the Felix Felicis check in processTurn handle the powerful spell logic
        return availableSpells[Math.floor(Math.random() * availableSpells.length)];
    },

    executeSpell(caster, target, spellName, effectSuccess = true) {
        const spell = this.app.SPELL_DETAILS[spellName];
        if (!spell) return;

        // Don't consume MP if spell doesn't exist (e.g., self-attack from control)
        if (this.app.SPELL_DETAILS[spellName]) {
            if (caster.mp < spell.mp) {
                this.log(`${caster.name} lacks the mana!`, 'gray');
                return;
            }
            caster.mp -= spell.mp;
        }

        this.duelPlaySound(this.app.SOUNDS.spell_cast_ui, 0.05);

        // --- NEW: Handle Status Effect Application ---
        if (spell.effect && effectSuccess) {
            const statusEffect = {
                duration: spell.duration,
                dot_dmg: spell.dot_dmg || 0
            };
            target.statusEffects[spell.effect] = statusEffect;
            this.log(`${target.name} is now affected by ${spell.effect}!`, 'orange');
        }

        // --- Handle Specific Spell Types ---
        if (spell.type === 'heal') {
            const healAmount = spell.base_heal;
            caster.hp = Math.min(caster.maxHp, caster.hp + healAmount);
            this.log(this.getDuelLogEntry('heal', {caster: caster.name, healedAmount: healAmount}), 'lightgreen');
        } else if (spell.type === 'shield') {
            caster.shield = { name: spellName, strength: spell.strength, duration: spell.duration };
            this.log(`${caster.name} creates a defensive shield, ${spellName}!`, 'cyan');
        } else if (spell.type === 'counter_utility') {
            target.statusEffects = {};
            target.shield = null;
            this.log(`${caster.name}'s Finite Incantatem dispels all magical effects on ${target.name}!`, 'lightblue');
        } else if (spell.type.includes('offensive')) {
            let damage = spell.base_dmg || 0;
            if (damage > 0) {
                let finalDamage = damage;
                
                if (target.shield) {
                    const blocked = Math.min(target.shield.strength, damage);
                    finalDamage -= blocked;
                    target.shield.strength -= blocked;
                    this.log(this.getDuelLogEntry('shield_block', {target: target.name, spellName, blocked}), 'cyan');

                    if (target.shield.strength <= 0) {
                        this.log(this.getDuelLogEntry('shield_break', {target: target.name}), 'red');
                        target.shield = null;
                        this.duelPlaySound(this.app.SOUNDS.shield_break);
                    } else {
                        this.duelPlaySound(this.app.SOUNDS.duel_block);
                    }
                }
                
                if (finalDamage > 0) {
                    target.hp = Math.max(0, target.hp - finalDamage);
                    this.log(this.getDuelLogEntry('hit', {target: target.name, damage: finalDamage}), 'red');
                    this.duelPlaySound(this.app.SOUNDS.duel_hit);
                }
            }
        }
        this.updateDuelUI();
    },
    
    checkGameOver() {
        if (this.gameOver) return true;
        let winner = null, loser = null;
        if (this.duelist1.hp <= 0) {
            winner = this.duelist2;
            loser = this.duelist1;
        } else if (this.duelist2.hp <= 0) {
            winner = this.duelist1;
            loser = this.duelist2;
        }

        if (winner) {
            this.gameOver = true;
            this.isProcessing = false;
            clearTimeout(this.turnTimeout);
            this.log(`--- DUEL OVER! ---`, '#FFD700');
            this.log(`${winner.name} of ${winner.house} is victorious!`, '#FFD700');
            this.duelPlaySound(this.app.SOUNDS.celebration);
            
            // This 'if' block handles saving health/mana and history, but no longer awards points.
            if (this.app.isAdmin) {
                this.log('Both duelists have been fully healed.', 'lightgreen');
                // this.app.HOUSES[winner.house].points += 10; // REMOVED
                // this.log(`${winner.house} is awarded 10 points!`, '#FFD700'); // REMOVED

                this.app.studentData[winner.name].hp = this.app.DEFAULT_HP;
                this.app.studentData[winner.name].mp = this.app.DEFAULT_MP;
                
                this.app.studentData[loser.name].hp = this.app.DEFAULT_HP;
                this.app.studentData[loser.name].mp = this.app.DEFAULT_MP;
                
                // History log is updated to no longer mention points.
                this.app.addHistory(`Dueling Club: ${winner.name} defeated ${loser.name}.`, `Duel concluded. Health restored.`);
                this.app.saveProgress();
            }

            const controls = document.getElementById('duel-controls');
            if (controls) {
                // The controls are replaced with a message and a button to start a new duel.
                controls.innerHTML = `
                    <p class="text-xl font-bold text-green-400 mb-2">${winner.name} wins!</p>
                    <button class="btn btn-gold" onclick="DuelingClub.openDuelSetup()">New Duel</button>
                `;
            }
            
            // The automatic timeout to close the modal has been removed.
            // this.turnTimeout = setTimeout(() => this.closeDuelModal(), 4000); // REMOVED
            return true;
        }
        return false;
    },

    openItemMenu() {
        if (this.isPaused || this.isProcessing) return;
        this.isProcessing = true; // Pause turn progression
        
        const caster = this.currentCaster;
        const itemsHTML = caster.inventory.map(itemName => {
            const item = this.app.SHOP_ITEMS[itemName];
            return `<button class="btn btn-gold w-full text-left p-2" onclick="DuelingClub.useItem('${itemName}')">
                <span class="text-xl">${item.icon}</span> ${itemName}
            </button>`;
        }).join('');

        const logContainer = document.getElementById('duel-log');
        const itemMenu = document.createElement('div');
        itemMenu.id = 'item-menu';
        itemMenu.className = 'p-2 border border-yellow-400 rounded bg-black/50';
        itemMenu.innerHTML = `
            <h5 class="text-center font-bold mb-2">Use Item</h5>
            <div class="space-y-2">${itemsHTML || '<p class="text-gray-400">No items.</p>'}</div>
            <button class="btn bg-gray-600 w-full mt-2" onclick="DuelingClub.closeItemMenu()">Cancel</button>
        `;
        logContainer.appendChild(itemMenu);
        logContainer.scrollTop = logContainer.scrollHeight;
        this.updateDuelUI();
    },

    closeItemMenu() {
        const menu = document.getElementById('item-menu');
        if (menu) menu.remove();
        this.log('Decided not to use an item.');
        this.isProcessing = false;
        this.updateDuelUI();
    },

    useItem(itemName) {
        const menu = document.getElementById('item-menu');
        if (menu) menu.remove();

        const caster = this.currentCaster;
        this.executeItem(caster, itemName);
        
        this.endTurn();
    },
    
    executeItem(caster, itemName) {
        const item = this.app.SHOP_ITEMS[itemName];
        const itemIndex = caster.inventory.indexOf(itemName);

        if (itemIndex === -1) {
            this.log("Item not found!", 'red');
            return false;
        }

        this.log(`${caster.name} uses ${itemName}!`, 'lightblue');
        this.duelPlaySound(this.app.SOUNDS.potion_use);
        caster.inventory.splice(itemIndex, 1);

        const effect = item.effect;
        switch (effect.type) {
            case 'heal':
                const healedAmount = Math.min(caster.maxHp - caster.hp, effect.amount);
                caster.hp += healedAmount;
                this.log(this.getDuelLogEntry('potion_heal', {caster: caster.name, healedAmount: healedAmount}), 'lightgreen');
                break;
            case 'mp_restore':
                const restoredMp = Math.min(caster.maxMp - caster.mp, effect.amount);
                caster.mp += restoredMp;
                this.log(this.getDuelLogEntry('potion_mp', {caster: caster.name, restoredMp: restoredMp}), 'lightblue');
                break;
            case 'guaranteed_hit':
                caster.effects.guaranteed_hit = { duration: effect.duration };
                this.log(`The next ${effect.duration} spell rolls are now guaranteed critical successes!`, '#FFD700');
                break;
            case 'add_shield':
                caster.shield = { name: effect.name, strength: effect.strength, duration: effect.duration };
                this.log(`${caster.name} is now protected by a shield of ${effect.strength} strength!`, 'cyan');
                break;
        }
        return true;
    },

    considerUsingPotion() {
        const caster = this.currentCaster;
        // Heal if HP is below 40%
        if (caster.hp < caster.maxHp * 0.4 && caster.inventory.includes("Wiggenweld Potion")) {
            return this.executeItem(caster, "Wiggenweld Potion");
        }
        // Use shield if caster has no shield and target is healthy
        if (!caster.shield && this.currentTarget.hp > this.currentTarget.maxHp * 0.5 && caster.inventory.includes("Shielding Brew")) {
            return this.executeItem(caster, "Shielding Brew");
        }
        // NEW: Use Felix Felicis if not in immediate danger and doesn't already have the effect
        if (caster.hp > caster.maxHp * 0.5 && !caster.effects.guaranteed_hit && caster.inventory.includes("Felix Felicis (Dose)")) {
            return this.executeItem(caster, "Felix Felicis (Dose)");
        }
        // Restore MP if below 15
        if (caster.mp < 15 && caster.inventory.includes("Focus Draught")) {
            return this.executeItem(caster, "Focus Draught");
        }
        return false; // No item was used
    },

    duelPlaySound(...args) {
        if (!this.isFastMode) {
            this.app.playSound(...args);
        }
    }
};

window.DuelingClub = DuelingClub;

// =================================================================================
// QUIDDITCH D&D MODULE (UPGRADED GM AI)
// =================================================================================
const Quidditch = {
    app: null,
    isProcessing: false,
    chatHistory: [],
    gameState: {},
    GROQ_API_KEY: null,

    openGame() {
        const modal = document.getElementById('quidditch-modal');
        const modalContent = document.getElementById('quidditch-modal-content');
        modal.classList.add('show');
        
        this.GROQ_API_KEY = localStorage.getItem('groqApiKey');

        if (this.GROQ_API_KEY) {
            this.renderGameUI(modalContent);
            this.startGame();
        } else {
            this.renderApiKeySetup(modalContent);
        }
    },

    renderApiKeySetup(container) {
        const currentKey = this.GROQ_API_KEY || '';
        container.innerHTML = `
            <span class="modal-close-btn" onclick="Quidditch.closeGame()">&times;</span>
            <div class="flex flex-col items-center justify-center h-full">
                <h3 class="font-magic-header text-3xl text-center text-[#FFD700]">Quidditch Commentary Setup</h3>
                <p class="text-center my-4 text-gray-300">To power the magical commentary box, please provide your Groq API key. This is a free key you can get from the Groq website.</p>
                <div class="w-full max-w-md">
                    <label for="groq-api-key" class="block mb-2 text-sm font-medium text-gray-300">Your Groq API Key</label>
                    <input type="password" id="groq-api-key" placeholder="gsk_..." class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568]" value="${currentKey}">
                    <button class="btn btn-gold w-full mt-4" onclick="Quidditch.saveApiKey()">Save API Key</button>
                    <a href="https://console.groq.com/keys" target="_blank" class="block text-center mt-2 text-sm text-[#FFD700] hover:underline">Get a Groq API Key</a>
                </div>
            </div>
        `;
    },

    saveApiKey() {
        const keyInput = document.getElementById('groq-api-key');
        const key = keyInput.value.trim();
        if (key) {
            localStorage.setItem('groqApiKey', key);
            this.GROQ_API_KEY = key;
            this.app.showNotification("API Key saved!", "success");
            this.openGame();
        } else {
            this.app.showNotification("Please enter a valid API key.", "error");
        }
    },

    renderGameUI(container) {
        container.innerHTML = `
            <span class="modal-close-btn" onclick="Quidditch.closeGame()">&times;</span>
            <div class="flex flex-col h-[85vh]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-magic-header text-3xl text-center text-[#FFD700]">Quidditch Match</h3>
                    <div class="flex items-center gap-2">
                         <div id="quidditch-scoreboard" class="font-bold text-xl text-white"></div>
                         <button class="btn bg-gray-600 text-xs p-2" onclick="Quidditch.renderApiKeySetup(document.getElementById('quidditch-modal-content'))" title="Change API Key">‚öôÔ∏è</button>
                    </div>
                </div>
                
                <!-- Chat/Narrative Display -->
                <div id="quidditch-chat-display" class="flex-grow bg-[#0C1C33] p-4 rounded-lg border border-[#3D5568] mb-4 overflow-y-auto flex flex-col">
                    <!-- Messages will be injected here -->
                </div>
                
                <!-- Player Controls -->
                <div class="flex-shrink-0 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Action Buttons -->
                    <div class="md:col-span-1 space-y-2">
                        <button class="btn btn-gold w-full" onclick="Quidditch.performAction('Try to score with the Quaffle')">Score with Quaffle</button>
                        <button class="btn btn-gold w-full" onclick="Quidditch.performAction('Search for the Golden Snitch')">Search for Snitch</button>
                        <button class="btn btn-gold w-full" onclick="Quidditch.performAction('Hit a Bludger at an opponent')">Hit a Bludger</button>
                        <button class="btn btn-gold w-full" onclick="Quidditch.performAction('Defend the goalposts')">Defend Goals</button>
                    </div>
                    
                    <!-- Custom Action & Dice -->
                    <div class="md:col-span-2 bg-[#1A2B3C] p-4 rounded-lg border border-[#3D5568] flex flex-col justify-between">
                        <input type="text" id="quidditch-custom-action" placeholder="Or type your own action..." class="w-full bg-[#2A3B4D] rounded p-2 border border-[#3D5568] mb-2">
                        <div class="flex items-center justify-between">
                            <div id="quidditch-dice-container">
                                <div id="quidditch-dice">
                                    <div id="quidditch-dice-face" class="quidditch-dice-face">20</div>
                                </div>
                            </div>
                            <button id="quidditch-roll-btn" class="btn bg-green-600 text-white text-lg flex-grow ml-4" onclick="Quidditch.performAction()">Roll d20 & Act!</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add event listener for Enter key
        container.querySelector('#quidditch-custom-action').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default Enter behavior
                this.performAction();
            }
        });
    },

    closeGame() {
        document.getElementById('quidditch-modal').classList.remove('show');
    },

    startGame() {
        this.isProcessing = false;
        this.gameState = {
            score: { player: 0, opponent: 0 },
            possession: 'neutral',
            snitchSpotted: false,
            turn: 0,
            weather: 'clear'
        };
        
        const systemPrompt = `You are the "Quidditch Commentary Box AI," controlling a duo of commentators: Lee, who is very biased and excited for the player's team, and Gwenog, a calm professional ex-player. You are also the game master. Your task is to:
1. Narrate the outcome of the player's action based on their roll and the current game state. The commentary should be a back-and-forth between Lee and Gwenog. Be exciting and descriptive.
2. Introduce random events. A Bludger attack, a foul, a change in weather, a brilliant move by a teammate, etc.
3. Update the game state. At the VERY END of your commentary, you MUST include ONE special tag on a NEW LINE to update the game.

**Game State Tags (CHOOSE ONLY ONE PER RESPONSE):**
- [SCORE PLAYER 10]
- [SCORE OPPONENT 10]
- [POSSESSION PLAYER]
- [POSSESSION OPPONENT]
- [SNITCH SPOTTED]
- [SNITCH CAUGHT PLAYER]
- [EVENT BLUDGER_ATTACK]
- [NO_CHANGE]

**CRITICAL RULES:**
1. Do NOT answer any non-Quidditch questions. If the user asks something unrelated to the match, you MUST redirect them back to the game. Example: "Lee: No time for that, look out! A Bludger is heading your way! What do you do?"
2. Do NOT include the "Current Game State" JSON object in your response. Your response should ONLY be the commentary from Lee and Gwenog, followed by a single game state tag on a new line.

**Example Interaction:**
Player Action: "Try to score with the Quaffle", Roll: 18
Game State: { "score": { "player": 10, "opponent": 10 }, "possession": "player" }
Your Response:
Lee: "And they're off! A brilliant dodge past the opponent's Chaser! This is it!"
Gwenog: "Textbook form. They see the opening, they take the shot... GOAL! A fantastic play, putting them ahead."
[SCORE PLAYER 10]`;

        const openingLine = "Lee: Welcome back to the Hogwarts Pitch! The players are taking their positions, and the energy here is electric! \nGwenog: It's a fine day for a match, Lee. Let's see which team has the edge today. \nLee: The whistle blows! What's your first move?";

        this.chatHistory = [
            { role: "system", content: systemPrompt },
            { role: "assistant", content: openingLine }
        ];
        
        const chatDisplay = document.getElementById('quidditch-chat-display');
        if(chatDisplay) chatDisplay.innerHTML = '';
        this.addMessage(openingLine, "ai");
        this.updateScoreboard();
    },

    updateScoreboard() {
        const scoreboard = document.getElementById('quidditch-scoreboard');
        if (scoreboard) {
            scoreboard.innerHTML = `YOU: ${this.gameState.score.player} - OPP: ${this.gameState.score.opponent}`;
        }
    },

    addMessage(text, sender, rollResult = null) {
        const chatDisplay = document.getElementById('quidditch-chat-display');
        if (!chatDisplay) return;

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('quidditch-chat-message');
        
        let content = ``;
        if (sender === 'user') {
            messageDiv.classList.add('user-message');
            content = `<p class="font-bold">You (Rolled ${rollResult}):</p><p>${text}</p>`;
        } else if (sender === 'ai') {
            messageDiv.classList.add('ai-message');
            // Make commentator names bold
            let formattedText = text.replace(/^(Lee:)/gm, '<strong class="text-yellow-300">Lee:</strong>');
            formattedText = formattedText.replace(/^(Gwenog:)/gm, '<strong class="text-cyan-300">Gwenog:</strong>');
            content = `<div>${formattedText.replace(/\n/g, '<br>')}</div>`;
        } else { // 'event'
             messageDiv.classList.add('event-message');
             content = `<p>${text}</p>`;
        }
        
        messageDiv.innerHTML = content;
        chatDisplay.appendChild(messageDiv);
        chatDisplay.scrollTop = chatDisplay.scrollHeight;
    },

    async performAction(predefinedAction = null) {
        if (this.isProcessing) return;
        this.isProcessing = true;
        this.toggleControls(false);

        const customActionInput = document.getElementById('quidditch-custom-action');
        const actionText = predefinedAction || customActionInput.value.trim();

        if (!actionText) {
            this.app.showNotification("You must specify an action!", "error");
            this.isProcessing = false;
            this.toggleControls(true);
            return;
        }

        const roll = await this.animateDice();
        this.addMessage(actionText, 'user', roll);
        customActionInput.value = '';

        this.getAIResponse(actionText, roll);
    },

    async getAIResponse(action, roll) {
        this.addMessage("The commentators watch intently...", "event");
        this.gameState.turn++;

        const currentActionPrompt = `Player Action: "${action}"\nd20 Roll: ${roll}\nCurrent Game State: ${JSON.stringify(this.gameState)}`;
        
        const messagesForAPI = [...this.chatHistory];
        messagesForAPI.push({ role: "user", content: currentActionPrompt });

        try {
            if (!this.GROQ_API_KEY) {
                 throw new Error("Groq API key is not set. Please set it up in the Quidditch modal.");
            }
            
            const apiUrl = 'https://api.groq.com/openai/v1/chat/completions';

            const payload = {
                model: "llama-3.3-70b-versatile",
                messages: messagesForAPI
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.GROQ_API_KEY}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("Groq API Error:", errorData);
                throw new Error(`API request failed: ${errorData.error.message}`);
            }

            const result = await response.json();
            
            if (result.choices && result.choices[0]?.message?.content) {
                const rawText = result.choices[0].message.content;
                
                this.chatHistory.push({ role: "user", content: currentActionPrompt });
                this.processAIResponse(rawText);
            } else {
                console.error("Invalid API Response:", result);
                throw new Error("API response was empty or malformed.");
            }

        } catch (error) {
            console.error("Error calling Groq API:", error);
            this.addMessage(`The magic connecting us to the commentary box seems to have failed. Error: ${error.message}. Please check the API key and console.`, "event");
        } finally {
            this.isProcessing = false;
            this.toggleControls(true);
        }
    },

    processAIResponse(rawText) {
        const tagMatch = rawText.match(/\[(.*?)\]/);
        let commentary = rawText;
        let tag = '[NO_CHANGE]';

        if (tagMatch) {
            commentary = rawText.replace(tagMatch[0], '').trim();
            tag = tagMatch[0];
        }

        this.addMessage(commentary, 'ai');
        this.chatHistory.push({ role: "assistant", content: rawText });

        // Update game state based on the tag
        const tagParts = tag.replace(/[\[\]]/g, '').split(' ');
        const command = tagParts[0];
        const subject = tagParts[1];
        const value = parseInt(tagParts[2], 10);

        switch(command) {
            case 'SCORE':
                if (subject === 'PLAYER') this.gameState.score.player += value;
                if (subject === 'OPPONENT') this.gameState.score.opponent += value;
                this.updateScoreboard();
                break;
            case 'POSSESSION':
                this.gameState.possession = subject.toLowerCase();
                break;
            case 'SNITCH':
                if (subject === 'SPOTTED') this.gameState.snitchSpotted = true;
                if (subject === 'CAUGHT' && subject === 'PLAYER') {
                    this.gameState.score.player += 150;
                    this.updateScoreboard();
                    this.addMessage("YOU'VE CAUGHT THE SNITCH! YOU WIN!", "event");
                    this.isProcessing = true; // End game
                    this.toggleControls(false);
                }
                break;
            case 'EVENT':
                // Could add specific logic for events like BLUDGER_ATTACK here
                break;
        }
    },

    animateDice() {
        return new Promise(resolve => {
            this.app.playSound(this.app.SOUNDS.dice_roll, 0.05);
            const dice = document.getElementById('quidditch-dice');
            const face = document.getElementById('quidditch-dice-face');
            if (!dice || !face) { resolve(Math.ceil(Math.random() * 20)); return; }

            dice.classList.add('rolling');
            
            const rollInterval = setInterval(() => {
                face.textContent = Math.ceil(Math.random() * 20);
            }, 60);

            setTimeout(() => {
                clearInterval(rollInterval);
                dice.classList.remove('rolling');
                const finalResult = Math.ceil(Math.random() * 20);
                face.textContent = finalResult;
                resolve(finalResult);
            }, 1000);
        });
    },

    toggleControls(enabled) {
        const rollBtn = document.getElementById('quidditch-roll-btn');
        const actionBtns = document.querySelectorAll('#quidditch-modal .btn');
        const input = document.getElementById('quidditch-custom-action');

        if (enabled) {
            rollBtn.disabled = false;
            rollBtn.innerHTML = 'Roll d20 & Act!';
            actionBtns.forEach(btn => btn.disabled = false);
            input.disabled = false;
        } else {
            rollBtn.disabled = true;
            rollBtn.innerHTML = '<div class="spinner mx-auto"></div>';
            actionBtns.forEach(btn => btn.disabled = true);
            input.disabled = true;
        }
    }
};
window.Quidditch = Quidditch;

// =================================================================================
// DICTIONARY TRAINING MODULE (IMPLEMENTED)
// =================================================================================
const DictionaryTraining = {
    app: null,
    gameActive: false,
    currentWords: [],
    score: 0,
    currentIndex: 0,
    timer: null,
    
    TRAINING_MODES: {
        'word-translation': { name: 'Word-Definition', icon: '‚ÜîÔ∏è', desc: 'Choose the correct word for the given definition.', minWords: 4 },
        'word-constructor': { name: 'Word Constructor', icon: 'üõ†Ô∏è', desc: 'Assemble the word from a scramble of letters.', minWords: 1 },
        'sprint': { name: 'Sprint', icon: 'üèÉ', desc: 'Quickly decide if the word and definition match.', minWords: 2 },
        'word-cards': { name: 'Word Cards', icon: 'üÉè', desc: 'Review words with classic flashcards.', minWords: 1 },
        'word-sprint': { name: 'Word Sprint (Brainstorm)', icon: 'üí®', desc: 'Type the correct word for the definition before time runs out.', minWords: 1 }
    },

    async openHub() {
        if (!this.app.userId) {
            this.app.showNotification("You must be logged in to train words.", "error");
            return;
        }
        await Dictionary.loadUserWords(); // Ensure we have the latest words
        const wordCount = Object.keys(Dictionary.userWords).length;

        const modal = document.getElementById('dictionary-training-modal');
        const modalContent = document.getElementById('dictionary-training-content');
        
        const hubHTML = Object.entries(this.TRAINING_MODES).map(([key, mode]) => {
            const disabled = wordCount < mode.minWords;
            return `
                <div class="training-hub-card p-4 rounded-lg flex items-center gap-4 ${disabled ? 'opacity-50 cursor-not-allowed' : ''}" 
                     onclick="${disabled ? '' : `DictionaryTraining.startGame('${key}')`}">
                    <div class="text-5xl">${mode.icon}</div>
                    <div>
                        <h4 class="font-bold text-lg text-yellow-300">${mode.name}</h4>
                        <p class="text-sm text-gray-300">${mode.desc}</p>
                        ${disabled ? `<p class="text-xs text-red-400">Requires at least ${mode.minWords} words in your dictionary.</p>` : ''}
                    </div>
                </div>
            `;
        }).join('');

        modalContent.innerHTML = `
            <span class="modal-close-btn" onclick="document.getElementById('dictionary-training-modal').classList.remove('show')">&times;</span>
            <h3 class="font-magic-header text-3xl text-center text-[#FFD700] mb-2">Dictionary Training Grounds</h3>
            <p class="text-center text-gray-400 mb-6">You have ${wordCount} words to practice. Choose your training method!</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2">
                ${hubHTML}
            </div>
        `;
        modal.classList.add('show');
    },

    startGame(gameType) {
        this.gameActive = true;
        this.score = 0;
        this.currentIndex = 0;
        this.currentWords = this.getWordsForTraining(20); // Limit to 20 words per session
        
        if (this.currentWords.length < this.TRAINING_MODES[gameType].minWords) {
            this.app.showNotification("Not enough words for this training.", "error");
            return;
        }
        
        document.getElementById('dictionary-training-modal').classList.remove('show');
        const gameModal = document.getElementById('training-game-modal');
        gameModal.classList.add('show');
        
        const gameContent = document.getElementById('training-game-content');
        gameContent.innerHTML = `<div class="flex justify-center items-center h-48"><div class="spinner"></div></div>`;
        
        switch(gameType) {
            case 'word-translation': this.setupWordTranslation(); break;
            case 'word-constructor': this.setupWordConstructor(); break;
            case 'sprint': this.setupSprint(); break;
            case 'word-cards': this.setupWordCards(); break;
            case 'word-sprint': this.setupWordSprint(); break;
        }
    },

    closeGame() {
        this.gameActive = false;
        if (this.timer) clearInterval(this.timer);
        document.getElementById('training-game-modal').classList.remove('show');
        this.openHub();
    },
    
    // ==== Word Translation ====
    setupWordTranslation() {
        if (this.currentIndex >= this.currentWords.length) {
            this.showGameResults();
            return;
        }
        const gameContent = document.getElementById('training-game-content');
        const currentWord = this.currentWords[this.currentIndex];
        
        const allWords = Object.keys(Dictionary.userWords);
        let options = [currentWord.word];
        while(options.length < 4) {
            const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
            if (!options.includes(randomWord)) {
                options.push(randomWord);
            }
        }
        this.shuffleArray(options);
        
        const optionsHTML = options.map(opt => `
            <button class="training-game-option p-4 rounded-lg text-lg capitalize" onclick="DictionaryTraining.checkWordTranslation(this, '${opt}', '${currentWord.word}')">${opt}</button>
        `).join('');
        
        gameContent.innerHTML = `
            <span class="modal-close-btn" onclick="DictionaryTraining.closeGame()">&times;</span>
            <div class="text-right text-sm mb-2">${this.currentIndex + 1} / ${this.currentWords.length} | Score: ${this.score}</div>
            <p class="text-center text-gray-300 mb-4">Choose the word for this definition:</p>
            <div class="bg-[#0C1C33] p-4 rounded-lg text-center min-h-[100px] flex items-center justify-center mb-6">
                <p>"${currentWord.definition}"</p>
            </div>
            <div id="translation-options" class="grid grid-cols-2 gap-4">
                ${optionsHTML}
            </div>
        `;
    },

    checkWordTranslation(button, selectedWord, correctWord) {
        document.querySelectorAll('#translation-options button').forEach(b => b.disabled = true);
        if (selectedWord === correctWord) {
            this.score++;
            button.classList.add('correct');
            this.app.playSound(this.app.SOUNDS.correct_answer);
        } else {
            button.classList.add('incorrect');
            this.app.playSound(this.app.SOUNDS.incorrect_answer);
            // Highlight the correct one
            document.querySelectorAll('#translation-options button').forEach(b => {
                if (b.textContent === correctWord) b.classList.add('correct');
            });
        }
        this.currentIndex++;
        setTimeout(() => this.setupWordTranslation(), 1500);
    },

    // ==== Word Constructor ====
    setupWordConstructor() {
        if (this.currentIndex >= this.currentWords.length) {
            this.showGameResults();
            return;
        }
        const gameContent = document.getElementById('training-game-content');
        const currentWord = this.currentWords[this.currentIndex];
        const scrambled = currentWord.word.split('').sort(() => 0.5 - Math.random());
        
        const lettersHTML = scrambled.map((letter, index) => `
            <button class="letter-tile bg-[#2A3B4D] p-3 rounded text-xl font-bold" data-index="${index}" onclick="DictionaryTraining.constructorAddLetter(this, '${letter}')">${letter}</button>
        `).join('');

        gameContent.innerHTML = `
            <span class="modal-close-btn" onclick="DictionaryTraining.closeGame()">&times;</span>
            <div class="text-right text-sm mb-2">${this.currentIndex + 1} / ${this.currentWords.length} | Score: ${this.score}</div>
            <div class="bg-[#0C1C33] p-4 rounded-lg text-center min-h-[80px] flex items-center justify-center mb-4">
                <p>"${currentWord.definition}"</p>
            </div>
            <div id="constructor-answer" class="bg-[#0C1C33] p-4 rounded-lg h-16 mb-4 text-2xl tracking-widest text-center"></div>
            <div id="constructor-letters" class="flex flex-wrap justify-center gap-2 mb-4">
                ${lettersHTML}
            </div>
            <div class="flex justify-center gap-4">
                <button class="btn bg-gray-600" onclick="DictionaryTraining.constructorClear()">Clear</button>
                <button class="btn btn-gold" onclick="DictionaryTraining.checkWordConstructor()">Submit</button>
            </div>
        `;
    },

    constructorAddLetter(button, letter) {
        const answerDiv = document.getElementById('constructor-answer');
        answerDiv.textContent += letter;
        button.disabled = true;
        button.style.opacity = '0.3';
    },

    constructorClear() {
        document.getElementById('constructor-answer').textContent = '';
        document.querySelectorAll('#constructor-letters button').forEach(b => {
            b.disabled = false;
            b.style.opacity = '1';
        });
    },

    checkWordConstructor() {
        const answerDiv = document.getElementById('constructor-answer');
        const userAnswer = answerDiv.textContent;
        const correctWord = this.currentWords[this.currentIndex].word;

        if (userAnswer === correctWord) {
            this.score++;
            answerDiv.classList.add('bg-green-800');
            this.app.playSound(this.app.SOUNDS.correct_answer);
        } else {
            answerDiv.classList.add('bg-red-800');
            this.app.playSound(this.app.SOUNDS.incorrect_answer);
            answerDiv.textContent = correctWord; // Show correct answer
        }
        this.currentIndex++;
        setTimeout(() => this.setupWordConstructor(), 1500);
    },

    // ==== Sprint ====
    setupSprint() {
        if (this.currentIndex >= this.currentWords.length) {
            this.showGameResults();
            return;
        }
        const gameContent = document.getElementById('training-game-content');
        const currentWord = this.currentWords[this.currentIndex];
        
        const shouldMatch = Math.random() > 0.5;
        let definitionToShow = '';
        if (shouldMatch) {
            definitionToShow = currentWord.definition;
        } else {
            const otherWords = this.currentWords.filter(w => w.word !== currentWord.word);
            definitionToShow = otherWords[Math.floor(Math.random() * otherWords.length)].definition;
        }

        gameContent.innerHTML = `
            <span class="modal-close-btn" onclick="DictionaryTraining.closeGame()">&times;</span>
            <div class="text-right text-sm mb-2">${this.currentIndex + 1} / ${this.currentWords.length} | Score: ${this.score}</div>
            <div class="text-center">
                <p class="text-4xl font-bold capitalize mb-4 text-yellow-300">${currentWord.word}</p>
                <div class="bg-[#0C1C33] p-4 rounded-lg min-h-[100px] flex items-center justify-center mb-6">
                    <p>"${definitionToShow}"</p>
                </div>
                <div id="sprint-feedback" class="h-8 mb-4"></div>
                <div class="flex justify-center gap-4">
                    <button class="btn btn-destructive text-lg px-8" onclick="DictionaryTraining.checkSprint(false, ${shouldMatch})">‚ùå Don't Match</button>
                    <button class="btn bg-green-600 text-white text-lg px-8" onclick="DictionaryTraining.checkSprint(true, ${shouldMatch})">‚úîÔ∏è Match</button>
                </div>
            </div>
        `;
    },

    checkSprint(userChoice, isMatch) {
        const feedbackDiv = document.getElementById('sprint-feedback');
        if (userChoice === isMatch) {
            this.score++;
            feedbackDiv.innerHTML = `<p class="text-green-400 font-bold text-2xl">Correct!</p>`;
            this.app.playSound(this.app.SOUNDS.correct_answer);
        } else {
            feedbackDiv.innerHTML = `<p class="text-red-400 font-bold text-2xl">Incorrect!</p>`;
            this.app.playSound(this.app.SOUNDS.incorrect_answer);
        }
        this.currentIndex++;
        setTimeout(() => this.setupSprint(), 800);
    },

    // ==== Word Cards ====
    setupWordCards() {
        const gameContent = document.getElementById('training-game-content');
        if (this.currentIndex < 0) this.currentIndex = 0;
        if (this.currentIndex >= this.currentWords.length) this.currentIndex = this.currentWords.length - 1;

        const currentWord = this.currentWords[this.currentIndex];

        gameContent.innerHTML = `
            <span class="modal-close-btn" onclick="DictionaryTraining.closeGame()">&times;</span>
            <div class="text-right text-sm mb-2">${this.currentIndex + 1} / ${this.currentWords.length}</div>
            <div class="word-card h-64" onclick="this.classList.toggle('is-flipped')">
                <div class="word-card-inner">
                    <div class="word-card-face word-card-front">
                        <h3 class="text-4xl font-bold capitalize">${currentWord.word}</h3>
                    </div>
                    <div class="word-card-face word-card-back">
                        <p class="text-center">${currentWord.definition}</p>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center mt-6">
                <button class="btn bg-gray-600" onclick="DictionaryTraining.currentIndex--; DictionaryTraining.setupWordCards()">‚Üê Previous</button>
                <button class="btn btn-gold" onclick="DictionaryTraining.closeGame()">Finish Review</button>
                <button class="btn bg-gray-600" onclick="DictionaryTraining.currentIndex++; DictionaryTraining.setupWordCards()">Next ‚Üí</button>
            </div>
        `;
    },

    // ==== Word Sprint (Brainstorm) ====
    setupWordSprint() {
        if (this.timer) clearInterval(this.timer);
        if (this.currentIndex >= this.currentWords.length) {
            this.showGameResults();
            return;
        }
        const gameContent = document.getElementById('training-game-content');
        const currentWord = this.currentWords[this.currentIndex];
        let timeLeft = 15;

        gameContent.innerHTML = `
            <span class="modal-close-btn" onclick="DictionaryTraining.closeGame()">&times;</span>
            <div class="flex justify-between items-center mb-2">
                <div class="text-sm">${this.currentIndex + 1} / ${this.currentWords.length} | Score: ${this.score}</div>
                <div id="sprint-timer" class="font-bold text-lg text-yellow-300">${timeLeft}s</div>
            </div>
            <div class="bg-[#0C1C33] p-4 rounded-lg text-center min-h-[100px] flex items-center justify-center mb-4">
                <p>"${currentWord.definition}"</p>
            </div>
            <input type="text" id="word-sprint-input" class="w-full bg-[#2A3B4D] rounded p-3 text-center text-xl border border-[#3D5568]" autocomplete="off">
            <div id="word-sprint-feedback" class="h-8 mt-4 text-center"></div>
        `;

        const input = document.getElementById('word-sprint-input');
        input.focus();
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                this.checkWordSprint();
            }
        });

        const timerDiv = document.getElementById('sprint-timer');
        this.timer = setInterval(() => {
            timeLeft--;
            timerDiv.textContent = `${timeLeft}s`;
            if (timeLeft <= 5) timerDiv.classList.add('text-red-500');
            if (timeLeft <= 0) {
                this.checkWordSprint();
            }
        }, 1000);
    },

    checkWordSprint() {
        if (this.timer) clearInterval(this.timer);
        const input = document.getElementById('word-sprint-input');
        input.disabled = true;
        const userAnswer = input.value.trim().toLowerCase();
        const correctWord = this.currentWords[this.currentIndex].word.toLowerCase();
        const feedbackDiv = document.getElementById('word-sprint-feedback');

        if (userAnswer === correctWord) {
            this.score++;
            feedbackDiv.innerHTML = `<p class="text-green-400 font-bold text-2xl">Correct!</p>`;
            this.app.playSound(this.app.SOUNDS.correct_answer);
        } else {
            feedbackDiv.innerHTML = `<p class="text-red-400 font-bold text-2xl">Incorrect! The word was: <span class="capitalize">${correctWord}</span></p>`;
            this.app.playSound(this.app.SOUNDS.incorrect_answer);
        }
        this.currentIndex++;
        setTimeout(() => this.setupWordSprint(), 2000);
    },
    
    // ==== UTILITY FUNCTIONS ====
    getWordsForTraining(count) {
        const allWords = Object.entries(Dictionary.userWords).map(([word, definition]) => ({ word, definition }));
        this.shuffleArray(allWords);
        return allWords.slice(0, count);
    },

    shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    },
    
    showGameResults() {
        const gameContent = document.getElementById('training-game-content');
        const totalQuestions = this.currentWords.length;
        const accuracy = totalQuestions > 0 ? Math.round((this.score / totalQuestions) * 100) : 0;
        gameContent.innerHTML = `
            <span class="modal-close-btn" onclick="DictionaryTraining.closeGame()">&times;</span>
            <h3 class="font-magic-header text-2xl text-center text-[#FFD700] mb-4">Training Complete!</h3>
            <p class="text-center text-5xl font-bold mb-4">${this.score}/${totalQuestions}</p>
            <p class="text-center text-2xl text-yellow-300 mb-6">Accuracy: ${accuracy}%</p>
            <div class="flex justify-center gap-4">
                <button class="btn btn-gold" onclick="DictionaryTraining.closeGame()">Back to Hub</button>
            </div>
        `;
        if (accuracy > 80) {
            this.app.playSound(this.app.SOUNDS.celebration);
        }
    }
};
window.DictionaryTraining = DictionaryTraining;

// =================================================================================
// HARRY POTTER TEXT ADVENTURE MODULE (REVISED LOGIC & UI EDITION 3.0)
// =================================================================================
const TextAdventure = {
    app: null,
    gameState: {},
    activePuzzle: null,

    // [NEW] Emoji mapping for inventory items
    itemEmojis: {
        'toy_soldiers': 'üíÇ',
        'cake': 'üéÇ',
        'letter': '‚úâÔ∏è',
        'gringotts_key': 'üîë',
        'galleons': 'üí∞',
        'robes': 'üßô',
        'school_books': 'üìö',
        'wand': '‚ú®',
        'chocolate_frog': 'üê∏',
        'dumbledore_card': 'üÉè',
        'invisibility_cloak': 'üß•',
        'flute': 'üé∂',
        'feather': '‚òÅÔ∏è',
        'restricted_book': 'üìñ',
        'broomstick': 'üßπ',
        'parchment': 'üìú',
        'philosophers_stone': 'üíé'
    },

    // =================================================================================
    //  HINT DATA: Contextual hints for when the player is stuck.
    // =================================================================================
    hintData: {
        'cupboardUnderStairs': "Your goal is to get out of the cupboard. Try interacting with the only exit: the `door`. The command `open door` might be what you need.",
        'privetDriveHallway': (flags) => {
            if (!flags.first_letter_arrived) {
                return "You are in a hallway. People usually leave houses through the front door. Perhaps you should try to `go out` or `go west`.";
            }
            if (!flags.letter_taken_once) {
                return "There's a strange letter on the mat. It seems important. You could try to `take letter`.";
            }
            return "The story is progressing after the letter incident. To see what happens next, try exploring the house again. Perhaps visiting the `living room` would trigger something.";
        },
        'smallestBedroom': "You've been moved to a new room. The plot is advancing. Try to trigger the next event by interacting with the house, maybe checking the `front door` again.",
        'hutOnTheRock': "A giant man just broke down the door and gave you a cake. He seems to be the key to getting out of here. Maybe you should `talk to hagrid`?",
        'leakyCauldron': "You need to find the entrance to Diagon Alley. Hagrid mentioned it was through the back. The description mentions a `wall`. You should try to `open wall`.",
        'diagonAlley': (flags) => {
            if (!flags.has_money) {
                return "This is a hub area. Your main goal is to get your school supplies. You'll need money from the bank first. Try to `go north`.";
            }
            if (!flags.has_wand) {
                return "You have money. Now you need a wand. Ollivanders is to the `east`.";
            }
            if (!flags.has_robes || !flags.has_books) {
                return "You have your wand and money. You still need to buy `robes` and `books` for school.";
            }
            return "You have all your supplies! It's time to head to the train station. Hagrid is waiting for you back at the Leaky Cauldron. You should `go pub` to meet him.";
        },
        'gringotts': "To get into your vault, you need a key. Hagrid gave you one. You should `take key` and then try to `use key` or `go vaults`.",
        'vault687': "You are in your vault. You see mounds of gold, silver, and bronze coins. You should probably `take money` or `take coins`.",
        'ollivanders': (flags) => {
            if (!flags.has_wand) {
                return "You are in Ollivander's shop. The old man is waiting. To get your wand, you should `talk to ollivander`.";
            }
            return "You have your wand. There is nothing else to do here. You should `go out` to return to Diagon Alley.";
        },
        'platform934': "You need to get to Platform 9¬æ. The Weasleys mentioned you have to go straight at the `barrier` between platforms 9 and 10. Try the command `go barrier`.",
        'hogwartsExpress': "You are on the train to Hogwarts. A boy named Ron Weasley is in your compartment. Maybe you should `talk to ron` to pass the time. Don't forget to `eat` your chocolate frog!",
        'greatHall': (flags) => {
             if (!flags.sorted) {
                return "You are in the Great Hall. Professor McGonagall is calling students to the Sorting Hat. You should probably `examine hat` or `talk to mcgonagall`.";
            }
            return "You've been sorted! To explore the castle, you first need to leave the Great Hall and go to your `common room`.";
        },
        'gryffindorCommonRoom': (flags) => {
            if (flags.is_christmas && !flags.cloak_taken) {
                return "It's Christmas! There's a new present on your bed. You should `take` it before exploring further.";
            }
            return "You are in your common room. You can `go out` to explore the castle corridors.";
        },
        'hogwartsCorridor': (flags) => {
            if (!flags.knows_leviosa || !flags.potions_quiz_passed || !flags.knows_flying) {
                return "You need to learn the basics before you can properly explore. You should attend your classes: `charms`, `potions` in the dungeons, and flying `outside`.";
            }
            if (flags.cloak_taken && !flags.troll_defeated) {
                return "The main thing to do right now is investigate the commotion in the girls' `bathroom`. It sounds urgent.";
            }
            if (flags.troll_defeated) {
                 return "The troll is defeated. Now you can finally explore upstairs. You should try to `go up` the grand staircase.";
            }
            return "You are in a main corridor. You can go to the `charms` classroom, down to the `dungeons`, `outside` for lessons on the grounds, or `up` the grand staircase.";
        },
        'charmsClassroom': "You are here to learn a new spell, Wingardium Leviosa. Professor Flitwick is instructing you. You should `take feather` and then `practice spell`.",
        'potionsClassroom': "Professor Snape is here, and he looks like he's in a foul mood. To pass his class and gain crucial knowledge, you must answer his questions. Try to `talk to snape`.",
        'flyingLessonGrounds': "You are on the grounds of Hogwarts with other first-years for your first flying lesson with Madam Hooch. She is instructing you to command your broom. You should `talk to hooch` to begin.",
        'girlsBathroom': (flags) => {
            if (!flags.troll_defeated) {
                return "There's a troll here! You must save Hermione. You learned the levitation charm in class. You could try to `cast wingardium leviosa` or `use wand on troll`.";
            }
            return "The troll is defeated. There's nothing else to do here. You should probably `go out` and continue exploring Hogwarts.";
        },
        'thirdFloorCorridor': (flags) => {
             if (!flags.knows_alohomora) {
                 return "This is the forbidden corridor. At the end of it is a large, locked `door`. You wonder how you might get it open.";
             }
             if (!flags.knows_flamel) {
                return "This is the forbidden corridor. You hear growling from behind a locked `door`. You need to find out what's being guarded. Research might help. Try the `library`, or perhaps you have an item that contains useful information? Click on your inventory items to `examine` them.";
             }
             if (flags.knows_flamel && !flags.fluffy_asleep) {
                 return "There's a giant three-headed dog behind the door. Hagrid mentioned that music calms beasts like that. If only you had a musical instrument... perhaps you should `use flute`?";
             }
             return "Fluffy is asleep. Now's your chance to go through the trapdoor. You should `cast alohomora` on the door.";
        },
        'library': "This is the perfect place for research. You've heard rumors about what Fluffy is guarding. Try to `research flamel` to find more information.",
        'trapdoorRoom': "You're trapped by a plant! Hermione mentioned its weakness in the book. It's Devil's Snare, which hates sunlight. Maybe a light-creating spell could work? Try `cast lumos solem`.",
        'flyingKeysRoom': (flags) => {
            if (!flags.knows_flying) {
                return "You are in a room full of flying keys, but you can't reach them. You see a broomstick floating nearby, but you haven't had your first lesson yet and don't know how to use it. You must have a `flying lesson` first.";
            }
            if (!flags.broomstick_taken) {
                 return "You are in a high-ceilinged chamber filled with hundreds of flying keys. On the far side is a heavy wooden door. A single broomstick is floating nearby. Thanks to your flying lesson, you know what to do. You should `take broomstick`.";
            }
            return "You have your broom, but picking out the right key from the swarm is impossible. The one you need has a battered wing. That practice `feather` from Charms class is very light; perhaps you could `use feather` to tag the correct key?";
        },
        'chessChamber': "This is a giant, living chess set. The only way is across. You'll have to play. Ron is an expert, but he looks worried. 'This means some of us will be... taken. If only we had something disposable to use for a sacrifice...' To proceed, you must trust Ron and `go across`.",
        'potionsRiddleRoom': (flags) => {
            if (!flags.potions_quiz_passed) {
                return "You enter a dark room with a table of potions and a riddle. The logic puzzle is incredibly complex. You stare at the bottles, but the logic of the riddle escapes you. You didn't pay enough attention in Snape's class and cannot solve it. You must go back and learn more.";
            }
            return "You enter a dark room with a table of potions and a riddle. Thanks to the knowledge you gained from Snape's quiz, you feel confident you can solve this. `examine parchment` to read the riddle, and then `go forward` to choose the correct potion.";
        },
        'finalChamber': "This is the final challenge. The Mirror is the key. Dumbledore's words echo in your mind: only someone who wanted to *find* the Stone, but not *use* it, could get it. Your intention is everything. Perhaps you simply need to face the `mirror` and look.",
        'hospitalWing': "You've won, but at a great cost. Dumbledore is here. To hear the end of the story, you should `talk to dumbledore`.",
        'default': "If you're stuck, try these basic commands: `look` to re-examine the room, `inventory` (or `i`) to check your items, and click on an inventory emoji to `examine` it. Also try moving in all available directions (`go north`, `go east`, etc.)."
    },

    worldData: {
        'cupboardUnderStairs': {
            description: "You are in a small, dark cupboard under the stairs. The air is thick with the smell of dust and old socks. A single, bare lightbulb hangs from the ceiling, casting dim shadows. A small wooden door is the only way out.",
            exits: {
                'out': { locked: true, puzzle: 'cupboardDoor' },
                'door': { locked: true, puzzle: 'cupboardDoor' }
            },
            items: [ { id: 'toy_soldiers', name: 'a few broken toy soldiers', description: "They are plastic army men, missing various limbs. Probably Dudley's old toys. They remind you of a lonely childhood." } ]
        },
        'privetDriveHallway': {
            description: "You are standing in the immaculately clean hallway of Number 4, Privet Drive. A staircase leads up. The front door is to the west, and the living room is to the east. The door to the cupboard is here.",
            exits: {
                'up': { to: 'upstairsLanding' },
                'west': { to: 'frontDoor', event: 'firstLetter' },
                'out': { to: 'frontDoor', event: 'firstLetter' },
                'east': { to: 'livingRoom' },
                'south': { to: 'kitchen'},
                'cupboard': { to: 'cupboardUnderStairs' }
            },
            items: []
        },
        'frontDoor': {
            description: "You are at the front door. Through the frosted glass, you can see the perfectly manicured lawn of Privet Drive. There is a mail slot in the door.",
            exits: {
                'east': { to: 'privetDriveHallway' },
                'out': { locked: true, description: "The door is securely locked. You're not allowed out on your own."}
            },
            items: []
        },
        'livingRoom': {
            description: "You are in the living room. A fireplace sits on the north wall, currently boarded up. The television is flickering in the corner, showing a news report about owls. The hallway is to the west.",
            exits: { 'west': { to: 'privetDriveHallway' } },
            items: []
        },
        'kitchen': {
            description: "You are in the kitchen. It's spotless, apart from the lingering smell of bacon. Aunt Petunia is here, watching you with narrowed eyes. The back door leads to the garden, and the hallway is to the north.",
            exits: {
                'north': { to: 'privetDriveHallway' },
                'garden': { locked: true, description: "You have chores to do before you can go out there."}
            },
            items: []
        },
        'upstairsLanding': {
            description: "You are on the upstairs landing. There are two doors here. One leads to your aunt and uncle's bedroom, the other is for Dudley's second bedroom, which is mostly full of his broken toys.",
            exits: {
                'down': { to: 'privetDriveHallway' },
                'dudleys': { locked: true, description: "It's Dudley's main bedroom. Best not to go in there." },
                'smallest bedroom': { to: 'smallestBedroom' }
            },
            items: []
        },
        'smallestBedroom': {
            description: "This is Dudley's second bedroom, the smallest room in the house. It's filled with things Dudley couldn't fit into his main room. There's a window overlooking the front garden.",
            exits: { 'out': { to: 'upstairsLanding' } },
            items: []
        },
        'hutOnTheRock': {
            description: "BOOM! The door splinters open, and a giant of a man named Hagrid enters, shaking the whole hut. 'Got summat fer yeh,' he says, handing you a slightly squashed box. The wind howls outside.",
            description_after_flag: {
                flag: 'hagrid_met',
                text: "You are in the rickety hut on the rock. The wind howls outside, but Hagrid's presence makes it feel much safer. He is waiting to take you to Diagon Alley."
            },
            exits: { 'leave': { locked: true, puzzle: 'hagridTrust' } },
            items: [ { id: 'cake', name: 'a squashed box', description: "Inside the box is a large, sticky chocolate cake with 'Happee Birthdae Harry' written on it in green icing." } ]
        },
        'leakyCauldron': {
            description: "You are in a dark, shabby pub called the Leaky Cauldron. It's filled with witches and wizards. The bartender, Tom, gives you a nod. A brick wall at the back of the pub seems to be the way forward.",
            exits: {
                'london': { locked: true, description: "You can't go back to the Muggle world without Hagrid." },
                'wall': { locked: true, puzzle: 'diagonAlleyWall' }
            },
            items: []
        },
        'diagonAlley': {
            description: "You step into a bustling, cobbled street filled with amazing shops. This is Diagon Alley. To the north is Gringotts Bank. Ollivanders is to the east. You can also see shops for robes and books.",
            exits: {
                'north': { to: 'gringotts' },
                'east': { to: 'ollivanders', requiresFlag: 'has_money', lockedDescription: "It's probably best to get some money from Gringotts first before you go shopping for a wand." },
                'robes': { to: 'madamMalkins', requiresFlag: 'has_money', lockedDescription: "You'll need money from Gringotts before you can buy robes." },
                'books': { to: 'flourishAndBlotts', requiresFlag: 'has_money', lockedDescription: "You can't buy books without money. Best visit Gringotts first." },
                'pub': { to: 'leakyCauldron', event: 'goToPlatform' }
            },
            items: []
        },
        'gringotts': {
            description: "You are inside Gringotts, a vast marble hall. Goblins are sitting on high stools, weighing coins. A goblin named Griphook approaches you. A door leads to the vaults.",
            exits: {
                'out': { to: 'diagonAlley' },
                'vaults': { locked: true, puzzle: 'gringottsKey' }
            },
            items: [ { id: 'gringotts_key', name: 'a tiny golden key', description: "It's a small, ornate golden key. Hagrid gives it to you." } ]
        },
        'vault687': {
            description: "Griphook opens the vault. Inside are mounds of gold, silver, and bronze coins. This is your inheritance!",
            exits: { 'out': { to: 'gringotts' } },
            items: [ { id: 'galleons', name: 'a large bag of coins', description: "Heaps of shiny gold Galleons, silver Sickles, and bronze Knuts." } ]
        },
        'madamMalkins': {
            description: "You are in 'Madam Malkin's Robes for All Occasions'. A kind-faced witch is measuring a pale boy with a bored, drawling voice. He's talking about Quidditch.",
            exits: {'out': { to: 'diagonAlley'}},
            items: [ {id: 'robes', name: 'a set of Hogwarts robes', description: "Three sets of plain work robes in black. They feel a bit scratchy."}]
        },
        'flourishAndBlotts': {
            description: "You are in the bookshop, Flourish and Blotts. Shelves are stacked to the ceiling with books. The air smells of old parchment.",
            exits: {'out': { to: 'diagonAlley'}},
            items: [ {id: 'school_books', name: 'a pile of school books', description: "All your required reading for the first year, including 'A History of Magic' and 'Fantastic Beasts and Where to Find Them'."}]
        },
        'ollivanders': {
            description: "The shop is narrow and dusty. Thousands of narrow boxes are stacked to the ceiling. An old man with pale, silvery eyes, Mr. Ollivander, appears. 'I wondered when I'd be seeing you, Mr. Potter,' he says.",
            description_after_flag: {
                flag: 'has_wand',
                text: "You are back in Ollivander's wand shop. The old man gives you a knowing nod from behind the counter."
            },
            exits: { 'out': { to: 'diagonAlley' } },
            items: []
        },
        'platform934': {
            description: "You are at King's Cross Station, standing between platforms 9 and 10. There's a solid-looking barrier here. The Hogwarts Express is supposed to be on Platform 9¬æ, but you can't see it.",
            exits: { 'barrier': { locked: true, puzzle: 'platformBarrier'} },
            items: []
        },
        'hogwartsExpress': {
            description: "You are on the Hogwarts Express, a magnificent scarlet steam engine. You've found an empty compartment. A red-haired boy named Ron Weasley is already here. The train begins to move.",
            exits: {},
            items: [ { id: 'chocolate_frog', name: 'a Chocolate Frog', description: "A magical chocolate frog. It probably has a collectible card inside." } ]
        },
        'greatHall': {
            description: "You are in the Great Hall at Hogwarts. It's enormous, lit by thousands of floating candles. The ceiling is bewitched to look like the sky outside. At the front, the teachers' table is laden with golden plates and goblets. At the center sits Albus Dumbledore. Professor McGonagall stands nearby, holding a frayed wizard's hat: the Sorting Hat.",
            description_after_flag: {
                flag: 'sorted',
                text: "You are in the Great Hall. Students from all four houses are eating and talking loudly. Your place is at the Gryffindor table."
            },
            exits: { 'common room': { locked: true, puzzle: 'fatLadyPassword' } },
            items: []
        },
        'gryffindorCommonRoom': {
            description: "You are in the cozy, circular Gryffindor common room. Comfy armchairs are gathered around a crackling fireplace. A portrait of a Fat Lady guards the entrance. An anonymously-given present is on your bed.",
            description_after_flags: [
                 {
                    flag: 'gifts_taken',
                    text: "You are in the cozy, circular Gryffindor common room. Comfy armchairs are gathered around a crackling fireplace. The room feels warm and safe."
                },
                 {
                    flag: 'is_christmas',
                    text: "You are in the cozy, circular Gryffindor common room. It's decorated for Christmas, and a roaring fire is in the hearth. You notice a new, mysterious present has been left on your bed."
                }
            ],
            exits: { 'out': { to: 'hogwartsCorridor' } },
            items: [
                { id: 'flute', name: 'a wooden flute', description: "A simple wooden flute, a gift from Hagrid. It plays a haunting melody." }
            ]
        },
        'hogwartsCorridor': {
            description: "You are in a stone corridor on the first floor. Suits of armor line the walls, and portraits watch you pass. Doors lead to the Charms classroom, down to the dungeons, and outside to the grounds. A grand staircase goes up.",
            description_after_flags: [
                {
                    flag: 'troll_defeated',
                    text: "You are in a stone corridor on the first floor. The memory of the troll fight lingers. Doors lead to the Charms classroom, down to the dungeons, and outside to the grounds. A grand staircase goes up."
                },
                {
                    flag: 'cloak_taken',
                    text: "You are in a stone corridor on the first floor. Suddenly, you hear a scream from the girls' bathroom down the hall. It sounds like Hermione is in trouble! Other doors lead to the Charms classroom, down to the dungeons, and outside to the grounds. A grand staircase goes up."
                }
            ],
            exits: {
                'common room': { to: 'gryffindorCommonRoom' },
                'charms': { to: 'charmsClassroom' },
                'dungeons': { to: 'dungeonCorridor' },
                'outside': { to: 'flyingLessonGrounds' },
                'up': {
                    to: 'thirdFloorCorridor',
                    locked: true,
                    puzzle: 'filchEncounter',
                    requiresFlag: 'troll_defeated',
                    lockedDescription: "That corridor is out of bounds for first-years. You remember Dumbledore's warning at the start-of-term feast."
                },
                'bathroom': {
                    to: 'girlsBathroom',
                    requiresFlag: 'cloak_taken',
                    lockedDescription: "There's nothing of interest down that way."
                }
            },
            items: []
        },
        'charmsClassroom': {
            description: "You are in the Charms classroom. The tiny Professor Flitwick is standing on a pile of books. 'Today we will practice the levitation charm!' he squeaks. 'Swish and flick!' You see a feather on your desk.",
            description_after_flags: [
                {
                    flag: 'knows_leviosa',
                    text: "You are back in the Charms classroom. It's quiet now that the lesson is over."
                },
                {
                    flag: 'feather_taken',
                    text: "You have the feather. Professor Flitwick is still instructing the class. You should try to `practice spell`."
                }
            ],
            exits: { 'out': { to: 'hogwartsCorridor' } },
            items: [ {id: 'feather', name: 'a feather', description: 'A simple white feather for practicing your charms. It feels very light.'} ]
        },
        'dungeonCorridor': {
            description: "You are in a cold, damp dungeon corridor. The air is chilly. A door here leads to the Potions classroom.",
            exits: { 'up': { to: 'hogwartsCorridor' }, 'potions': { to: 'potionsClassroom' } },
            items: []
        },
        'potionsClassroom': {
            description: "You are in the Potions classroom. Professor Snape is gliding between tables, his black robes billowing. He stares at you with cold, black eyes. 'Potter,' he sneers. 'Our new celebrity.'",
            description_after_flag: {
                flag: 'potions_quiz_passed',
                text: "You are back in the Potions classroom. Snape gives you a cold glare but says nothing more. The memory of his interrogation is still fresh."
            },
            exits: { 'out': { to: 'dungeonCorridor' } },
            items: []
        },
        'flyingLessonGrounds': {
            description: "You are outside on the Hogwarts grounds. A row of old broomsticks lies on the grass. Madam Hooch, the flying instructor, stands before the class. 'Well, what are you all waiting for?' she barks. 'Everyone stand by a broomstick. Come on, hurry up.'",
            description_after_flag: {
                flag: 'knows_flying',
                text: "You are back on the training grounds. The other students are gone, and the brooms have been put away. The grass smells freshly cut."
            },
            exits: { 'inside': { to: 'hogwartsCorridor' } },
            items: []
        },
        'girlsBathroom': {
            description: "You are in a girls' bathroom. It smells awful, and there's a huge wooden club on the floor. A massive mountain troll is cornering Hermione!",
            description_after_flag: {
                flag: 'troll_defeated',
                text: "You are in the girls' bathroom. The smell is much better now, but the memory of the troll still lingers."
            },
            exits: { 'out': { to: 'hogwartsCorridor'} },
            items: []
        },
        'thirdFloorCorridor': {
            description: "You are in the forbidden third-floor corridor. It's dark and spooky. At the end of the corridor is a locked door. You hear menacing growls from behind it. A door to the library is also here.",
            description_after_flag: {
                flag: 'fluffy_asleep',
                text: "You are in the forbidden third-floor corridor. The menacing growls have been replaced by loud snores. Now is your chance!"
            },
            exits: {
                'down': { to: 'hogwartsCorridor' },
                'door': { locked: true, puzzle: 'fluffyDoor' },
                'library': {to: 'library'}
            },
            items: []
        },
        'library': {
            description: "You are in the Hogwarts library. It's a vast, silent room with towering shelves of books. Madam Pince, the librarian, watches you like a hawk from her desk.",
            description_after_flag: {
                flag: 'knows_flamel',
                text: "You are in the Hogwarts library. The knowledge you found about the Philosopher's Stone weighs heavily on your mind."
            },
            exits: {'out': {to: 'thirdFloorCorridor'}},
            items: [ {id: 'restricted_book', name: 'a heavy book from the restricted section', description: "The book is about 'Potent Potions'. It looks very old."}]
        },
        'trapdoorRoom': {
            description: "You land on something soft and damp. It's a strange, wriggling plant with thick tendrils that are beginning to wrap around you! The only other exit is blocked by the plant.",
            exits: {
                'up': { locked: true, description: "The trapdoor has slammed shut and you can't reach it." },
                'plant': { locked: true, puzzle: 'devilsSnare' }
            },
            items: []
        },
        'flyingKeysRoom': {
            description: "You are in a high-ceilinged chamber filled with hundreds of fluttering, jewel-bright birds. You realize they're not birds - they're keys! On the far side is a heavy wooden door. A single broomstick is floating nearby.",
            description_after_flag: {
                flag: 'broomstick_taken',
                text: "You are in a high-ceilinged chamber filled with hundreds of fluttering, jewel-bright keys. You have your broom, but picking out the right key from the swarm is impossible. The one you need has a battered wing, but it's lost in the dizzying dance. That practice `feather` from Charms class is very light; perhaps you could `use feather` to tag the correct key?"
            },
            exits: {
                'back': { to: 'trapdoorRoom' },
                'door': { locked: true, puzzle: 'flyingKey' }
            },
            items: [ {id: 'broomstick', name: 'a broomstick', description: 'An old Silver Arrow. It looks reliable.'} ]
        },
        'chessChamber': {
             description: "You enter a huge, dark chamber on the edge of a giant chessboard. Across the room stand enormous black chess pieces. They turn their helmeted heads to look at you. Ron looks pale. 'We have to play... become the pieces.' He gulps. 'This means some of us will get... taken. If only we had something disposable to use for a sacrifice...'",
             exits: {
                 'back': { to: 'flyingKeysRoom' },
                 'across': { locked: true, puzzle: 'chessPuzzle' }
             },
             items: []
        },
        'potionsRiddleRoom': {
            description: "You enter a dark room with a table in the center. On it are seven potions in different-shaped bottles. A piece of parchment with a riddle is next to them. Flames block the way forward and the way back.",
            exits: {
                'forward': { locked: true, puzzle: 'potionsRiddle' },
                'back': { locked: true, description: 'A wall of black fire blocks this doorway.' }
            },
            items: [ {id: 'parchment', name: 'a piece of parchment', description: "Danger lies before you, while safety lies behind, Two of us will help you, whichever you would find, One among us seven will let you move ahead, Another will transport the drinker back instead..."}]
        },
        'finalChamber': {
            description: "You are in the final chamber. It's not Snape, but Professor Quirrell! Standing before him is the magnificent Mirror of Erised. Quirrell turns to face you, a triumphant, twitching smile on his face. 'You,' he rasps.",
            exits: {},
            items: []
        },
        'hospitalWing': {
            description: "You are lying in a bed with crisp white sheets in the hospital wing. Your head hurts. The last thing you remember is a searing pain in your scar, and Quirrell's face turning to dust. Albus Dumbledore is sitting beside you, smiling.",
            exits: {},
            items: []
        }
    },

    puzzles: {
        'potionsQuestion1': {
            A2: { question: "What do you get if you add asphodel to wormwood?", options: ["A love potion", "A sleeping potion", "A healing potion", "A poison"], correctAnswer: "A sleeping potion", explanation: "Powdered root of asphodel added to an infusion of wormwood creates the Draught of Living Death, a powerful sleeping potion." },
            B1: { question: "What would I get if I added powdered root of asphodel to an infusion of wormwood?", options: ["A Potion of Invisibility", "The Draught of Living Death", "The Potion of Deep Slumber", "The Elixir of Life"], correctAnswer: "The Draught of Living Death", explanation: "This is a direct quote from the book. The potion created is the Draught of Living Death, a very powerful sleeping potion." },
            B2: { question: "What would I get if I added powdered root of asphodel to an infusion of wormwood?", options: ["A Potion of Invisibility", "The Draught of Living Death", "The Potion of Deep Slumber", "The Elixir of Life"], correctAnswer: "The Draught of Living Death", explanation: "This is a direct quote from the book. The potion created is the Draught of Living Death, a very powerful sleeping potion." },
            C1: { question: "What would I get if I added powdered root of asphodel to an infusion of wormwood?", options: ["A Potion of Invisibility", "The Draught of Living Death", "The Potion of Deep Slumber", "The Elixir of Life"], correctAnswer: "The Draught of Living Death", explanation: "This is a direct quote from the book. The potion created is the Draught of Living Death, a very powerful sleeping potion." },
            reward: { type: 'trigger_puzzle', puzzle: 'potionsQuestion2', successMessage: "'Correct. The Draught of Living Death. Let's try another...'" },
            failureMessage: "'Wrong. Clearly, fame isn't everything.' Snape sneers and ignores you."
        },
        'potionsQuestion2': {
            A2: { question: "Where can you find a bezoar?", options: ["In a plant", "In a snake", "In the stomach of a goat", "In a tree"], correctAnswer: "In the stomach of a goat", explanation: "A bezoar is a stone taken from the stomach of a goat, and it will save you from most poisons." },
            B1: { question: "Where, then, would you look if I told you to find me a bezoar?", options: ["In the Restricted Section", "In the stomach of a goat", "In a dragon's liver", "In a mermaid's purse"], correctAnswer: "In the stomach of a goat", explanation: "A bezoar is a stone-like mass taken from the stomach of a goat, known for being a powerful antidote to most poisons." },
            B2: { question: "Where, then, would you look if I told you to find me a bezoar?", options: ["In the Restricted Section", "In the stomach of a goat", "In a dragon's liver", "In a mermaid's purse"], correctAnswer: "In the stomach of a goat", explanation: "A bezoar is a stone-like mass taken from the stomach of a goat, known for being a powerful antidote to most poisons." },
            C1: { question: "Where, then, would you look if I told you to find me a bezoar?", options: ["In the Restricted Section", "In the stomach of a goat", "In a dragon's liver", "In a mermaid's purse"], correctAnswer: "In the stomach of a goat", explanation: "A bezoar is a stone-like mass taken from the stomach of a goat, known for being a powerful antidote to most poisons." },
            reward: { type: 'trigger_puzzle', puzzle: 'potionsQuestion3', successMessage: "'Precisely. From the stomach of a goat. And what is the difference...'" },
            failureMessage: "'Incorrect. I see you haven't opened a book.' Snape turns away from you."
        },
        'potionsQuestion3': {
            A2: { question: "Are monkshood and wolfsbane the same?", options: ["Yes", "No", "Sometimes", "Only on a full moon"], correctAnswer: "Yes", explanation: "Monkshood and wolfsbane are the same plant, which also goes by the name of aconite." },
            B1: { question: "What is the difference between monkshood and wolfsbane?", options: ["One is a plant, the other a potion", "One is poison, the other is not", "They are the same plant", "They grow in different climates"], correctAnswer: "They are the same plant", explanation: "This is a trick question. Monkshood and wolfsbane are two different names for the same plant, which is also called aconite." },
            B2: { question: "What is the difference between monkshood and wolfsbane?", options: ["One is a plant, the other a potion", "One is poison, the other is not", "They are the same plant", "They grow in different climates"], correctAnswer: "They are the same plant", explanation: "This is a trick question. Monkshood and wolfsbane are two different names for the same plant, which is also called aconite." },
            C1: { question: "What is the difference between monkshood and wolfsbane?", options: ["One is a plant, the other a potion", "One is poison, the other is not", "They are the same plant", "They grow in different climates"], correctAnswer: "They are the same plant", explanation: "This is a trick question. Monkshood and wolfsbane are two different names for the same plant, which is also called aconite." },
            reward: { type: 'flag_set', flag: 'potions_quiz_passed', successMessage: "'They are the same plant. Very good. Don't get complacent.' Snape sweeps away, leaving you with a grudging respect." },
            failureMessage: "'A foolish answer. Pity.' Snape dismisses you with a wave of his hand."
        },
        'flyingLesson': {
            A2: { question: "Madam Hooch tells you to say a word. What word?", options: ["Go", "Fly", "Up", "Float"], correctAnswer: "Up", explanation: "This is a reading comprehension question from the book. The first command a student gives their broom is a sharp, clear 'Up!'" },
            B1: { question: "To make the broom fly into your hand, your command must be:", options: ["A polite request", "A confident command", "A quiet whisper", "A long sentence"], correctAnswer: "A confident command", explanation: "Madam Hooch stresses the importance of intent and confidence in magic. The command must be given with conviction, not hesitation. 'A confident command' is the best description." },
            B2: { question: "The broom 'jumped' into your hand. Which of these words is a synonym for 'jumped' in this context?", options: ["Rolled", "Slid", "Leapt", "Fell"], correctAnswer: "Leapt", explanation: "'To leap' means to jump or spring a long way, to a great height, or with great force. It perfectly captures the sudden, energetic movement of the broom rising from the ground." },
            C1: { question: "Which sentence best captures the feeling of the broom responding to your will for the first time?", options: ["The broom came up when I said the word.", "The broom responded to my command.", "It was a strange feeling as the wood of the broom vibrated, then surged upwards, connecting with my hand as if it were a living extension of my own intent.", "The magical broom flew up."], correctAnswer: "It was a strange feeling as the wood of the broom vibrated, then surged upwards, connecting with my hand as if it were a living extension of my own intent.", explanation: "This sentence uses strong sensory details ('vibrated', 'surged upwards'), figurative language ('living extension of my own intent'), and evocative vocabulary to create a powerful and descriptive image, far more than the other, simpler options." },
            reward: { type: 'flag_set', flag: 'knows_flying', successMessage: "You stare down at the broom and shout 'UP!'. It immediately jumps into your hand. Madam Hooch gives a rare smile. 'Very good, Potter.' You now have a feel for handling a broom." },
            failureMessage: "You say the word, but the broom just twitches and lies still. 'Not enough conviction!' barks Madam Hooch."
        },
        'filchEncounter': {
            A2: { correctAnswer: 'use cloak', explanation: "The invisibility cloak is a key item for moving around Hogwarts undetected. Using it at the right time is crucial." },
            B1: { correctAnswer: 'use cloak', explanation: "The invisibility cloak is a key item for moving around Hogwarts undetected. Using it at the right time is crucial." },
            B2: { correctAnswer: 'use cloak', explanation: "The invisibility cloak is a key item for moving around Hogwarts undetected. Using it at the right time is crucial." },
            C1: { correctAnswer: 'use cloak', explanation: "The invisibility cloak is a key item for moving around Hogwarts undetected. Using it at the right time is crucial." },
            reward: { type: 'move_to', room: 'thirdFloorCorridor', successMessage: "You quickly throw the invisibility cloak over yourself. A moment later, Filch shuffles past, grumbling to his cat, Mrs. Norris. Neither of them notices you. You silently slip up the stairs." },
            failureMessage: "You take a step towards the stairs, but a wheezing voice calls out 'Who's there?!'. You've been spotted! You quickly retreat before you get detention."
        },
        'greatHallSorting': {
            A2: { correctAnswer: '', explanation: "In the magical world, some objects, like the Sorting Hat, have a will of their own. Interacting with them can reveal their purpose." },
            B1: { correctAnswer: '', explanation: "In the magical world, some objects, like the Sorting Hat, have a will of their own. Interacting with them can reveal their purpose." },
            B2: { correctAnswer: '', explanation: "In the magical world, some objects, like the Sorting Hat, have a will of their own. Interacting with them can reveal their purpose." },
            C1: { correctAnswer: '', explanation: "In the magical world, some objects, like the Sorting Hat, have a will of their own. Interacting with them can reveal their purpose." },
            reward: { type: 'flag_set', flag: 'sorted', successMessage: "Professor McGonagall calls your name. The Sorting Hat is placed on your head. After a moment, it shouts 'GRYFFINDOR!'. Before you join the celebrating Gryffindor table, a prefect tells you the password to the common room is 'Caput Draconis'." },
        },
        'wandChoice': {
            A2: {
                question: "Ollivander gives you a wand. It feels...",
                options: ["Good", "Bad", "Cold", "Warm"],
                correctAnswer: "Warm",
                explanation: "This is a reading comprehension and vocabulary question. In the story, the wand that chooses the wizard often gives a sign of connection, described as a warm feeling."
            },
            B1: {
                question: "Ollivander says, 'The wand chooses the wizard.' This sentence is in the:",
                options: ["Past Simple", "Present Simple", "Future Simple", "Present Continuous"],
                correctAnswer: "Present Simple",
                explanation: "The Present Simple tense is used for general truths, facts, and habits. Ollivander is stating a fundamental rule of magic, which is considered a general truth."
            },
            B2: {
                question: "A phoenix feather is inside your wand. Which sentence is grammatically correct?",
                options: ["There is a phoenix's feather.", "There is a phoenixes feather.", "There is a phoenixes' feather.", "There are a phoenix's feather."],
                correctAnswer: "There is a phoenix's feather.",
                explanation: "To show possession for a singular noun (phoenix), we add an apostrophe + s ('s). 'Phoenixes' is the plural, 'phoenixes'' is the plural possessive, and 'There are' is incorrect subject-verb agreement for a single feather."
            },
            C1: {
                question: "Your wand and Voldemort's are 'brothers' because their cores come from the same phoenix. This shared origin is a literary device known as:",
                options: ["A plot hole", "A MacGuffin", "A motif", "An antagonist"],
                correctAnswer: "A motif",
                explanation: "A motif is a recurring element, image, or idea in a literary work that has symbolic significance. The connection between the two wands is a powerful motif that reappears throughout the series."
            },
            reward: { type: 'flag_set', flag: 'has_wand', successMessage: "A shower of red and gold sparks erupts from the wand's tip. It feels warm in your hand. 'Curious,' says Ollivander. 'Very curious.' You have your wand!"},
            failureMessage: "Ollivander snatches the wand back. 'No, no, definitely not.' He searches for another box."
        },
        'charmsLesson': {
            A2: {
                question: "Professor Flitwick tells you the magic words are 'Wingardium Leviosa'. What are you doing with the words?",
                options: ["Eating them", "Saying them", "Touching them", "Hearing them"],
                correctAnswer: "Saying them",
                explanation: "This is a vocabulary question about actions. To cast a spell, you must say the magic words. The verb 'to say' means to speak words."
            },
            B1: {
                question: "Which of these describes the wand movement 'swish and flick'?",
                options: ["A long curve and a sharp jab", "A circle and a tap", "A straight line and a wave", "Up and down"],
                correctAnswer: "A long curve and a sharp jab",
                explanation: "This is a vocabulary question based on physical actions. A 'swish' is a smooth, curving movement. A 'flick' is a short, quick movement. 'A long curve and a sharp jab' is the best description of this."
            },
            B2: {
                question: "Hermione says, 'You're saying it wrong. It's Levi-O-sa, not Levio-SAR.' Her correction is about:",
                options: ["Pronunciation", "Grammar", "Vocabulary", "Spelling"],
                correctAnswer: "Pronunciation",
                explanation: "'Pronunciation' refers to the way in which a word is spoken. Hermione is correcting the sound and emphasis of the syllables, which is a matter of pronunciation, crucial for magic."
            },
            C1: {
                question: "If you perform the charm correctly, the feather will levitate. 'Levitate' means to:",
                options: ["Burn with a bright light", "Change color rapidly", "Rise and float in the air", "Shrink to a tiny size"],
                correctAnswer: "Rise and float in the air",
                explanation: "This is a vocabulary question. The verb 'to levitate' means to rise or cause to rise and float in the air, seemingly in defiance of gravity."
            },
            reward: { type: 'flag_set', flag: 'knows_leviosa', successMessage: "You try again, focusing on the movement and the pronunciation. 'Wingardium Leviosa!' The feather on your desk trembles and lifts into the air! You've done it!" },
            failureMessage: "You swish and flick, but the feather just rolls over. 'Not quite,' squeaks Professor Flitwick."
        },
        'diagonAlleyWall': {
            A2: {
                question: "Hagrid says to tap the bricks in the correct order. Which word means 'in a sequence'?",
                options: ["Correctly", "Quickly", "Carefully", "Gently"],
                correctAnswer: "Correctly",
                explanation: "'Correctly' is an adverb that means in the right way. Tapping the bricks in the correct sequence or order is necessary for the magic to work."
            },
            B1: {
                question: "The instructions are a sequence of actions. Which sentence structure is best for giving instructions?",
                options: ["You would tap the brick.", "The brick was tapped by you.", "Tapping the brick.", "Tap the brick."],
                correctAnswer: "Tap the brick.",
                explanation: "The Imperative mood (e.g., 'Tap the brick.') is used to give direct orders and instructions. It's clear and concise."
            },
            B2: {
                question: "Complete the instruction: 'Count three bricks up, ___ go two across.'",
                options: ["and then", "after that", "so", "because"],
                correctAnswer: "and then",
                explanation: "'And then' is a common and clear conjunction used to link sequential steps in instructions. 'After that' also works, but 'and then' is very frequent in spoken instructions."
            },
            C1: {
                question: "Which sentence most precisely describes the wall's transformation?",
                options: ["The wall is opening.", "The wall, which was solid, began to reconfigure itself.", "The wall opened.", "The wall might open."],
                correctAnswer: "The wall, which was solid, began to reconfigure itself.",
                explanation: "'Reconfigure' is a more precise and sophisticated verb than 'open'. The use of a non-defining relative clause ('which was solid') adds important detail, making the sentence more descriptive and advanced."
            },
            reward: { type: 'move_to', room: 'diagonAlley', successMessage: "You watch as Hagrid taps the bricks. A small hole appears, and it grows wider and wider until you are looking at an archway onto a cobbled street." },
            failureMessage: "You tap a few random bricks, but nothing happens. It seems to be a specific pattern."
        },
        'gringottsKey': {
            A2: {
                question: "Griphook needs the key. You say, 'I ___ the key.'",
                options: ["has", "is", "are", "have"],
                correctAnswer: "have",
                explanation: "With the subject 'I', the correct present tense form of the verb 'to have' is 'have'. We say 'I have', 'you have', 'he/she/it has'."
            },
            B1: {
                question: "Which is the most polite way to present the key?",
                options: ["Here's the key.", "Give me my money.", "The key is here.", "I demand to go to my vault."],
                correctAnswer: "Here's the key.",
                explanation: "'Here's...' or 'Here is...' is a standard polite phrase used when giving something to someone. The other options are either demanding or less direct."
            },
            B2: {
                question: "Griphook says, 'The key must be presented for entry.' This is an example of:",
                options: ["Active voice", "Passive voice", "An imperative", "A suggestion"],
                correctAnswer: "Passive voice",
                explanation: "In the passive voice, the subject of the sentence receives the action. Here, 'The key' is the subject, and it is being 'presented'. The person doing the presenting is not the focus. The active form would be 'You must present the key'."
            },
            C1: {
                question: "Which sentence implies the key is a necessary but not sufficient condition for entry?",
                options: ["Only with the key can you enter.", "You must have the key to enter.", "Entry is contingent upon presentation of the key, among other security protocols.", "If you have the key, you can enter."],
                correctAnswer: "Entry is contingent upon presentation of the key, among other security protocols.",
                explanation: "'Contingent upon' means 'depending on'. The phrase 'among other... protocols' explicitly states that the key is just one of several requirements, making it necessary but not sufficient (not enough on its own)."
            },
            reward: { type: 'move_to', room: 'vault687', successMessage: "You hand the key to Griphook. He inspects it and nods. 'Very well. Follow me.' He leads you to a cart that speeds down a winding track into the depths of the bank." },
            failureMessage: "Griphook looks at you impatiently. 'The key, please.'"
        },
        'platformBarrier': {
            A2: {
                question: "Mrs. Weasley tells you what to do. 'You ___ run at the wall.'",
                options: ["must to", "have to", "should to", "are"],
                correctAnswer: "have to",
                explanation: "The modal expression 'have to' is used to show strong obligation, especially when the obligation comes from an external source (like instructions). It is followed by the base form of the verb ('run'). 'Must to' and 'should to' are grammatically incorrect."
            },
            B1: {
                question: "What is the best way to ask for clarification if you are nervous?",
                options: ["Explain again?", "Are you quite sure about that?", "What?", "You want me to run at a wall?"],
                correctAnswer: "Are you quite sure about that?",
                explanation: "'Are you quite sure...?' is a polite way to express doubt or ask for confirmation. It's less confrontational than 'You want me to...?' and more complete than the other, very informal options."
            },
            B2: {
                question: "You are feeling nervous. Which sentence best expresses this feeling using more advanced vocabulary?",
                options: ["Running at walls is being scary.", "I have some trepidation about this.", "This is a bit bad.", "I am scared."],
                correctAnswer: "I have some trepidation about this.",
                explanation: "'Trepidation' is a noun that means a feeling of fear or agitation about something that may happen. It's a more formal and descriptive word than 'scared'."
            },
            C1: {
                question: "Which literary device is being used when a solid, mundane object like a wall acts as a gateway to a magical world?",
                options: ["Metaphor", "Juxtaposition", "Personification", "Paradox"],
                correctAnswer: "Juxtaposition",
                explanation: "Juxtaposition is the act of placing two elements side-by-side to compare or contrast them. Here, the ordinary (a brick wall at a train station) is placed directly against the extraordinary (a portal to a magical world), creating a powerful effect."
            },
            reward: { type: 'move_to', room: 'hogwartsExpress', successMessage: "You take a deep breath, close your eyes, and run. Instead of crashing, you pass straight through the barrier and emerge onto a crowded platform next to a scarlet steam engine. You've made it!" },
            failureMessage: "You hesitate. The idea of running into a solid brick wall seems insane."
        },
        'hagridTrust': {
            A2: {
                question: "Hagrid says, 'Yeh're a wizard, Harry.' How would you ask a question about this?",
                options: ["A wizard I am?", "Wizard, me?", "Am I a wizard?", "I am a wizard?"],
                correctAnswer: "Am I a wizard?",
                explanation: "To form a question from a statement with the verb 'to be' (like 'You are a wizard'), we invert the subject and the verb. 'You are' becomes 'Am I?' (adjusting for the change from 'you' to 'I')."
            },
            B1: {
                question: "Hagrid says, 'I haven't seen you since you was a baby.' Which part is informal/incorrect grammar?",
                options: ["I haven't seen you", "since you was a baby", "No error"],
                correctAnswer: "since you was a baby",
                explanation: "The subject 'you' always takes the plural verb form, even when it refers to one person. The correct past tense of 'to be' for 'you' is 'were', not 'was'. The correct sentence is '...since you were a baby'."
            },
            B2: {
                question: "Convert Hagrid's statement to reported speech: Hagrid said, 'I'm taking you to Hogwarts.'",
                options: ["Hagrid said he is taking me to Hogwarts.", "Hagrid said I was taking him to Hogwarts.", "Hagrid said that he was taking me to Hogwarts."],
                correctAnswer: "Hagrid said that he was taking me to Hogwarts.",
                explanation: "In reported (or indirect) speech, we often shift the tense back. The Present Continuous ('am taking') becomes the Past Continuous ('was taking'). Pronouns also change: 'I' becomes 'he', and 'you' becomes 'me'."
            },
            C1: {
                question: "Which sentence best captures the hypothetical situation of refusing Hagrid's offer in the past?",
                options: ["If I will refuse, I will stay here.", "Had I refused, I would have stayed here.", "If I refuse, I stay here.", "If I would refuse, I would stay here."],
                correctAnswer: "Had I refused, I would have stayed here.",
                explanation: "This is an example of the Third Conditional, used for unreal past situations. The structure is 'If + past perfect, ...would have + past participle'. 'Had I refused...' is a common inversion of 'If I had refused...' and has the same meaning."
            },
            reward: { type: 'move_to', room: 'leakyCauldron', successMessage: "You decide to trust Hagrid. He nods, and with a swirl of his coat, you feel a strange pulling sensation. The dingy hut disappears, replaced by a dark, bustling pub." },
            failureMessage: "Hagrid looks a bit disappointed. 'C'mon Harry, yeh've got to trust me.'"
        },
        'cupboardDoor': {
            A2: {
                question: "To open the door, you need to use the correct preposition. 'The key goes ___ the lock.'",
                options: ["on", "in", "at", "with"],
                correctAnswer: "in",
                explanation: "We use the preposition 'in' to show that something is entering a space. The key enters the space inside the lock. 'On' is for surfaces, 'at' is for a specific point, and 'with' is used to show accompaniment."
            },
            B1: {
                question: "Which sentence is grammatically correct for expressing a wish about the present?",
                options: ["I wish the door will open.", "I wish the door would open.", "I wish the door has opened.", "I wish the door opens."],
                correctAnswer: "I wish the door would open.",
                explanation: "To express a wish about a present situation that we want to be different, we use 'I wish + subject + would + verb' for actions, or 'I wish + subject + past simple' for states. 'I wish it would open' expresses a desire for a future action based on a present feeling. 'Will' is incorrect for wishes."
            },
            B2: {
                question: "Complete the sentence with the most appropriate phrasal verb: 'You need to ___ how to open this lock.'",
                options: ["make out", "get by", "figure out", "look up"],
                correctAnswer: "figure out",
                explanation: "'Figure out' means to understand or find a solution to a problem. 'Make out' means to see or hear something with difficulty, 'get by' means to manage with little money, and 'look up' means to search for information."
            },
            C1: {
                question: "Which of the following is an example of the subjunctive mood to express a hypothetical situation?",
                options: ["I hope the door opens.", "The door will be opened.", "If I were to open the door, I would be free.", "Opening the door is my primary objective."],
                correctAnswer: "If I were to open the door, I would be free.",
                explanation: "The subjunctive mood is used for hypothetical or non-real situations. The phrase 'If I were...' is a classic example of the subjunctive, used here to talk about an unlikely or imaginary event. The other options are indicative (stating facts or beliefs) or imperative."
            },
            reward: { type: 'move_to', room: 'privetDriveHallway', successMessage: "With a click, the lock turns! Aunt Petunia opens the door with a shriek. 'Up! Get up! Now!'" },
            failureMessage: "That doesn't seem to work. The lock remains stubbornly shut."
        },
        'fatLadyPassword': {
            A2: {
                question: "What is the password? (Hint: re-read the description for the Great Hall)",
                options: ["Open Sesame", "Friend", "Caput Draconis", "Password"],
                correctAnswer: "Caput Draconis",
                explanation: "This is a reading comprehension question. The text for the Great Hall states the password is 'Caput Draconis'. It's important to pay attention to details in the story!"
            },
            B1: {
                question: "The prefect says you must state the password 'clearly'. The word 'clearly' is:",
                options: ["An adjective", "An adverb", "A noun", "A verb"],
                correctAnswer: "An adverb",
                explanation: "Adverbs describe verbs. 'Clearly' describes *how* you should state the password (the verb 'state'). Adjectives describe nouns. 'Clear' is the adjective form."
            },
            B2: {
                question: "If you forget the password, what is the most polite way to ask a prefect?",
                options: ["What's the password again?", "Could you please remind me of the password?", "Tell me the password.", "Password?"],
                correctAnswer: "Could you please remind me of the password?",
                explanation: "'Could you please...?' is a formal and polite way to make a request. 'Tell me...' is an impolite command. 'What's the password again?' is too informal for a prefect, and 'Password?' is very rude."
            },
            C1: {
                question: "The portrait of the Fat Lady acts as a sentient guardian. The literary term for giving human qualities to an inanimate object is:",
                options: ["Simile", "Metaphor", "Personification", "Alliteration"],
                correctAnswer: "Personification",
                explanation: "Personification is a figure of speech where human attributes are given to an animal, an inanimate object, or an abstract idea. A painting that can talk and think is a perfect example."
            },
            reward: { type: 'move_to', room: 'gryffindorCommonRoom', successMessage: "You say 'Caput Draconis'. The Fat Lady smiles. 'Very well,' she says, and her portrait swings open to reveal a hole in the wall." },
            failureMessage: "The Fat Lady looks at you sternly. 'That is not the correct password.'"
        },
        'trollEncounter': {
            A2: {
                question: "Ron shouts a command. '___ the spell!'",
                options: ["You do", "Doing", "To do", "Do"],
                correctAnswer: "Do",
                explanation: "For commands or instructions (the imperative form), we use the base form of the verb without a subject. 'Do the spell!' is a direct command."
            },
            B1: {
                question: "To make the club float, you should say 'Wingardium Leviosa'. Which syllable should be emphasized?",
                options: ["Wing-GAR-dium", "Levi-O-sa", "There is no emphasis.", "Both equally."],
                correctAnswer: "Levi-O-sa",
                explanation: "This is a key plot point from the book and movie. Hermione corrects Ron by saying, 'It's Levi-O-sa, not Levio-SAR!' Proper pronunciation and emphasis are crucial for casting spells correctly."
            },
            B2: {
                question: "Complete the sentence: 'The spell caused the troll's club to ___ out of its hand.'",
                options: ["flew", "flown", "fly", "flying"],
                correctAnswer: "fly",
                explanation: "After causative verbs like 'make', 'let', and 'have', we use the bare infinitive (the verb without 'to'). The structure is 'cause someone/something to do something'. Therefore, 'caused the club to fly' is correct."
            },
            C1: {
                question: "Which sentence uses the most vivid and active verbs to describe the scene?",
                options: ["The troll was hit by the club.", "The club fell on the troll's head.", "The levitated club hovered precariously, then plummeted, striking the troll with a sickening crunch.", "The troll got knocked out."],
                correctAnswer: "The levitated club hovered precariously, then plummeted, striking the troll with a sickening crunch.",
                explanation: "Strong, active verbs create more engaging and descriptive writing. 'Hovered', 'plummeted', 'striking' are much more powerful and create a clearer mental image than the passive ('was hit') or simple verbs ('fell', 'got')."
            },
            reward: { type: 'flag_set', flag: 'troll_defeated', successMessage: "You shout 'Wingardium Leviosa!' and flick your wand. The troll's own club rises into the air, wobbles, and then drops right on its head. The troll sways and collapses with a floor-shaking thud. You've saved Hermione!" },
            failureMessage: "You try to cast the spell, but nothing happens! The troll raises its club higher."
        },
        'fluffyDoor': {
             A2: { correctAnswer: '', explanation: "Some magical creatures have weaknesses that can be exploited. Music is known to soothe savage beasts." },
             B1: { correctAnswer: '', explanation: "Some magical creatures have weaknesses that can be exploited. Music is known to soothe savage beasts." },
             B2: { correctAnswer: '', explanation: "Some magical creatures have weaknesses that can be exploited. Music is known to soothe savage beasts." },
             C1: { correctAnswer: '', explanation: "Some magical creatures have weaknesses that can be exploited. Music is known to soothe savage beasts." },
             reward: { type: 'move_to', room: 'trapdoorRoom', successMessage: "The door clicks open. You carefully push its giant paw aside and lift the heavy trapdoor, revealing a dark hole. You climb down." },
             failureMessage: "You try to sneak past, but one of the heads opens a sleepy eye. A low growl rumbles in its chest."
        },
        'devilsSnare': {
            A2: {
                question: "Hermione shouts the plant's weakness. 'It ___ the dark and damp.'",
                options: ["like", "likes", "is liking", "are liking"],
                correctAnswer: "likes",
                explanation: "In the Present Simple tense, for third-person singular subjects (he, she, it), we add -s to the verb. So, 'it likes'. We don't typically use 'like' in the continuous form ('is liking')."
            },
            B1: {
                question: "To fight it, you need the opposite of dark. Which is the best spell?",
                options: ["A spell for water.", "A spell for wind.", "A spell for fire or light.", "A spell for making things quiet."],
                correctAnswer: "A spell for fire or light.",
                explanation: "This is a logic and comprehension question. The text states the plant likes the dark, so the logical opposite to use against it would be light or something that produces light, like fire."
            },
            B2: {
                question: "Hermione panics, 'I can't remember any fire spells!' You should tell her to:",
                options: ["calming down", "calm down", "becoming calm", "calms down"],
                correctAnswer: "calm down",
                explanation: "When giving a direct command or suggestion (the imperative), we use the base form of the verb. 'Calm down' is the correct imperative phrase."
            },
            C1: {
                question: "Complete the First Conditional sentence: 'If Hermione ___, the plant will retreat.'",
                options: ["had cast", "casts", "would cast", "cast"],
                correctAnswer: "casts",
                explanation: "The First Conditional is used for real possibilities in the future. The structure is 'If + Present Simple, ... will + base verb'. So, 'If Hermione casts...'"
            },
            reward: { type: 'move_to', room: 'flyingKeysRoom', successMessage: "Hermione remembers a spell! 'Lumos Solem!' A jet of brilliant sunlight erupts from her wand. The Devil's Snare recoils from the light and heat, releasing you all. You tumble through to the next chamber." },
            failureMessage: "You struggle, but the vines only tighten their grip. 'You have to relax!' Hermione cries."
        },
        'flyingKey': {
            A2: {
                question: "The key you need has a broken wing. It is more ___ than the others.",
                options: ["shiny", "fast", "slow", "heavy"],
                correctAnswer: "slow",
                explanation: "This is a logic and vocabulary question. A broken wing would impede its flight, making it 'slow' compared to the other keys with intact wings."
            },
            B1: {
                question: "Which sentence uses the correct relative pronoun to describe the key?",
                options: ["I need the key who has a broken wing.", "I need the key where has a broken wing.", "I need the key which has a broken wing."],
                correctAnswer: "I need the key which has a broken wing.",
                explanation: "The relative pronoun 'which' (or 'that') is used to refer to things. 'Who' is used for people, and 'where' is used for places."
            },
            B2: {
                question: "To catch the key, you'll need to be fast. Which is an adverb of manner?",
                options: ["Quick", "Quickly", "Quicken", "Quickness"],
                correctAnswer: "Quickly",
                explanation: "An adverb of manner describes *how* an action is done. They often end in '-ly'. You need to fly quickly. 'Quick' is the adjective, 'quicken' is the verb, and 'quickness' is the noun."
            },
            C1: {
                question: "Which sentence is the most evocative and uses dynamic language to describe the chase?",
                options: ["I flew fast on the broom and got the key.", "The key was hard to catch.", "I urged the broom onward, weaving through the whirlwind of silver wings, my fingers closing around the cold metal of the correct key just as it tried to dart away.", "I got on the broom to get the key from the other keys."],
                correctAnswer: "I urged the broom onward, weaving through the whirlwind of silver wings, my fingers closing around the cold metal of the correct key just as it tried to dart away.",
                explanation: "Evocative language uses strong verbs ('urged', 'weaving', 'closing', 'dart'), descriptive adjectives ('whirlwind', 'silver', 'cold'), and sensory details to create a vivid picture for the reader. The other options are much more simplistic and less engaging."
            },
            reward: { type: 'move_to', room: 'chessChamber', successMessage: "You kick off on the broom, soaring into the air. After a thrilling chase, you snatch the old, silver key with the battered wing out of the air. It fits the lock perfectly!" },
            failureMessage: "You grab a key at random, but it doesn't fit the lock. The correct key is too nimble to catch with your bare hands!"
        },
        'chessPuzzle': {
            A2: {
                question: "Ron says 'We ___ to play.' What is the missing word?",
                options: ["is", "are", "have", "must"],
                correctAnswer: "have",
                explanation: "The expression 'have to' is used to show obligation or necessity, similar to 'must'. Since the subject is 'We', the correct form is 'have'. 'We have to play.'"
            },
            B1: {
                question: "To win, Ron must let the Queen take him. How would he express this intention for the future?",
                options: ["I will be letting the Queen take me.", "I am going to let the Queen take me.", "I am taken by the Queen.", "I was letting the Queen take me."],
                correctAnswer: "I am going to let the Queen take me.",
                explanation: "'Be going to' is used to express a future plan or intention that has already been decided. Ron has made a decision, so this is the most appropriate form. 'Will' is for spontaneous decisions, and the others are the wrong tense."
            },
            B2: {
                question: "Which sentence correctly connects the two ideas (Ron's sacrifice and the victory)?",
                options: ["Ron's move, despite being a sacrifice, was ultimately what has led to their victory.", "Ron's move was a sacrifice, which led to their victory.", "Because Ron's move was a sacrifice, so they won.", "Ron's move led to their victory and it was a sacrifice."],
                correctAnswer: "Ron's move was a sacrifice, which led to their victory.",
                explanation: "A non-defining relative clause using ', which' is perfect here. It adds extra information about 'the sacrifice' without being essential to the sentence's main meaning. Using both 'Because' and 'so' is redundant and incorrect."
            },
            C1: {
                question: "The situation requires a 'Pyrrhic victory' - a win that comes at a great cost. Which sentence best defines this concept?",
                options: ["A victory where the losses are so devastating, it is tantamount to defeat.", "A victory that is achieved very easily.", "A victory that is not really a victory at all.", "A victory that ensures no one gets hurt."],
                correctAnswer: "A victory where the losses are so devastating, it is tantamount to defeat.",
                explanation: "This is a vocabulary question about the specific idiom 'Pyrrhic victory'. It originates from King Pyrrhus of Epirus, whose army suffered irreplaceable casualties in defeating the Romans. The correct definition is a victory that comes at such a high price it feels like a loss."
            },
            reward: {
                type: 'move_to',
                room: 'potionsRiddleRoom',
                successMessage: (flags) => {
                    if (flags.ron_saved_by_soldiers) {
                        return "Ron uses your enchanted toy soldiers for the final sacrifice. The stone Queen smashes them to pieces, but it gives you the opening! You checkmate the king. The black king throws down his crown, and the remaining pieces bow. 'That was amazing!' Ron says, unharmed. You run to the next door together.";
                    } else {
                        return "Ron directs the game with incredible skill. Finally, he sees the only way to win. He sacrifices himself, and the white queen strikes him down. He falls to the floor, motionless. The sacrifice allows you to checkmate the king. The black king throws down his crown. You and Hermione run to the next door, leaving Ron behind.";
                    }
                }
            },
            failureMessage: "You make a move, but the giant stone Queen smashes your piece to dust. This is more dangerous than you thought."
        },
        'potionsRiddle': {
            A2: {
                question: "The riddle says one potion will move you forward. What does 'forward' mean?",
                options: ["Back", "Ahead", "Stop", "Around"],
                correctAnswer: "Ahead",
                explanation: "'Forward' is a directional adverb that means in the direction that one is facing or traveling. 'Ahead' is a direct synonym in this context."
            },
            B1: {
                question: "The riddle uses comparative adjectives to compare potions. Which is the correct comparative form of 'small'?",
                options: ["More small", "Smaller", "Smallest", "As small"],
                correctAnswer: "Smaller",
                explanation: "For short, one-syllable adjectives like 'small', we form the comparative by adding -er at the end ('smaller') and the superlative by adding -est ('smallest'). 'More small' is incorrect."
            },
            B2: {
                question: "'One will let you safely through, another will transport you back.' The modal verb 'will' in these sentences expresses:",
                options: ["Certainty", "Possibility", "Obligation", "Speculation"],
                correctAnswer: "Certainty",
                explanation: "In this context, the riddle is stating a fact about the potions' functions. The modal verb 'will' is used to express certainty or a definite future outcome. It's not a possibility; it is a guaranteed result."
            },
            C1: {
                question: "The riddle is a logic puzzle that requires a process of elimination. This process is also known as:",
                options: ["Inductive reasoning", "Abductive reasoning", "Circular reasoning", "Deductive reasoning"],
                correctAnswer: "Deductive reasoning",
                explanation: "Deductive reasoning is a logical process where you reach a conclusion by starting with a general set of rules or premises and then working towards a specific conclusion. Eliminating possibilities based on the riddle's clues is a classic example of deduction."
            },
            reward: { type: 'move_to', room: 'finalChamber', successMessage: "You carefully read the riddle, eliminating the poisons and the potion to go back. You pick up the smallest bottle, which contains the potion to move ahead. You drink it, and feel a cold sensation as you step through the purple flames unharmed." },
            failureMessage: "You look at the bottles, confused. Choosing the wrong one could be your last mistake."
        }
    },

    open() {
        // Reset the game state and UI completely when opening the hub.
        this.gameState = {};
        this.activePuzzle = null;
        const modal = document.getElementById('text-adventure-modal');
        const modalContent = document.querySelector('#text-adventure-modal .modal-content');

        // Restore the initial start screen content.
        modalContent.id = 'text-adventure-modal-content'; // Reset ID to its original state
        modalContent.innerHTML = `
            <div id="ta-start-screen" class="p-6 text-center">
                <span class="modal-close-btn" onclick="TextAdventure.close()">&times;</span>
                <h3 class="font-magic-header text-3xl text-[#FFD700] mb-4">Harry Potter and the Philosopher's Stone</h3>
                <p class="mb-6 text-gray-300">This is a text-based adventure that will test your knowledge of the English language. Please select your proficiency level to begin.</p>
                <div class="grid grid-cols-2 gap-4 max-w-lg mx-auto">
                    <button class="btn btn-gold" onclick="TextAdventure.startGame('A2')">A2 (Beginner)</button>
                    <button class="btn btn-gold" onclick="TextAdventure.startGame('B1')">B1 (Intermediate)</button>
                    <button class="btn btn-gold" onclick="TextAdventure.startGame('B2')">B2 (Upper-Intermediate)</button>
                    <button class="btn btn-gold" onclick="TextAdventure.startGame('C1')">C1 (Advanced)</button>
                </div>
                <p class="text-xs text-gray-500 mt-6">This game is a fan-made tribute and is not affiliated with J.K. Rowling, Warner Bros., or their affiliates.</p>
            </div>`;
        modal.classList.add('show');
    },

    close() {
        document.getElementById('text-adventure-modal').classList.remove('show');
        // Clean up to be safe
        this.gameState = {};
        this.activePuzzle = null;
    },

    startGame(difficulty) {
        this.gameState = {
            currentRoom: 'cupboardUnderStairs',
            previousRoom: 'cupboardUnderStairs',
            inventory: [],
            flags: {},
            difficulty: difficulty
        };
        this.renderGameUI();
        this.renderRoom();
    },

    renderGameUI() {
        const modalContent = document.querySelector('#text-adventure-modal .modal-content');
        modalContent.id = 'ta-modal-content'; // Ensure the ID is correct for styling
        modalContent.innerHTML = `
            <div class="flex-shrink-0 p-2 bg-[#1A2B3C] border-b-2 border-[#FFD700] flex justify-between items-center">
                 <div id="rule-explanation-container" class="flex-grow"></div>
                 <div class="flex gap-2">
                    <button class="btn btn-gold text-sm" onclick="TextAdventure.showHint()">Hint</button>
                    <button class="btn btn-destructive text-sm" onclick="TextAdventure.close()">Close Adventure</button>
                </div>
            </div>
            <div id="ta-output" class="flex-grow p-4 md:p-6 overflow-y-auto"></div>
            <div id="inventory-display" class="flex-shrink-0 p-2 bg-[#0C1C33] border-t border-gray-700 min-h-[60px]"></div>
            <div class="flex-shrink-0 p-4 bg-[#1A2B3C] border-t-2 border-[#FFD700]">
                <div class="flex items-center gap-4">
                    <span class="font-bold text-[#FFD700]">&gt;</span>
                    <input type="text" id="ta-input" placeholder="Type your command..." class="w-full p-2 rounded" autocomplete="off">
                </div>
            </div>
        `;
        document.getElementById('ta-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { this.processInput(); }
        });
        document.getElementById('ta-input').focus();
        this.renderInventory(); // Initial inventory render
    },

    showHint() {
        let hint = this.hintData[this.gameState.currentRoom];
        if (typeof hint === 'function') {
            hint = hint(this.gameState.flags);
        }
        if (!hint) {
            hint = this.hintData.default;
        }
        this.renderOutput(`Hint: ${hint}`, 'info');
    },

    processInput() {
        const inputField = document.getElementById('ta-input');
        const command = inputField.value.trim().toLowerCase();
        if (!command) return;

        document.getElementById('rule-explanation-container').innerHTML = '';

        this.renderOutput(`> ${command}`, 'command');
        inputField.value = '';

        const [verb, ...rest] = command.split(' ');
        const noun = rest.join(' ');

        const movementAliases = { 'n': 'north', 's': 'south', 'e': 'east', 'w': 'west' };
        if (Object.keys(movementAliases).includes(verb) || Object.values(movementAliases).includes(verb)) {
            this.handleMove(movementAliases[verb] || verb);
        } else {
            switch (verb) {
                case 'go': this.handleMove(noun); break;
                case 'look': this.handleExamine(noun || 'room'); break;
                case 'examine': case 'x': case 'read': this.handleExamine(noun); break;
                case 'take': case 'get': this.handleTake(noun); break;
                case 'i': case 'inventory': this.renderInventory(true); break;
                case 'help': this.renderHelp(); break;
                case 'open': this.handleOpen(noun); break;
                case 'use': this.handleUse(noun); break;
                case 'cast': case 'practice': this.handleCast(noun); break;
                case 'research': case 'search': this.handleResearch(noun); break;
                case 'talk': this.handleTalk(noun); break;
                case 'eat': this.handleEat(noun); break;
                case 'hint': this.showHint(); break;
                default:
                    this.renderOutput("I don't understand that command. Try 'help'.", 'error');
            }
        }
    },

    handleMove(direction) {
        const currentRoomData = this.worldData[this.gameState.currentRoom];
        const exitData = currentRoomData.exits[direction];

        if (!exitData) {
            this.renderOutput("You can't go that way.", 'error');
            return;
        }
        
        // Handle single flag requirement
        if (exitData.requiresFlag && !this.gameState.flags[exitData.requiresFlag]) {
            this.renderOutput(exitData.lockedDescription, 'info');
            return;
        }

        // Handle multiple flag requirement
        if (exitData.requiresFlags) {
            const allFlagsMet = exitData.requiresFlags.every(flag => this.gameState.flags[flag]);
            if (!allFlagsMet) {
                this.renderOutput(exitData.lockedDescription, 'info');
                return;
            }
        }

        if (this.gameState.currentRoom === 'potionsRiddleRoom' && direction === 'forward' && !this.gameState.flags.potions_quiz_passed) {
            this.renderOutput("You stare at the bottles, but the logic of the riddle escapes you. You remember Snape's harsh lessons and realize you didn't learn enough to solve this. You must have passed his quiz to proceed.", 'error');
            return;
        }

        if (exitData.event) {
            if (this.handleEvent(exitData.event)) return;
        }

        if (exitData.locked) {
            if (exitData.puzzle) {
                 if (exitData.puzzle === 'fatLadyPassword') {
                    const password = prompt("The Fat Lady looks at you expectantly. 'Password?'");
                    if (password && this.gameState.flags.password && password.toLowerCase() === this.gameState.flags.password.toLowerCase()) {
                         this.checkAnswer({textContent: 'Caput Draconis'}, true);
                    } else { this.renderOutput(this.puzzles.fatLadyPassword.failureMessage, 'error'); }
                 } else if (exitData.puzzle === 'filchEncounter') {
                    this.renderOutput("You take a step towards the stairs, but a wheezing voice calls out 'Who's there?!'. You've been spotted! You quickly retreat before you get detention. You'll need a way to be unseen.", 'error');
                 }
                 else {
                    this.handlePuzzle(this.puzzles[exitData.puzzle]);
                }
            } else {
                this.renderOutput(exitData.description || "It's locked.", 'info');
            }
            return;
        }

        this.gameState.previousRoom = this.gameState.currentRoom;
        this.gameState.currentRoom = exitData.to;
        this.renderRoom();
    },

    handleEvent(eventName) {
        const flags = this.gameState.flags;
        if (eventName === 'firstLetter' && !flags.first_letter_arrived) {
            flags.first_letter_arrived = true;
            this.worldData.privetDriveHallway.items.push({ id: 'letter', name: 'a strange letter on the mat', description: "It's a thick, yellowish envelope... addressed to 'Mr. H. Potter, The Cupboard under the Stairs'." });
            this.renderOutput("As you reach for the front door, you hear the mail slot click and a letter falls onto the mat.", "event");
            this.renderRoom(true);
            return true;
        }
        if (eventName === 'letterFlood' && flags.letter_taken_once && !flags.letters_flood) {
            flags.letters_flood = true;
            this.worldData.livingRoom.description = "You are in the living room. It's an absolute mess of letters! They are pouring out of the boarded-up fireplace, covering every surface. Uncle Vernon looks furious.";
            this.renderOutput("You go back to the living room. Suddenly, a storm of letters comes shooting out of the fireplace! There must be hundreds!", "event");
             setTimeout(() => {
                 this.renderOutput("'That's it!' Uncle Vernon screams. 'We're leaving! Far away!' The world becomes a blur of car rides and strange hotels, until you finally arrive at a miserable hut on a rock in the middle of the sea.", "event");
                 this.gameState.currentRoom = 'hutOnTheRock';
                 this.renderRoom();
             }, 3000);
            return true;
        }
        if (eventName === 'goToPlatform' && flags.shopping_complete) {
            this.renderOutput("You meet Hagrid back in the pub. 'Got everything?' he asks, before leading you through London to King's Cross Station.", "event");
            this.gameState.currentRoom = 'platform934';
            setTimeout(() => this.renderRoom(), 1500);
            return true;
        }
        return false;
    },

    handleTake(noun) {
        const room = this.worldData[this.gameState.currentRoom];

        if (noun.includes('broom') && this.gameState.currentRoom === 'flyingKeysRoom' && !this.gameState.flags.knows_flying) {
            this.renderOutput("You reach for the broom, but you have no idea how to fly it properly. You should complete your first flying lesson before attempting this.", 'error');
            return;
        }

        const itemIndex = room.items.findIndex(item => item.name.toLowerCase().includes(noun));
        if (itemIndex > -1) {
            const [item] = room.items.splice(itemIndex, 1);

            if (item.id === 'letter' && !this.gameState.flags.letter_taken_once) {
                this.gameState.flags.letter_taken_once = true;
                this.renderOutput(`You took the letter. But before you can open it, Uncle Vernon snatches it from you. 'Who'd be writing to you?' he snarls.`, 'info');
                this.worldData.livingRoom.exits.west.event = 'letterFlood';
                return;
            }
            if (item.id === 'cake') {
                 this.gameState.inventory.push({ id: 'cake', name: 'a birthday cake', description: "A large, sticky chocolate cake." });
                 this.renderOutput(`You took the squashed box. Inside is a birthday cake!`, 'success');
                 this.gameState.flags.hagrid_met = true;
                 this.renderRoom(true);
                 return;
            }

            if (item.id === 'galleons') this.gameState.flags.has_money = true;
            if (item.id === 'robes') this.gameState.flags.has_robes = true;
            if (item.id === 'school_books') this.gameState.flags.has_books = true;
            if (item.id === 'feather') this.gameState.flags.feather_taken = true;
            if (item.id === 'broomstick') this.gameState.flags.broomstick_taken = true;
            if (item.id === 'invisibility_cloak') {
                this.gameState.flags.cloak_taken = true;
            }
            if (item.id === 'invisibility_cloak' || item.id === 'flute') {
                if (this.worldData.gryffindorCommonRoom.items.length === 0) {
                     this.gameState.flags.gifts_taken = true;
                }
            }


            this.gameState.inventory.push(item);
            this.renderOutput(`You took the ${item.name.replace(/a |an |a set of |a pile of |a piece of /,'')}.`, 'success');

            this.checkStoryProgress();
            this.renderRoom(true); // Re-render room to show item is gone
            this.renderInventory(); // Update inventory display

        } else { this.renderOutput("You don't see that here.", 'error'); }
    },
    
    checkChristmasStatus() {
        const flags = this.gameState.flags;
        if (flags.knows_leviosa && flags.potions_quiz_passed && flags.knows_flying && !flags.is_christmas) {
            flags.is_christmas = true;
            this.renderOutput("You've completed your first round of classes! Time passes, and the castle is soon decorated for the holidays. Christmas has arrived! You've heard there's a present waiting for you back in the Gryffindor common room.", "event");
            this.worldData.gryffindorCommonRoom.items.push({
                id: 'invisibility_cloak',
                name: 'a strange silvery cloak',
                description: "A note attached to it says 'Your father left this in my possession before he died. It is time it was returned to you. Use it well.' It's an invisibility cloak!"
            });
        }
    },

    checkStoryProgress() {
        const flags = this.gameState.flags;
        if (flags.has_money && flags.has_wand && flags.has_robes && flags.has_books && !flags.shopping_complete) {
            flags.shopping_complete = true;
            this.renderOutput("You now have all your school supplies! Hagrid is waiting for you back at the Leaky Cauldron. You should `go pub` to meet him and go to the train station.", "event");
        }
    },

    handleExamine(noun) {
        if (!noun || noun === 'room') { this.renderRoom(true); return; }

        if (noun.includes('mirror') && this.gameState.currentRoom === 'finalChamber') {
            if (this.gameState.flags.stone_acquired) {
                this.renderOutput("You see your reflection, looking triumphant with the stone safe in your pocket.", "info");
                return;
            }
            this.renderOutput("You look into the Mirror of Erised. At first, you see yourself standing with your parents. But as you focus on your mission to protect the Stone, the scene changes. Your reflection smiles, pulls a blood-red stone from its pocket, and puts it into its own pocket.", "event");
            setTimeout(() => {
                this.renderOutput("You feel a sudden weight in your real pocket. You've got the Philosopher's Stone!", "success");
                this.gameState.flags.stone_acquired = true;
                this.gameState.inventory.push({ id: 'philosophers_stone', name: 'the Philosopher\'s Stone', description: 'It glows with a warm, inner light.' });
                this.renderInventory();
                
                setTimeout(() => {
                    this.renderOutput("'He lies!' a high, cold voice says from the back of Quirrell's head. Quirrell lunges at you, but when he touches your skin, his hands blister and turn to ash. He crumbles away, leaving only a cloud of dark smoke that passes through you, knocking you unconscious.", "event");
                    
                    setTimeout(() => {
                        this.renderOutput("...", "info");
                        this.gameState.currentRoom = 'hospitalWing';
                        this.renderRoom();
                    }, 4000);
                }, 2000);
            }, 2000);
            return;
        }

        const room = this.worldData[this.gameState.currentRoom];
        const itemInRoom = room.items.find(item => item.name.toLowerCase().includes(noun));
        const itemInInventory = this.gameState.inventory.find(item => item.name.toLowerCase().includes(noun) || item.id.toLowerCase().includes(noun));

        if (itemInInventory && itemInInventory.id === 'dumbledore_card') {
            this.renderOutput("You look at the card. It's a Famous Wizard Card for Albus Dumbledore. On the back, it reads: 'CONSIDERED BY MANY THE GREATEST WIZARD OF MODERN TIMES, DUMBLEDORE IS PARTICULARLY FAMOUS FOR HIS DEFEAT OF THE DARK WIZARD GRINDELWALD IN 1945, FOR THE DISCOVERY OF THE TWELVE USES OF DRAGON'S BLOOD, AND HIS WORK ON ALCHEMY WITH HIS PARTNER, NICOLAS FLAMEL.' ... Flamel! That's the name you heard about!", 'success');
            this.gameState.flags.knows_flamel = true;
        }
        else if (noun.includes('hat') && this.gameState.currentRoom === 'greatHall' && !this.gameState.flags.sorted) { this.checkAnswer({textContent: ''}, true); }
        else if (noun.includes('ceiling') && this.gameState.currentRoom === 'greatHall') { this.renderOutput('The ceiling is bewitched to look like the sky outside. Tonight, it is clear and filled with stars.', 'info'); }
        else if (noun.includes('tables') && this.gameState.currentRoom === 'greatHall') { this.renderOutput('There are four long tables for the students, and one high table at the front for the teachers.', 'info'); }
        else if (itemInRoom) { this.renderOutput(itemInRoom.description, 'info'); }
        else if (itemInInventory) { this.renderOutput(itemInInventory.description, 'info'); }
        else { this.renderOutput("You don't see that here.", 'error'); }
    },

    handleOpen(noun) {
        const room = this.worldData[this.gameState.currentRoom];
        const exitKey = Object.keys(room.exits).find(k => noun.includes(k));

        if (exitKey === 'door' && this.gameState.currentRoom === 'thirdFloorCorridor' && !this.gameState.flags.knows_alohomora) {
            this.renderOutput("The door is locked tight. Hermione peers at the lock. 'I've read about this... it's a simple unlocking charm. You just say `Alohomora`! Now you know the spell, you should try to `cast alohomora`.'", 'event');
            this.gameState.flags.knows_alohomora = true;
            return;
        }

        if (exitKey) {
            if (exitKey === 'door' && this.gameState.currentRoom === 'thirdFloorCorridor' && !this.gameState.flags.fluffy_asleep) {
                this.renderOutput("You unlocked the door, but a furious set of barks from inside reminds you that a simple lock isn't the only thing guarding it. You quickly lock it again.", "info");
                return;
            }
            this.handleMove(exitKey);
        }
        else { this.renderOutput("You can't open that.", 'error'); }
    },

    handleUse(command) {
        const parts = command.split(' on ');
        const itemName = parts[0];
        const targetName = parts.length > 1 ? parts[1] : '';
        const item = this.gameState.inventory.find(i => i.name.toLowerCase().includes(itemName) || i.id.toLowerCase().includes(itemName));
        if (!item) { this.renderOutput(`You don't have a ${itemName}.`, 'error'); return; }

        if (item.id === 'invisibility_cloak' && this.gameState.currentRoom === 'hogwartsCorridor') {
            this.activePuzzle = this.puzzles.filchEncounter;
            this.checkAnswer({}, true);
        } else if (item.id === 'toy_soldiers' && this.gameState.currentRoom === 'chessChamber') {
            this.renderOutput("You have a sudden, brilliant idea. You pull out the broken toy soldiers and place them on an empty square. A strange magic flows from the board, and the soldiers grow to the size of real chess pawns! 'Wicked!' Ron exclaims. 'Now I can use them for the sacrifice!'", 'success');
            this.gameState.flags.ron_saved_by_soldiers = true;
            this.gameState.inventory = this.gameState.inventory.filter(i => i.id !== 'toy_soldiers');
            this.renderInventory();
        } else if (item.id === 'wand' && targetName.includes('troll') && this.gameState.currentRoom === 'girlsBathroom') {
            if (this.gameState.flags.knows_leviosa) { this.handlePuzzle(this.puzzles.trollEncounter); }
            else { this.renderOutput("You wave your wand, but you don't know any useful spells yet!", 'error'); }
        } else if (item.id === 'flute' && this.gameState.currentRoom === 'thirdFloorCorridor') {
            this.renderOutput("You play the flute. The soft, haunting melody causes the great beast's heads to droop one by one, until it slumps into a deep, snoring sleep.", 'success');
            this.gameState.flags.fluffy_asleep = true;
            this.renderRoom(true);
        } else if (item.id === 'gringotts_key' && this.gameState.currentRoom === 'gringotts') {
             this.handlePuzzle(this.puzzles.gringottsKey);
        } else if (item.id === 'feather' && this.gameState.currentRoom === 'flyingKeysRoom') {
            if (!this.gameState.inventory.find(i => i.id === 'broomstick')) {
                 this.renderOutput("You'd need to get much closer to use the feather. Try taking the `broomstick` first.", 'error');
                 return;
            }
            this.activePuzzle = this.puzzles.flyingKey;
            this.checkAnswer({}, true);
        } else { this.renderOutput("That doesn't seem to do anything here.", 'info'); }
    },

    handleCast(spellName) {
        if (this.gameState.currentRoom === 'charmsClassroom' && (spellName.includes('spell') || spellName.includes('leviosa'))) {
            this.handlePuzzle(this.puzzles.charmsLesson);
            return;
        }
        if (!this.gameState.inventory.find(i => i.id === 'wand')) { this.renderOutput("You don't have a wand!", 'error'); return; }

        if (spellName.includes('leviosa') && this.gameState.currentRoom === 'girlsBathroom' && !this.gameState.flags.troll_defeated) {
             this.handlePuzzle(this.puzzles.trollEncounter);
        } else if (spellName.includes('lumos') && this.gameState.currentRoom === 'trapdoorRoom') {
             this.handlePuzzle(this.puzzles.devilsSnare);
        } else if (spellName.includes('alohomora') && this.gameState.currentRoom === 'thirdFloorCorridor') {
            if (!this.gameState.flags.knows_alohomora) {
                this.renderOutput("You don't know that spell!", "error");
            } else if (!this.gameState.flags.fluffy_asleep) {
                this.renderOutput("With a click, the spell unlocks the door! But a furious bark from inside reminds you that a simple lock isn't the only thing guarding it. You quickly lock it again.", "info");
            } else {
                this.activePuzzle = this.puzzles.fluffyDoor;
                this.checkAnswer({}, true);
            }
        } else { this.renderOutput("You wave your wand and say the words, but nothing happens.", 'info'); }
    },

    handleResearch(topic) {
        if (this.gameState.currentRoom !== 'library') { this.renderOutput("You can only do research in the library.", 'error'); return; }
        if (topic.includes('flamel')) {
            this.renderOutput("You spend hours searching. Just as you're about to give up, you find a note in 'Potent Potions': 'Nicolas Flamel is the only known maker of the Philosopher's Stone!' The book also mentions the stone is guarded at Hogwarts by a three-headed dog named Fluffy, who Hagrid bought from a 'Greek chappie'.", 'success');
            this.gameState.flags.knows_flamel = true;
            this.renderRoom(true);
        } else { this.renderOutput("You search for information on that topic, but find nothing of interest.", 'info'); }
    },

    handleTalk(noun) {
        const target = noun.replace(/^to\s+/, '').trim();

        if (target.includes('snape') && this.gameState.currentRoom === 'potionsClassroom' && !this.gameState.flags.potions_quiz_passed) {
            this.renderOutput("Snape glares at you. 'You wish to speak to me, Potter? Very well. Let us see if your fame has translated into knowledge.'", 'event');
            this.handlePuzzle(this.puzzles.potionsQuestion1);
        }
        else if (target.includes('hooch') && this.gameState.currentRoom === 'flyingLessonGrounds' && !this.gameState.flags.knows_flying) {
            this.handlePuzzle(this.puzzles.flyingLesson);
        }
        else if (target.includes('hagrid') && this.gameState.currentRoom === 'hutOnTheRock') {
            this.gameState.flags.hagrid_met = true;
            this.handlePuzzle(this.puzzles.hagridTrust);
        }
        else if (target.includes('ron') && this.gameState.currentRoom === 'hogwartsExpress') {
            this.renderOutput("'Wicked,' says Ron, looking at your scar. 'So, is it true?' You spend the rest of the journey talking.", 'info');
            setTimeout(() => {
                this.renderOutput("The journey passes quickly as you and Ron talk and share sweets. The train finally slows down as it pulls into Hogsmeade station. You have arrived at Hogwarts!", "event");
                this.gameState.currentRoom = 'greatHall';
                this.renderRoom();
            }, 2000);
        }
        else if ((target.includes('mcgonagall') || target.includes('professor') || target.includes('hat')) && this.gameState.currentRoom === 'greatHall' && !this.gameState.flags.sorted) {
             this.checkAnswer({textContent: ''}, true);
        }
        else if (target.includes('ollivander') && this.gameState.currentRoom === 'ollivanders' && !this.gameState.flags.has_wand) {
            this.handlePuzzle(this.puzzles.wandChoice);
        }
        else if (target.includes('dumbledore') && this.gameState.currentRoom === 'hospitalWing') {
            this.renderOutput("'Ah, Harry. I was expecting you to wake.' Dumbledore's eyes twinkle. 'The stone is destroyed. As for Voldemort, he is still out there, but powerless for now. It was your mother's love, Harry, that protected you.' He smiles gently. 'Now, rest.'", 'info');
            this.renderOutput("THE END", 'success');
            document.getElementById('ta-input').disabled = true;
        }
        else { this.renderOutput("There is no one here by that name to talk to.", 'error'); }
    },

    handleEat(noun) {
        const itemIndex = this.gameState.inventory.findIndex(i => i.name.toLowerCase().includes(noun));
        if (itemIndex > -1) {
            const item = this.gameState.inventory[itemIndex];
            if (item.id === 'cake') {
                this.gameState.inventory.splice(itemIndex, 1);
                this.renderOutput("You eat the squashed birthday cake. It's the best you've ever had.", 'success');
            } else if (item.id === 'chocolate_frog') {
                this.gameState.inventory.splice(itemIndex, 1);
                const card = { id: 'dumbledore_card', name: 'a Dumbledore card', description: "It's a Famous Wizard Card for Albus Dumbledore. There is some text on the back." };
                this.gameState.inventory.push(card);
                this.renderOutput("You eat the delicious chocolate frog. It hops once and is gone! You are left with a Famous Wizard Card.", 'success');
            }
            else { this.renderOutput("You can't eat that.", 'error'); }
            this.renderInventory();
        } else { this.renderOutput("You don't have that to eat.", 'error'); }
    },

    handlePuzzle(puzzleData) {
        if (!puzzleData) {
            console.error("Attempted to handle a non-existent puzzle.");
            this.renderOutput("An error occurred with this puzzle. Please try another action.", "error");
            return;
        }
        this.activePuzzle = puzzleData;
        const puzzle = puzzleData[this.gameState.difficulty];
        if (!puzzle.question) {
            this.checkAnswer({}, true);
            return;
        }
        let puzzleHTML = `<div class="puzzle-container my-4 p-4 border border-dashed border-yellow-600/50 rounded-lg">
            <p class="mb-2">${this.makeWordsClickable(puzzle.question)}</p>
            <div class="grid grid-cols-2 gap-2 mt-4">`;
        puzzle.options.forEach(option => {
            puzzleHTML += `<button class="btn btn-gold" onclick="TextAdventure.checkAnswer(this)">${option}</button>`;
        });
        puzzleHTML += `</div></div>`;
        this.renderOutput(puzzleHTML, 'raw');
    },

    checkAnswer(button, manualSuccess = false) {
        let puzzleData = this.activePuzzle;
        if (!puzzleData) {
             if (manualSuccess && this.gameState.currentRoom === 'greatHall' && !this.gameState.flags.sorted) {
                 puzzleData = this.puzzles.greatHallSorting;
             } else if (manualSuccess) {
                 puzzleData = this.puzzles.fatLadyPassword;
             } else {
                 return;
             }
        }

        const selectedAnswer = button.textContent ? button.textContent.trim() : '';
        const puzzle = puzzleData[this.gameState.difficulty];

        if (document.querySelector('.puzzle-container')) {
             document.querySelectorAll('.puzzle-container button').forEach(b => b.disabled = true);
        }

        if (manualSuccess || selectedAnswer === puzzle.correctAnswer) {
            this.app.playSound(this.app.SOUNDS.correct_answer);
            this.renderOutput(`Correct!`, 'success');

            const ruleContainer = document.getElementById('rule-explanation-container');
            if (puzzle.explanation) {
                const encodedExplanation = btoa(encodeURIComponent(puzzle.explanation));
                ruleContainer.innerHTML = `<button class="btn btn-gold text-sm" style="background-color: #4a5568;" onclick="TextAdventure.showRuleExplanation('${encodedExplanation}')">Show Rule</button>`;
            }

            const reward = puzzleData.reward;
            const successMsg = typeof reward.successMessage === 'function'
                ? reward.successMessage(this.gameState.flags)
                : reward.successMessage;

            this.renderOutput(successMsg, 'event');

            setTimeout(() => {
                if (reward.type === 'move_to') {
                    this.gameState.previousRoom = this.gameState.currentRoom;
                    this.gameState.currentRoom = reward.room;
                    this.renderRoom();
                } else if (reward.type === 'flag_set') {
                    this.gameState.flags[reward.flag] = true;
                    if (reward.flag === 'has_wand') {
                        this.gameState.inventory.push({ id: 'wand', name: 'your new wand', description: "Eleven inches, holly, with a phoenix feather core. It feels warm in your hand." });
                        this.renderInventory();
                    }
                    if (reward.flag === 'sorted') {
                        this.gameState.flags.password = 'Caput Draconis';
                    }
                    this.renderRoom(true);
                    if (['knows_leviosa', 'potions_quiz_passed', 'knows_flying'].includes(reward.flag)) {
                        this.checkChristmasStatus();
                    }
                } else if (reward.type === 'trigger_puzzle') {
                    this.handlePuzzle(this.puzzles[reward.puzzle]);
                }
            }, 1500);

        } else {
            this.app.playSound(this.app.SOUNDS.incorrect_answer);
            this.renderOutput(puzzleData.failureMessage, 'error');
        }
        this.activePuzzle = null;
    },

    showRuleExplanation(encodedExplanation) {
        if (this.app && this.app.openModal) {
            const explanation = decodeURIComponent(atob(encodedExplanation));
            const contentHTML = `<div class="text-lg leading-relaxed">${this.makeWordsClickable(explanation)}</div>`;
            this.app.openModal('Grammar Rule', contentHTML, null);
        }
        document.getElementById('rule-explanation-container').innerHTML = '';
    },

    renderRoom(force_rerender = false) {
        const room = this.worldData[this.gameState.currentRoom];
        if (!room) {
            console.error("FATAL: Tried to render a room that doesn't exist:", this.gameState.currentRoom);
            this.renderOutput("A strange magic has blocked your path. You feel disoriented and find yourself back where you started.", "error");
            this.gameState.currentRoom = this.gameState.previousRoom || 'cupboardUnderStairs';
            this.renderRoom(true);
            return;
        }

        let descriptionToRender = room.description;
        if (room.description_after_flags) {
            for (const flag_cond of room.description_after_flags) {
                if (this.gameState.flags[flag_cond.flag]) {
                    descriptionToRender = flag_cond.text;
                    break;
                }
            }
        } else if (room.description_after_flag && this.gameState.flags[room.description_after_flag.flag]) {
            descriptionToRender = room.description_after_flag.text;
        }


        let html = `<div>${this.makeWordsClickable(descriptionToRender)}</div>`;
        if (room.items && room.items.length > 0) {
            html += `<div class="mt-2">You see: ${this.makeWordsClickable(room.items.map(i => i.name).join(', '))}.</div>`;
        }
        this.renderOutput(html, 'raw');
    },

    renderInventory(isCommand = false) {
        // [UI ENHANCEMENT] Beautiful emoji inventory display.
        const inventoryDiv = document.getElementById('inventory-display');
        if (!inventoryDiv) return;

        if (this.gameState.inventory.length === 0) {
            inventoryDiv.innerHTML = `<p class="text-center text-gray-500 italic p-4">Inventory is empty.</p>`;
            if (isCommand) this.renderOutput("Your inventory is empty.", 'info');
        } else {
            const itemsHTML = this.gameState.inventory.map(item => {
                const emoji = this.itemEmojis[item.id] || '‚ùì';
                return `
                    <div class="flex items-center justify-center bg-[#2A3B4D] p-2 rounded-lg text-2xl cursor-pointer hover:bg-[#3D5568] transition-colors" 
                         onclick="TextAdventure.handleExamine('${item.id.toLowerCase()}')"
                         title="${item.name}">
                        ${emoji}
                    </div>
                `;
            }).join('');
            inventoryDiv.innerHTML = `<div class="grid grid-cols-8 gap-2 p-2">${itemsHTML}</div>`;
            if (isCommand) {
                const itemsText = this.gameState.inventory.map(item => item.name.replace(/a |an |a set of |a pile of |a piece of /,'')).join(', ');
                this.renderOutput(`You are carrying: ${itemsText}.`, 'info');
            }
        }
    },

    renderHelp() {
        this.renderOutput(`
            <div><p class="font-bold" style="font-family: 'MedievalSharp', cursive; font-size: 1.2rem;">Common Commands:</p>
            <ul><li><b>go [direction]</b> (or n, s, e, w, up, down, outside, inside)</li><li><b>look</b> or <b>look room</b></li>
            <li><b>examine [object]</b> or <b>x [object]</b></li><li><b>take [object]</b> or <b>get [object]</b></li>
            <li><b>inventory</b> or <b>i</b></li><li><b>open [door/etc]</b></li><li><b>use [item] on [target]</b></li>
            <li><b>cast [spell]</b></li><li><b>research [topic]</b> (in library)</li><li><b>talk to [person]</b></li><li><b>hint</b> (if you are stuck)</li></ul>
            </div>`, 'raw');
    },

    renderOutput(text, type) {
        const outputDiv = document.getElementById('ta-output');
        const entry = document.createElement('div');

        switch (type) {
            case 'command': entry.className = 'ta-command'; entry.textContent = text; break;
            case 'error': entry.className = 'ta-error'; entry.innerHTML = this.makeWordsClickable(text); break;
            case 'success': entry.className = 'ta-success'; entry.innerHTML = this.makeWordsClickable(text); break;
            case 'info': entry.className = 'ta-info'; entry.innerHTML = this.makeWordsClickable(text); break;
            case 'event': entry.className = 'ta-event'; entry.innerHTML = this.makeWordsClickable(text); break;
            case 'raw': entry.innerHTML = text; break;
            default: entry.innerHTML = this.makeWordsClickable(text);
        }

        outputDiv.appendChild(entry);
        outputDiv.scrollTo({ top: outputDiv.scrollHeight, behavior: 'smooth' });
    },

    makeWordsClickable(text) {
        if(!text) return '';
        // Improved regex to better handle punctuation and avoid adding click handlers to HTML tags
        return text.replace(/(\b[a-zA-Z-']+\b)/g, (word) => {
            const cleanWord = word.toLowerCase();
            const escapedWord = cleanWord.replace(/'/g, "\\'");
            return `<span class="learn-word" onclick="Dictionary.showDefinitionPopup('${escapedWord}')">${word}</span>`;
        });
    }
};

    window.TextAdventure = TextAdventure;
    </script>
</body>
</html>